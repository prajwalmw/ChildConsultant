<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Child Dashboard - Aqiraa</title>
  <link href="../css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/child-friendly.css">
  <link href="../css/font-awesome.min.css" rel="stylesheet">

  <style>
    body {
      padding: 0;
      margin: 0;
      min-height: 100vh;
      background-color: #f5f7fa;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    .dashboard-header {
      text-align: center;
      margin-bottom: 30px;
    }
    .dashboard-header h1 {
      color: #2c3e50;
      margin-bottom: 10px;
    }
    .child-info {
      background: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    .child-info h3 {
      color: #00c3c9;
      margin-bottom: 15px;
    }
    .info-item {
      display: inline-block;
      margin-right: 30px;
      margin-bottom: 10px;
    }
    .info-item strong {
      color: #555;
    }
    .chart-section {
      background: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    .chart-section h3 {
      color: #2c3e50;
      margin-bottom: 20px;
    }
    canvas {
      max-height: 400px;
    }
    .back-button {
      background-color: #f7a83d;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      margin-bottom: 25px;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .back-button:hover {
      background-color: #e09734;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      transform: translateY(-1px);
    }
    .back-button i {
      margin-right: 8px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    .stat-card.green {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    }
    .stat-card.blue {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    }
    .stat-card.orange {
      background: linear-gradient(135deg, #f7a83d 0%, #e09734 100%);
    }
    .stat-card.red {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }
    .stat-card.yellow {
      background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
    }
    .stat-card.teal {
      background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
    }
    .stat-card h4 {
      margin: 0 0 10px 0;
      font-size: 14px;
      opacity: 0.9;
    }
    .stat-card .stat-value {
      font-size: 28px;
      font-weight: bold;
      margin: 0;
    }
    .stat-card .stat-label {
      font-size: 12px;
      margin-top: 5px;
      opacity: 0.95;
      font-weight: 500;
    }
    .bmi-card-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      padding: 30px;
      margin: 30px 0;
      border: 2px solid #e0e0e0;
    }
    .bmi-card-content {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 30px;
      align-items: center;
    }
    .bmi-score-section {
      text-align: center;
      padding: 20px;
      border-radius: 12px;
      color: white;
    }
    .bmi-score-section h3 {
      margin: 0 0 15px 0;
      font-size: 18px;
      opacity: 0.95;
      font-weight: 600;
    }
    .bmi-score-value {
      font-size: 56px;
      font-weight: bold;
      margin: 15px 0;
      line-height: 1;
    }
    .bmi-category {
      font-size: 20px;
      font-weight: 600;
      margin: 15px 0 10px 0;
    }
    .bmi-percentile {
      font-size: 16px;
      opacity: 0.95;
    }
    .bmi-legend-section {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
    }
    .bmi-legend-section h4 {
      margin: 0 0 20px 0;
      font-size: 16px;
      color: #2c3e50;
      font-weight: 600;
    }
    .bmi-legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      padding: 10px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .bmi-legend-color {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      margin-right: 15px;
      flex-shrink: 0;
    }
    .bmi-legend-text {
      font-size: 14px;
      color: #2c3e50;
      font-weight: 500;
    }
    .bmi-legend-range {
      font-size: 12px;
      color: #7f8c8d;
      margin-top: 2px;
    }
    .hydration-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      padding: 30px;
      margin: 30px 0;
      border: 2px solid #e0e0e0;
    }
    .hydration-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .hydration-card h3 {
      color: #2c3e50;
      margin: 0;
      font-size: 22px;
      font-weight: 600;
    }
    .hydration-toggle {
      display: flex;
      gap: 0;
      background: #ecf0f1;
      border-radius: 8px;
      padding: 4px;
    }
    .hydration-toggle-btn {
      padding: 8px 20px;
      border: none;
      background: transparent;
      color: #7f8c8d;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.3s;
    }
    .hydration-toggle-btn:hover {
      color: #2c3e50;
    }
    .hydration-toggle-btn.active {
      background: white;
      color: #3498db;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .hydration-view {
      display: none;
    }
    .hydration-view.active {
      display: block;
    }
    .hydration-card .subtitle {
      color: #7f8c8d;
      font-size: 14px;
      margin-bottom: 25px;
    }
    .bullet-chart-container {
      margin: 20px 0;
    }
    .bullet-chart {
      position: relative;
      height: 60px;
      margin-bottom: 15px;
    }
    .bullet-ranges {
      position: absolute;
      height: 100%;
      width: 100%;
      display: flex;
    }
    .bullet-range {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 12px;
      transition: all 0.3s;
    }
    .bullet-range.poor {
      background: linear-gradient(to right, #e74c3c, #ec7063);
    }
    .bullet-range.below {
      background: linear-gradient(to right, #f39c12, #f5b041);
    }
    .bullet-range.good {
      background: linear-gradient(to right, #27ae60, #52be80);
    }
    .bullet-range.excellent {
      background: linear-gradient(to right, #3498db, #5dade2);
    }
    .bullet-measure {
      position: absolute;
      height: 70%;
      top: 15%;
      background: #2c3e50;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .bullet-marker {
      position: absolute;
      height: 100%;
      width: 3px;
      background: #e74c3c;
      top: 0;
    }
    .bullet-marker::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 12px;
      height: 12px;
      background: #e74c3c;
      border: 2px solid white;
      border-radius: 50%;
    }
    .hydration-values {
      display: flex;
      justify-content: space-between;
      margin-top: 25px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
    }
    .hydration-value-item {
      text-align: center;
      flex: 1;
    }
    .hydration-value-label {
      font-size: 13px;
      color: #7f8c8d;
      margin-bottom: 5px;
      font-weight: 500;
    }
    .hydration-value-number {
      font-size: 24px;
      font-weight: bold;
      color: #2c3e50;
    }
    .hydration-value-unit {
      font-size: 14px;
      color: #95a5a6;
    }
    .hydration-legend {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
      padding: 15px;
      background: #ecf0f1;
      border-radius: 8px;
    }
    .hydration-legend-item {
      display: flex;
      align-items: center;
      font-size: 12px;
      color: #2c3e50;
    }
    .hydration-legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      margin-right: 8px;
    }
  </style>
</head>

<body>
  <div class="container">
      <button class="back-button" onclick="goBack()">
        <i class="fa fa-arrow-left"></i> Back to Child Selection
      </button>

      <div class="dashboard-header">
        <h1 id="childNameHeader">Child Dashboard</h1>
        <p id="parentNameHeader" style="color: #7f8c8d;"></p>
      </div>

      <!-- WHO Standards Disclaimer -->
      <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; color: #0d47a1; padding: 20px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);">
        <div style="display: flex; align-items: center; gap: 15px;">
          <div style="font-size: 40px; color: #1976d2;">
            <i class="fa fa-certificate"></i>
          </div>
          <div style="flex: 1;">
            <h3 style="margin: 0 0 10px 0; color: #0d47a1; font-size: 19px; font-weight: bold;">
              <i class="fa fa-check-circle" style="color: #4caf50;"></i> WHO Growth Standards Certified
            </h3>
            <p style="margin: 0; font-size: 14px; line-height: 1.7; color: #1565c0;">
              This dashboard follows the official <strong>World Health Organization (WHO) Child Growth Standards</strong> for calculating growth percentiles. All measurements and assessments are based on internationally recognized health standards using the <strong>LMS (Lambda-Mu-Sigma)</strong> method for accurate percentile calculations. These standards are used globally by healthcare professionals to monitor child development.
            </p>
          </div>
        </div>
      </div>

      <div class="child-info" id="childInfoSection" style="display: none;">
        <h3>Child Information</h3>
        <div id="childInfoContent">
          <p>Loading child information...</p>
        </div>
      </div>

      <div id="loadingIndicator" style="text-align: center; padding: 60px;">
        <div style="font-size: 24px; color: #00c3c9; margin-bottom: 20px;">
          <i class="fa fa-spinner fa-spin"></i> Loading Dashboard...
        </div>
        <p style="color: #7f8c8d;">Please wait while we fetch the data</p>
      </div>

      <div class="stats-grid" id="statsGrid" style="display: none;">
        <!-- Stats will be populated by JavaScript -->
      </div>

      <!-- BMI Chart with Toggle -->
      <div class="hydration-card" id="bmiCard" style="display: none;">
        <div class="hydration-card-header">
          <h3>ðŸ“Š BMI (Body Mass Index)</h3>
          <div class="hydration-toggle">
            <button class="hydration-toggle-btn active" onclick="switchBMIView('current')">Current</button>
            <button class="hydration-toggle-btn" onclick="switchBMIView('overview')">Overview</button>
          </div>
        </div>
        <p class="subtitle">BMI tracking compared to <strong>WHO BMI-for-Age</strong> standards (2-19 years)</p>

        <!-- Current View -->
        <div class="hydration-view active" id="bmiCurrentView">
          <div class="bmi-card-content">
            <!-- BMI Score Section (Left) -->
            <div id="bmiScoreSection">
              <!-- Will be populated by JavaScript -->
            </div>

            <!-- Color Legend Section (Right) -->
            <div class="bmi-legend-section">
              <h4>WHO BMI-for-Age Categories (2-19 years)</h4>

              <div class="bmi-legend-item">
                <div class="bmi-legend-color" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);"></div>
                <div>
                  <div class="bmi-legend-text">Severely Underweight</div>
                  <div class="bmi-legend-range">&lt;3rd percentile</div>
                </div>
              </div>

              <div class="bmi-legend-item">
                <div class="bmi-legend-color" style="background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);"></div>
                <div>
                  <div class="bmi-legend-text">Underweight</div>
                  <div class="bmi-legend-range">3rd-15th percentile</div>
                </div>
              </div>

              <div class="bmi-legend-item">
                <div class="bmi-legend-color" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);"></div>
                <div>
                  <div class="bmi-legend-text">Healthy Weight</div>
                  <div class="bmi-legend-range">15th-85th percentile</div>
                </div>
              </div>

              <div class="bmi-legend-item">
                <div class="bmi-legend-color" style="background: linear-gradient(135deg, #f7a83d 0%, #e09734 100%);"></div>
                <div>
                  <div class="bmi-legend-text">Overweight</div>
                  <div class="bmi-legend-range">85th-97th percentile</div>
                </div>
              </div>

              <div class="bmi-legend-item">
                <div class="bmi-legend-color" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);"></div>
                <div>
                  <div class="bmi-legend-text">Obese</div>
                  <div class="bmi-legend-range">&gt;97th percentile</div>
                </div>
              </div>
            </div>
          </div>
          <p style="text-align: center; color: #7f8c8d; font-size: 13px; margin-top: 15px; font-style: italic;">
            ðŸ“… This reading is from the latest consultation
          </p>
        </div>

        <!-- Overview View -->
        <div class="hydration-view" id="bmiOverviewView">
          <div style="margin: 20px 0;">
            <canvas id="bmiOverviewChart" style="max-height: 400px;"></canvas>
          </div>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
            <strong>How to Read:</strong> Blue line shows child's actual BMI across all consultations. Colored horizontal bands show WHO BMI-for-Age percentile categories (green = healthy weight range).
          </div>
          <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin-top: 15px;">
            <strong>ðŸ“‹ Clinical Standards:</strong> BMI categories are based on World Health Organization (WHO) BMI-for-Age percentiles for children and adolescents aged 2-19 years. These percentiles account for age and gender differences in body composition during growth and development.
          </div>
        </div>
      </div>

      <!-- Hydration Chart with Toggle -->
      <div class="hydration-card" id="hydrationCard" style="display: none;">
        <div class="hydration-card-header">
          <h3>ðŸ’§ Hydration Status (Intake vs WHO Standard)</h3>
          <div class="hydration-toggle">
            <button class="hydration-toggle-btn active" onclick="switchHydrationView('current')">Current</button>
            <button class="hydration-toggle-btn" onclick="switchHydrationView('overview')">Overview</button>
          </div>
        </div>
        <p class="subtitle">Daily water intake compared to WHO recommended levels based on age and weight</p>

        <!-- Current View (Bullet Chart) -->
        <div class="hydration-view active" id="hydrationCurrentView">
          <div class="bullet-chart-container">
            <div class="bullet-chart" id="bulletChart">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>

          <div class="hydration-values" id="hydrationValues">
            <!-- Will be populated by JavaScript -->
          </div>

          <div class="hydration-legend">
            <div class="hydration-legend-item">
              <div class="hydration-legend-color" style="background: linear-gradient(to right, #e74c3c, #ec7063);"></div>
              <span>Poor (&lt;60%)</span>
            </div>
            <div class="hydration-legend-item">
              <div class="hydration-legend-color" style="background: linear-gradient(to right, #f39c12, #f5b041);"></div>
              <span>Below Target (60-85%)</span>
            </div>
            <div class="hydration-legend-item">
              <div class="hydration-legend-color" style="background: linear-gradient(to right, #27ae60, #52be80);"></div>
              <span>Good (85-115%)</span>
            </div>
            <div class="hydration-legend-item">
              <div class="hydration-legend-color" style="background: linear-gradient(to right, #3498db, #5dade2);"></div>
              <span>Excellent (&gt;115%)</span>
            </div>
          </div>
        </div>

        <!-- Overview View (Line Chart) -->
        <div class="hydration-view" id="hydrationOverviewView">
          <div style="margin: 20px 0;">
            <canvas id="hydrationOverviewChart" style="max-height: 400px;"></canvas>
          </div>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
            <strong>How to Read:</strong> Blue line shows child's actual water intake across all consultations. Red line shows WHO recommended intake based on age and weight at each visit. Green shaded area (85-115%) indicates healthy hydration range.
          </div>
        </div>
      </div>

      <!-- Sleep Duration & Routine Chart -->
      <div class="hydration-card" id="sleepCard" style="display: none;">
        <div class="hydration-card-header">
          <h3>ðŸ˜´ Sleep Duration & Bedtime Routine</h3>
          <div class="hydration-toggle">
            <button class="hydration-toggle-btn active" onclick="switchSleepView('current')">Current</button>
            <button class="hydration-toggle-btn" onclick="switchSleepView('overview')">Overview</button>
          </div>
        </div>
        <p class="subtitle">Sleep duration and routine consistency compared to <strong>AASM (American Academy of Sleep Medicine)</strong> guidelines</p>

        <!-- Current View (Gauge Chart) -->
        <div class="hydration-view active" id="sleepCurrentView">
          <div class="bullet-chart-container">
            <div class="bullet-chart" id="sleepBulletChart">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>

          <div class="hydration-values" id="sleepValues">
            <!-- Will be populated by JavaScript -->
          </div>

          <div class="hydration-legend">
            <div class="hydration-legend-item">
              <div class="hydration-legend-color" style="background: linear-gradient(to right, #e74c3c, #ec7063);"></div>
              <span>Insufficient (&lt;80% of recommended)</span>
            </div>
            <div class="hydration-legend-item">
              <div class="hydration-legend-color" style="background: linear-gradient(to right, #f39c12, #f5b041);"></div>
              <span>Below Ideal (80-90%)</span>
            </div>
            <div class="hydration-legend-item">
              <div class="hydration-legend-color" style="background: linear-gradient(to right, #27ae60, #52be80);"></div>
              <span>Optimal (Within Recommended Range)</span>
            </div>
            <div class="hydration-legend-item">
              <div class="hydration-legend-color" style="background: linear-gradient(to right, #3498db, #5dade2);"></div>
              <span>Excessive (&gt;120% of recommended)</span>
            </div>
          </div>

          <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin-top: 20px;">
            <strong>ðŸ“‹ Clinical Standards - AASM (American Academy of Sleep Medicine) Guidelines:</strong><br>
            <div style="margin-top: 10px; font-size: 13px; color: #856404;">
              â€¢ <strong>Ages 4-12 months:</strong> 12-16 hours (including naps)<br>
              â€¢ <strong>Ages 1-2 years:</strong> 11-14 hours (including naps)<br>
              â€¢ <strong>Ages 3-5 years:</strong> 10-13 hours (may include naps)<br>
              â€¢ <strong>Ages 6-12 years:</strong> 9-12 hours<br>
              â€¢ <strong>Ages 13-18 years:</strong> 8-10 hours<br>
              <em>Source: American Academy of Sleep Medicine & National Sleep Foundation</em>
            </div>
          </div>
        </div>

        <!-- Overview View (Line Chart) -->
        <div class="hydration-view" id="sleepOverviewView">
          <div style="margin: 20px 0;">
            <canvas id="sleepOverviewChart" style="max-height: 400px;"></canvas>
          </div>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
            <strong>How to Read:</strong> Blue line shows child's actual sleep duration across all consultations. Green shaded band shows AASM recommended sleep range based on age. Orange markers show bedtime consistency (earlier/later shifts indicate routine changes).
          </div>
          <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin-top: 15px;">
            <strong>ðŸ“‹ Legal Disclaimer:</strong> Sleep recommendations are based on American Academy of Sleep Medicine (AASM) clinical guidelines and National Sleep Foundation standards. These are evidence-based recommendations for healthy child development. Individual sleep needs may vary. Consult with healthcare provider for personalized assessment.
          </div>
        </div>
      </div>

      <div class="chart-section" id="growthChartSection" style="display: none;">
        <h3>Child Growth Percentiles vs WHO Standards</h3>
        <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 20px;">
          <strong>How to Read:</strong> Horizontal reference lines show WHO standard percentiles (3rd, 15th, 50th, 85th, 97th). The <strong style="color: #c0392b;">colored dots with percentile values</strong> show where your child's measurements fall on the WHO scale.
          <br>
          <strong>Clinical Interpretation:</strong> Normal = child tracking between 3rd-97th percentile lines. The 50th percentile (bold teal line) represents the median/average. Values staying between the outer lines indicate healthy growth.
          <br>
          <strong>Legend:</strong> Red = Weight Percentile, Blue = Height Percentile, Teal = Head Circumference Percentile
        </p>
        <canvas id="growthChart"></canvas>
      </div>

    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // Import WHO standards module
    import {
      calculateWeightPercentile,
      calculateHeightPercentile,
      calculateHeadCircumferencePercentile,
      calculateAgeInMonths
    } from "../js/who-standards.js";

    // WHO LMS data tables for reference curves
    const WHO_WEIGHT_AGE_BOYS = [
      { month: 0, L: 0.3487, M: 3.3464, S: 0.14602 },
      { month: 1, L: 0.2297, M: 4.4709, S: 0.13395 },
      { month: 2, L: 0.1970, M: 5.5675, S: 0.12385 },
      { month: 3, L: 0.1738, M: 6.3762, S: 0.11727 },
      { month: 4, L: 0.1553, M: 7.0023, S: 0.11316 },
      { month: 5, L: 0.1395, M: 7.5105, S: 0.11080 },
      { month: 6, L: 0.1257, M: 7.9340, S: 0.10958 },
      { month: 7, L: 0.1134, M: 8.2970, S: 0.10902 },
      { month: 8, L: 0.1021, M: 8.6151, S: 0.10882 },
      { month: 9, L: 0.0917, M: 8.9014, S: 0.10881 },
      { month: 10, L: 0.0820, M: 9.1649, S: 0.10891 },
      { month: 11, L: 0.0730, M: 9.4122, S: 0.10906 },
      { month: 12, L: 0.0644, M: 9.6479, S: 0.10925 },
      { month: 15, L: 0.0425, M: 10.3009, S: 0.10986 },
      { month: 18, L: 0.0220, M: 10.8632, S: 0.11066 },
      { month: 21, L: 0.0031, M: 11.3499, S: 0.11158 },
      { month: 24, L: -0.0146, M: 11.7796, S: 0.11256 },
      { month: 27, L: -0.0311, M: 12.1679, S: 0.11358 },
      { month: 30, L: -0.0464, M: 12.5244, S: 0.11461 },
      { month: 33, L: -0.0608, M: 12.8561, S: 0.11567 },
      { month: 36, L: -0.0743, M: 13.1681, S: 0.11673 },
      { month: 42, L: -0.0993, M: 13.7434, S: 0.11889 },
      { month: 48, L: -0.1211, M: 14.2793, S: 0.12103 },
      { month: 54, L: -0.1402, M: 14.7836, S: 0.12314 },
      { month: 60, L: -0.1570, M: 15.2632, S: 0.12521 },
      { month: 66, L: -0.1719, M: 15.7290, S: 0.12730 },
      { month: 72, L: -0.1854, M: 16.1879, S: 0.12939 },
      { month:78, L: -0.1978, M: 16.6427, S: 0.13150 },
      { month: 84, L: -0.2091, M: 17.0954, S: 0.13362 },
      { month: 90, L: -0.2194, M: 17.5475, S: 0.13575 },
      { month: 96, L: -0.2288, M: 18.0000, S: 0.13788 },
      { month: 102, L: -0.2375, M: 18.4537, S: 0.14001 },
      { month: 108, L: -0.2454, M: 18.9092, S: 0.14213 },
      { month: 114, L: -0.2527, M: 19.3671, S: 0.14424 },
      { month: 120, L: -0.2594, M: 19.8278, S: 0.14633 }
    ];

    const WHO_WEIGHT_AGE_GIRLS = [
      { month: 0, L: 0.3809, M: 3.2322, S: 0.14171 },
      { month: 1, L: 0.1714, M: 4.1873, S: 0.13724 },
      { month: 2, L: 0.0962, M: 5.1282, S: 0.13000 },
      { month: 3, L: 0.0402, M: 5.8458, S: 0.12619 },
      { month: 4, L: -0.0050, M: 6.4237, S: 0.12402 },
      { month: 5, L: -0.0430, M: 6.8985, S: 0.12274 },
      { month: 6, L: -0.0756, M: 7.2970, S: 0.12204 },
      { month: 7, L: -0.1039, M: 7.6422, S: 0.12178 },
      { month: 8, L: -0.1288, M: 7.9487, S: 0.12181 },
      { month: 9, L: -0.1507, M: 8.2254, S: 0.12199 },
      { month: 10, L: -0.1700, M: 8.4800, S: 0.12223 },
      { month: 11, L: -0.1872, M: 8.7192, S: 0.12247 },
      { month: 12, L: -0.2024, M: 8.9481, S: 0.12268 },
      { month: 15, L: -0.2379, M: 9.5900, S: 0.12309 },
      { month: 18, L: -0.2680, M: 10.1452, S: 0.12339 },
      { month: 21, L: -0.2936, M: 10.6331, S: 0.12363 },
      { month: 24, L: -0.3154, M: 11.0686, S: 0.12384 },
      { month: 27, L: -0.3340, M: 11.4631, S: 0.12403 },
      { month: 30, L: -0.3499, M: 11.8251, S: 0.12421 },
      { month: 33, L: -0.3634, M: 12.1615, S: 0.12439 },
      { month: 36, L: -0.3749, M: 12.4775, S: 0.12456 },
      { month: 42, L: -0.3943, M: 13.0719, S: 0.12494 },
      { month: 48, L: -0.4098, M: 13.6357, S: 0.12533 },
      { month: 54, L: -0.4225, M: 14.1746, S: 0.12574 },
      { month: 60, L: -0.4330, M: 14.6936, S: 0.12618 },
      { month: 66, L: -0.4419, M: 15.1989, S: 0.12664 },
      { month: 72, L: -0.4495, M: 15.6936, S: 0.12711 },
      { month: 78, L: -0.4559, M: 16.1799, S: 0.12759 },
      { month: 84, L: -0.4612, M: 16.6594, S: 0.12807 },
      { month: 90, L: -0.4656, M: 17.1334, S: 0.12856 },
      { month: 96, L: -0.4692, M: 17.6030, S: 0.12905 },
      { month: 102, L: -0.4720, M: 18.0691, S: 0.12955 },
      { month: 108, L: -0.4742, M: 18.5326, S: 0.13004 },
      { month: 114, L: -0.4758, M: 18.9942, S: 0.13053 },
      { month: 120, L: -0.4770, M: 19.4544, S: 0.13101 }
    ];

    const WHO_HEIGHT_AGE_BOYS = [
      { month: 0, L: 1, M: 49.8842, S: 0.03795 },
      { month: 1, L: 1, M: 54.7244, S: 0.03557 },
      { month: 2, L: 1, M: 58.4249, S: 0.03424 },
      { month: 3, L: 1, M: 61.4292, S: 0.03328 },
      { month: 4, L: 1, M: 63.8859, S: 0.03257 },
      { month: 5, L: 1, M: 65.9026, S: 0.03204 },
      { month: 6, L: 1, M: 67.6236, S: 0.03165 },
      { month: 7, L: 1, M: 69.1645, S: 0.03139 },
      { month: 8, L: 1, M: 70.5994, S: 0.03124 },
      { month: 9, L: 1, M: 71.9687, S: 0.03117 },
      { month: 10, L: 1, M: 73.2812, S: 0.03118 },
      { month: 11, L: 1, M: 74.5388, S: 0.03125 },
      { month: 12, L: 1, M: 75.7488, S: 0.03137 },
      { month: 15, L: 1, M: 78.7252, S: 0.03181 },
      { month: 18, L: 1, M: 81.3904, S: 0.03236 },
      { month: 21, L: 1, M: 83.7827, S: 0.03297 },
      { month: 24, L: 1, M: 85.9488, S: 0.03360 },
      { month: 27, L: 1, M: 87.9186, S: 0.03424 },
      { month: 30, L: 1, M: 89.7154, S: 0.03487 },
      { month: 33, L: 1, M: 91.3576, S: 0.03549 },
      { month: 36, L: 1, M: 92.8606, S: 0.03609 },
      { month: 42, L: 1, M: 95.6264, S: 0.03722 },
      { month: 48, L: 1, M: 98.1251, S: 0.03827 },
      { month: 54, L: 1, M: 100.3931, S: 0.03925 },
      { month: 60, L: 1, M: 102.4604, S: 0.04018 },
      { month: 66, L: 1, M: 104.3699, S: 0.04107 },
      { month: 72, L: 1, M: 106.1472, S: 0.04193 },
      { month: 78, L: 1, M: 107.8126, S: 0.04276 },
      { month: 84, L: 1, M: 109.3833, S: 0.04357 },
      { month: 90, L: 1, M: 110.8736, S: 0.04436 },
      { month: 96, L: 1, M: 112.2952, S: 0.04514 },
      { month: 102, L: 1, M: 113.6575, S: 0.04590 },
      { month: 108, L: 1, M: 114.9686, S: 0.04665 },
      { month: 114, L: 1, M: 116.2354, S: 0.04738 },
      { month: 120, L: 1, M: 117.4638, S: 0.04810 }
    ];

    const WHO_HEIGHT_AGE_GIRLS = [
      { month: 0, L: 1, M: 49.1477, S: 0.03790 },
      { month: 1, L: 1, M: 53.6872, S: 0.03626 },
      { month: 2, L: 1, M: 57.0673, S: 0.03497 },
      { month: 3, L: 1, M: 59.8029, S: 0.03379 },
      { month: 4, L: 1, M: 62.0899, S: 0.03285 },
      { month: 5, L: 1, M: 64.0301, S: 0.03212 },
      { month: 6, L: 1, M: 65.7311, S: 0.03154 },
      { month: 7, L: 1, M: 67.2873, S: 0.03109 },
      { month: 8, L: 1, M: 68.7498, S: 0.03075 },
      { month: 9, L: 1, M: 70.1435, S: 0.03048 },
      { month: 10, L: 1, M: 71.4818, S: 0.03029 },
      { month: 11, L: 1, M: 72.7714, S: 0.03015 },
      { month: 12, L: 1, M: 74.0151, S: 0.03007 },
      { month: 15, L: 1, M: 76.9768, S: 0.03010 },
      { month: 18, L: 1, M: 79.6178, S: 0.03032 },
      { month: 21, L: 1, M: 81.9843, S: 0.03064 },
      { month: 24, L: 1, M: 84.1176, S: 0.03100 },
      { month: 27, L: 1, M: 86.0477, S: 0.03137 },
      { month: 30, L: 1, M: 87.7990, S: 0.03174 },
      { month: 33, L: 1, M: 89.3917, S: 0.03211 },
      { month: 36, L: 1, M: 90.8431, S: 0.03247 },
      { month: 42, L: 1, M: 93.5252, S: 0.03318 },
      { month: 48, L: 1, M: 95.9568, S: 0.03386 },
      { month: 54, L: 1, M: 98.1679, S: 0.03452 },
      { month: 60, L: 1, M: 100.1863, S: 0.03516 },
      { month: 66, L: 1, M: 102.0281, S: 0.03578 },
      { month: 72, L: 1, M: 103.7193, S: 0.03638 },
      { month: 78, L: 1, M: 105.2796, S: 0.03696 },
      { month: 84, L: 1, M: 106.7258, S: 0.03753 },
      { month: 90, L: 1, M: 108.0717, S: 0.03808 },
      { month: 96, L: 1, M: 109.3294, S: 0.03862 },
      { month: 102, L: 1, M: 110.5089, S: 0.03915 },
      { month: 108, L: 1, M: 111.6189, S: 0.03967 },
      { month: 114, L: 1, M: 112.6670, S: 0.04018 },
      { month: 120, L: 1, M: 113.6597, S: 0.04068 }
    ];

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCyLCI_GOl9SWDLo2zhjMthLQFZ5sA3ddM",
      authDomain: "child-consultant.firebaseapp.com",
      projectId: "child-consultant",
      storageBucket: "child-consultant.appspot.com",
      messagingSenderId: "985386588549",
      appId: "1:985386588549:web:311ecd89cc7f6aa141ccec"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentPatientId = null;
    let currentParentId = null;
    let childName = '';

    // Get query parameters
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    window.goBack = function() {
      window.location.href = `child_selection.html?parentId=${currentParentId}`;
    }

    // Helper function to create parent key
    function slugifyName(text) {
      return text.toLowerCase().trim()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-');
    }

    function createParentKey(parentName, parentId) {
      const nameSlug = slugifyName(parentName || 'unknown-parent');
      return `${nameSlug}_${parentId}`;
    }

    // Parse Firestore timestamp to Date object
    function parseDate(timestamp) {
      if (!timestamp) return null;
      if (timestamp.toDate) return timestamp.toDate();
      if (timestamp.seconds) return new Date(timestamp.seconds * 1000);
      return new Date(timestamp);
    }

    // WHO standards functions are now imported from who-standards.js module

    // Generate WHO reference percentile curve data
    function generateWHOCurve(dataTable, percentile) {
      const data = [];
      dataTable.forEach(point => {
        const { L, M, S } = point;
        let measurement;

        const zScores = { 3: -1.88, 15: -1.04, 50: 0, 85: 1.04, 97: 1.88 };
        const zScore = zScores[percentile];

        // Calculate measurement from z-score using inverse LMS
        if (L === 0) {
          measurement = M * Math.exp(S * zScore);
        } else {
          measurement = M * Math.pow(1 + L * S * zScore, 1 / L);
        }

        data.push({ x: point.month, y: measurement });
      });

      return data;
    }

    // Draw Weight-for-Age Chart
    function drawWeightForAgeChart(consultations, childData) {
      if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        return;
      }

      console.log('Drawing Weight-for-Age Chart');
      console.log('Consultations:', consultations);
      console.log('Child Data:', childData);

      const datasets = [];
      const percentiles = [3, 15, 50, 85, 97];
      const referenceColors = {
        3: 'rgba(255, 99, 132, 0.15)',
        15: 'rgba(255, 159, 64, 0.15)',
        50: 'rgba(75, 192, 192, 0.3)',
        85: 'rgba(54, 162, 235, 0.15)',
        97: 'rgba(153, 102, 255, 0.15)'
      };
      const referenceBorders = {
        3: 'rgba(255, 99, 132, 0.9)',
        15: 'rgba(255, 159, 64, 0.9)',
        50: 'rgba(75, 192, 192, 1)',
        85: 'rgba(54, 162, 235, 0.9)',
        97: 'rgba(153, 102, 255, 0.9)'
      };

      // Add WHO reference curves based on child's gender
      const weightTable = childData.gender === 'Male' ? WHO_WEIGHT_AGE_BOYS : WHO_WEIGHT_AGE_GIRLS;
      percentiles.forEach(p => {
        const curve = generateWHOCurve(weightTable, p);
        datasets.push({
          label: `WHO ${p}th percentile`,
          data: curve,
          borderColor: referenceBorders[p],
          backgroundColor: referenceColors[p],
          borderWidth: p === 50 ? 3 : 2,
          borderDash: p === 50 ? [] : [5, 5],
          fill: false,
          pointRadius: 0,
          tension: 0.4,
          datalabels: {
            display: false
          }
        });
      });

      // Add actual child weight data
      const weightData = consultations.map(consult => {
        const dobDate = parseDate(childData.dob || childData.dateOfBirth);
        const consultDate = parseDate(consult.date);
        const ageMonths = calculateAgeInMonths(dobDate, consultDate);
        console.log(`Weight data point: age=${ageMonths}, weight=${consult.weight}`);
        return { x: ageMonths, y: consult.weight };
      }).filter(d => d.y && d.y > 0);

      console.log('Filtered weight data:', weightData);

      if (weightData.length === 0) {
        console.warn('No valid weight data to display');
      }

      datasets.push({
        label: `${childData.name}'s Weight`,
        data: weightData,
        borderColor: 'rgba(255, 0, 0, 1)',
        backgroundColor: 'rgba(255, 0, 0, 1)',
        borderWidth: 4,
        pointRadius: 10,
        pointHoverRadius: 14,
        pointStyle: 'circle',
        pointBorderWidth: 3,
        pointBorderColor: 'rgba(255, 255, 255, 1)',
        tension: 0.3,
        showLine: true,
        datalabels: {
          display: true,
          align: (context) => {
            // Alternate between top and bottom for better spacing
            return context.dataIndex % 2 === 0 ? 'top' : 'bottom';
          },
          offset: 10,
          color: '#e74c3c',
          font: {
            weight: 'bold',
            size: 13
          },
          backgroundColor: 'rgba(255, 255, 255, 0.9)',
          borderRadius: 4,
          padding: 4,
          formatter: (value) => `${value.y.toFixed(1)} kg`
        }
      });

      const ctx = document.getElementById('weightForAgeChart').getContext('2d');

      // Calculate which percentile band the child is tracking
      let growthStatus = '';
      if (weightData.length > 0) {
        const latestWeight = weightData[weightData.length - 1];
        const latestAge = latestWeight.x;

        // Find corresponding WHO percentile values at this age
        const whoPoint = weightTable.find(p => Math.abs(p.month - latestAge) < 3) || weightTable[weightTable.length - 1];
        const p50Value = whoPoint.M; // 50th percentile value

        const weightRatio = latestWeight.y / p50Value;

        if (weightRatio >= 0.45 && weightRatio <= 0.55) {
          growthStatus = 'Tracking 50th Percentile - Excellent Growth!';
        } else if (weightRatio >= 0.40 && weightRatio <= 0.65) {
          growthStatus = 'Steady Growth - Within Normal Range';
        } else if (weightRatio < 0.40) {
          growthStatus = 'Below Average - Monitor Closely';
        } else {
          growthStatus = 'Above Average - Monitor Development';
        }
      }

      new Chart(ctx, {
        type: 'line',
        data: { datasets },
        plugins: [ChartDataLabels],
        options: {
          responsive: true,
          interaction: {
            mode: 'nearest',
            intersect: false,
            axis: 'x'
          },
          plugins: {
            datalabels: {
              display: false // Default off for all datasets unless specifically enabled
            },
            title: {
              display: true,
              text: ['Weight-for-Age Growth Chart (WHO Standards)', growthStatus],
              font: { size: 16, weight: 'bold' },
              color: growthStatus.includes('Excellent') || growthStatus.includes('Steady') ? '#27ae60' : '#e67e22'
            },
            tooltip: {
              enabled: true,
              mode: 'nearest',
              intersect: false,
              backgroundColor: 'rgba(0, 0, 0, 0.9)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: 'rgba(255, 255, 255, 0.3)',
              borderWidth: 1,
              padding: 12,
              displayColors: true,
              callbacks: {
                title: (items) => `Age: ${items[0].parsed.x.toFixed(1)} months`,
                label: (context) => `${context.dataset.label}: ${context.parsed.y.toFixed(2)} kg`
              }
            }
          },
          scales: {
            x: {
              type: 'linear',
              title: { display: true, text: 'Age (months)' },
              min: 0,
              max: 120,
              ticks: { stepSize: 12 }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Weight (kg)' },
              ticks: { callback: (value) => value + ' kg' }
            }
          }
        }
      });
    }

    // Draw Height-for-Age Chart
    function drawHeightForAgeChart(consultations, childData) {
      if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        return;
      }

      console.log('Drawing Height-for-Age Chart');
      console.log('Consultations:', consultations);
      console.log('Child Data:', childData);

      const datasets = [];
      const percentiles = [3, 15, 50, 85, 97];
      const referenceColors = {
        3: 'rgba(255, 99, 132, 0.9)',
        15: 'rgba(255, 159, 64, 0.9)',
        50: 'rgba(75, 192, 192, 1)',
        85: 'rgba(54, 162, 235, 0.9)',
        97: 'rgba(153, 102, 255, 0.9)'
      };

      // Add WHO reference curves based on child's gender
      const heightTable = childData.gender === 'Male' ? WHO_HEIGHT_AGE_BOYS : WHO_HEIGHT_AGE_GIRLS;
      percentiles.forEach(p => {
        const curve = generateWHOCurve(heightTable, p);
        datasets.push({
          label: `WHO ${p}th percentile`,
          data: curve,
          borderColor: referenceColors[p],
          backgroundColor: 'transparent',
          borderWidth: p === 50 ? 3 : 2,
          borderDash: p === 50 ? [] : [5, 5],
          fill: false,
          pointRadius: 0,
          tension: 0.4,
          datalabels: {
            display: false
          }
        });
      });

      // Add actual child height data
      const heightData = consultations.map(consult => {
        const dobDate = parseDate(childData.dob || childData.dateOfBirth);
        const consultDate = parseDate(consult.date);
        const ageMonths = calculateAgeInMonths(dobDate, consultDate);
        console.log(`Height data point: age=${ageMonths}, height=${consult.height}`);
        return { x: ageMonths, y: consult.height };
      }).filter(d => d.y && d.y > 0);

      console.log('Filtered height data:', heightData);

      if (heightData.length === 0) {
        console.warn('No valid height data to display');
      }

      datasets.push({
        label: `${childData.name}'s Height`,
        data: heightData,
        borderColor: 'rgba(0, 0, 255, 1)',
        backgroundColor: 'rgba(0, 0, 255, 1)',
        borderWidth: 4,
        pointRadius: 10,
        pointHoverRadius: 14,
        pointStyle: 'circle',
        pointBorderWidth: 3,
        pointBorderColor: 'rgba(255, 255, 255, 1)',
        tension: 0.3,
        showLine: true,
        datalabels: {
          display: true,
          align: (context) => {
            // Alternate between bottom and top (opposite of weight chart for better separation)
            return context.dataIndex % 2 === 0 ? 'bottom' : 'top';
          },
          offset: 10,
          color: '#2980b9',
          font: {
            weight: 'bold',
            size: 13
          },
          backgroundColor: 'rgba(255, 255, 255, 0.9)',
          borderRadius: 4,
          padding: 4,
          formatter: (value) => `${value.y.toFixed(1)} cm`
        }
      });

      const ctx = document.getElementById('heightForAgeChart').getContext('2d');

      // Calculate which percentile band the child is tracking for height
      let heightGrowthStatus = '';
      if (heightData.length > 0) {
        const latestHeight = heightData[heightData.length - 1];
        const latestAge = latestHeight.x;

        // Find corresponding WHO percentile values at this age
        const whoPoint = heightTable.find(p => Math.abs(p.month - latestAge) < 3) || heightTable[heightTable.length - 1];
        const p50Value = whoPoint.M; // 50th percentile value

        const heightRatio = latestHeight.y / p50Value;

        if (heightRatio >= 0.97 && heightRatio <= 1.03) {
          heightGrowthStatus = 'Tracking 50th Percentile - Excellent Growth!';
        } else if (heightRatio >= 0.92 && heightRatio <= 1.08) {
          heightGrowthStatus = 'Steady Growth - Within Normal Range';
        } else if (heightRatio < 0.92) {
          heightGrowthStatus = 'Below Average - Monitor Closely';
        } else {
          heightGrowthStatus = 'Above Average - Monitor Development';
        }
      }

      new Chart(ctx, {
        type: 'line',
        data: { datasets },
        plugins: [ChartDataLabels],
        options: {
          responsive: true,
          interaction: {
            mode: 'nearest',
            intersect: false,
            axis: 'x'
          },
          plugins: {
            datalabels: {
              display: false // Default off for all datasets unless specifically enabled
            },
            title: {
              display: true,
              text: ['Height-for-Age Growth Chart (WHO Standards)', heightGrowthStatus],
              font: { size: 16, weight: 'bold' },
              color: heightGrowthStatus.includes('Excellent') || heightGrowthStatus.includes('Steady') ? '#27ae60' : '#e67e22'
            },
            tooltip: {
              enabled: true,
              mode: 'nearest',
              intersect: false,
              backgroundColor: 'rgba(0, 0, 0, 0.9)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: 'rgba(255, 255, 255, 0.3)',
              borderWidth: 1,
              padding: 12,
              displayColors: true,
              callbacks: {
                title: (items) => `Age: ${items[0].parsed.x.toFixed(1)} months`,
                label: (context) => `${context.dataset.label}: ${context.parsed.y.toFixed(2)} cm`
              }
            }
          },
          scales: {
            x: {
              type: 'linear',
              title: { display: true, text: 'Age (months)' },
              min: 0,
              max: 120,
              ticks: { stepSize: 12 }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Height (cm)' },
              ticks: { callback: (value) => value + ' cm' }
            }
          }
        }
      });
    }

    // Load child dashboard data
    async function loadChildDashboard() {
      const loadingIndicator = document.getElementById('loadingIndicator');
      const childInfoSection = document.getElementById('childInfoSection');
      const statsGrid = document.getElementById('statsGrid');

      try {
        console.log('Loading child dashboard...');

        currentPatientId = getQueryParam('patientId');
        currentParentId = getQueryParam('parentId');
        childName = decodeURIComponent(getQueryParam('childName') || 'Child');

        console.log('Patient ID:', currentPatientId);
        console.log('Parent ID:', currentParentId);
        console.log('Child Name:', childName);

        if (!currentPatientId || !currentParentId) {
          if (loadingIndicator) loadingIndicator.style.display = 'none';
          alert('Missing required parameters');
          goBack();
          return;
        }

        // Update header
        document.getElementById('childNameHeader').textContent = `${childName}'s Dashboard`;

        // Get parent info
        const parentDocRef = doc(db, 'users', currentParentId);
        const parentDoc = await getDoc(parentDocRef);
        const parentData = parentDoc.data();
        document.getElementById('parentNameHeader').textContent = `Parent: ${parentData.name || parentData.displayName || 'Unknown'}`;

        const parentKey = createParentKey(parentData.name || parentData.displayName || 'unknown', currentParentId);

        // Get child data
        const childDocRef = doc(db, 'patients', parentKey, 'children', currentPatientId);
        const childDoc = await getDoc(childDocRef);

        if (!childDoc.exists()) {
          alert('Child not found');
          return;
        }

        const childData = childDoc.data();

        // Display child info - use correct field names from registration form
        const dob = parseDate(childData.dob || childData.dateOfBirth);
        const age = calculateAge(dob);
        const initialWeight = childData.initialWeight || childData.weight;
        const initialHeight = childData.initialHeight || childData.height;

        document.getElementById('childInfoContent').innerHTML = `
          <div class="info-item"><strong>Name:</strong> ${childData.name}</div>
          <div class="info-item"><strong>Gender:</strong> ${childData.gender || 'N/A'}</div>
          <div class="info-item"><strong>Date of Birth:</strong> ${dob ? dob.toLocaleDateString() : 'N/A'}</div>
          <div class="info-item"><strong>Age:</strong> ${age}</div>
          <div class="info-item"><strong>Initial Weight:</strong> ${initialWeight ? initialWeight + ' kg' : 'N/A'}</div>
          <div class="info-item"><strong>Initial Height:</strong> ${initialHeight ? initialHeight + ' cm' : 'N/A'}</div>
        `;

        // Fetch consultations
        const consultationsRef = collection(db, 'patients', parentKey, 'children', currentPatientId, 'consultations');
        const consultationsQuery = query(consultationsRef, orderBy('date', 'asc'));
        const consultationsSnapshot = await getDocs(consultationsQuery);

        const consultations = [];
        consultationsSnapshot.docs.forEach(docSnap => {
          const data = docSnap.data();
          consultations.push({
            date: data.date,
            weight: data.weight,
            height: data.height,
            headCircumference: data.headCircumference,
            waterIntake: data.waterIntake,
            sleepDuration: data.sleepDuration,
            bedtime: data.bedtime,
            wakeTime: data.wakeTime,
            sleepQuality: data.sleepQuality,
            temperature: data.temperature
          });
        });

        // Display stats
        displayStats(consultations, childData);

        // Hide loading indicator and show content
        if (loadingIndicator) loadingIndicator.style.display = 'none';
        if (childInfoSection) childInfoSection.style.display = 'block';
        if (statsGrid) statsGrid.style.display = 'grid';

        // Hide chart section (not needed)
        // const growthChartSection = document.getElementById('growthChartSection');
        // if (growthChartSection) growthChartSection.style.display = 'block';

        // Draw WHO Growth Percentile Chart (Global Clinical Standard)
        // drawGrowthPercentileChart(consultations, childData);

        console.log('Dashboard loaded successfully');

      } catch (error) {
        console.error('Error loading dashboard:', error);

        // Hide loading indicator
        if (loadingIndicator) loadingIndicator.style.display = 'none';

        // Show error message
        alert('Error loading dashboard data: ' + error.message);
        const childInfoContent = document.getElementById('childInfoContent');
        if (childInfoContent) {
          if (childInfoSection) childInfoSection.style.display = 'block';
          childInfoContent.innerHTML = `<p style="color: #e74c3c;">Error loading data: ${error.message}</p>`;
        }
      }
    }

    function calculateAge(dob) {
      if (!dob) return 'N/A';
      const now = new Date();
      let years = now.getFullYear() - dob.getFullYear();
      let months = now.getMonth() - dob.getMonth();
      if (months < 0) {
        years--;
        months += 12;
      }
      if (years === 0) return `${months} months`;
      return `${years} yrs, ${months} mos`;
    }

    function displayStats(consultations, childData) {
      const statsGrid = document.getElementById('statsGrid');
      const bmiCard = document.getElementById('bmiCard');
      const bmiScoreSection = document.getElementById('bmiScoreSection');
      const totalConsultations = consultations.length;
      const latestConsult = consultations[consultations.length - 1];

      let statsHTML = `
        <div class="stat-card green">
          <h4>Total Consultations</h4>
          <p class="stat-value">${totalConsultations}</p>
        </div>
      `;

      if (latestConsult) {
        if (latestConsult.weight) {
          statsHTML += `
            <div class="stat-card blue">
              <h4>Latest Weight</h4>
              <p class="stat-value">${latestConsult.weight} kg</p>
            </div>
          `;
        }
        if (latestConsult.height) {
          statsHTML += `
            <div class="stat-card orange">
              <h4>Latest Height</h4>
              <p class="stat-value">${latestConsult.height} cm</p>
            </div>
          `;
        }
        if (latestConsult.headCircumference) {
          statsHTML += `
            <div class="stat-card">
              <h4>Latest Head Circ.</h4>
              <p class="stat-value">${latestConsult.headCircumference} cm</p>
            </div>
          `;
        }

        // Calculate BMI if weight and height are available
        if (latestConsult.weight && latestConsult.height) {
          const bmi = latestConsult.weight / Math.pow(latestConsult.height / 100, 2);

          // Calculate age in months for BMI-for-age percentile
          const dobDate = parseDate(childData.dob || childData.dateOfBirth);
          const consultDate = parseDate(latestConsult.date);
          const ageMonths = calculateAgeInMonths(dobDate, consultDate);

          // Calculate BMI percentile using WHO BMI-for-age standards
          const bmiPercentile = calculateBMIPercentile(ageMonths, bmi, childData.gender);

          // Determine WHO category and color gradient
          let bmiCategory = '';
          let bmiGradient = '';

          if (bmiPercentile < 3) {
            bmiCategory = 'Severely Underweight';
            bmiGradient = 'background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);';
          } else if (bmiPercentile < 15) {
            bmiCategory = 'Underweight';
            bmiGradient = 'background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);';
          } else if (bmiPercentile <= 85) {
            bmiCategory = 'Healthy Weight';
            bmiGradient = 'background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);';
          } else if (bmiPercentile <= 97) {
            bmiCategory = 'Overweight';
            bmiGradient = 'background: linear-gradient(135deg, #f7a83d 0%, #e09734 100%);';
          } else {
            bmiCategory = 'Obese';
            bmiGradient = 'background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);';
          }

          // Populate BMI score section
          if (bmiScoreSection) {
            bmiScoreSection.innerHTML = `
              <div class="bmi-score-section" style="${bmiGradient}">
                <h3>BMI (WHO Standard)</h3>
                <div class="bmi-score-value">${bmi.toFixed(1)}</div>
                <div class="bmi-category">${bmiCategory}</div>
                <div class="bmi-percentile">${bmiPercentile.toFixed(0)}th Percentile</div>
              </div>
            `;
          }

          // Show BMI card and store data for overview chart
          if (bmiCard) {
            bmiCard.style.display = 'block';
            window.bmiConsultationsData = consultations;
            window.bmiChildData = childData;
          }
        }
      }

      statsGrid.innerHTML = statsHTML;

      // Display hydration chart
      displayHydrationChart(consultations, childData);

      // Display sleep chart
      displaySleepChart(consultations, childData);
    }

    // Calculate WHO recommended daily water intake based on age and weight
    function calculateWHOWaterRequirement(ageMonths, weight) {
      // WHO/Pediatric guidelines for daily water intake
      if (ageMonths < 12) {
        // Infants 0-12 months: 150 ml/kg/day
        return weight * 150;
      } else if (ageMonths < 36) {
        // Children 1-3 years: 100 ml/kg/day
        return weight * 100;
      } else if (ageMonths < 96) {
        // Children 4-8 years: 50-60 ml/kg/day (using 55 ml/kg average)
        return weight * 55;
      } else if (ageMonths < 156) {
        // Children 9-13 years: Based on standard recommendations
        return ageMonths < 120 ? 1800 : 2100; // 1.8L for 9-10 yrs, 2.1L for 11-13 yrs
      } else {
        // Adolescents 14+ years: 2500-3000ml
        return 2750;
      }
    }

    // Display hydration bullet chart
    function displayHydrationChart(consultations, childData) {
      const hydrationCard = document.getElementById('hydrationCard');
      const bulletChart = document.getElementById('bulletChart');
      const hydrationValues = document.getElementById('hydrationValues');

      if (!consultations || consultations.length === 0) return;

      const latestConsult = consultations[consultations.length - 1];

      // Only show if water intake data is available
      if (!latestConsult.waterIntake || latestConsult.waterIntake <= 0) {
        if (hydrationCard) hydrationCard.style.display = 'none';
        return;
      }

      const actualIntake = latestConsult.waterIntake; // in ml

      // Calculate WHO recommended intake
      const dobDate = parseDate(childData.dob || childData.dateOfBirth);
      const consultDate = parseDate(latestConsult.date);
      const ageMonths = calculateAgeInMonths(dobDate, consultDate);
      const weight = latestConsult.weight || 20; // Use consultation weight or default

      const recommendedIntake = calculateWHOWaterRequirement(ageMonths, weight);
      const percentage = (actualIntake / recommendedIntake) * 100;

      // Determine status
      let status = '';
      let statusColor = '';
      if (percentage < 60) {
        status = 'Poor - Needs Attention';
        statusColor = '#e74c3c';
      } else if (percentage < 85) {
        status = 'Below Target';
        statusColor = '#f39c12';
      } else if (percentage <= 115) {
        status = 'Good - Well Hydrated';
        statusColor = '#27ae60';
      } else {
        status = 'Excellent';
        statusColor = '#3498db';
      }

      // Calculate range widths (based on percentage of max scale)
      const maxScale = Math.max(recommendedIntake * 1.5, actualIntake * 1.1);
      const poorWidth = (recommendedIntake * 0.6 / maxScale) * 100;
      const belowWidth = (recommendedIntake * 0.25 / maxScale) * 100;
      const goodWidth = (recommendedIntake * 0.30 / maxScale) * 100;
      const excellentWidth = 100 - (poorWidth + belowWidth + goodWidth);

      const actualWidth = (actualIntake / maxScale) * 100;
      const targetPosition = (recommendedIntake / maxScale) * 100;

      // Render bullet chart
      if (bulletChart) {
        bulletChart.innerHTML = `
          <div class="bullet-ranges">
            <div class="bullet-range poor" style="width: ${poorWidth}%;">
              ${poorWidth > 15 ? 'Poor' : ''}
            </div>
            <div class="bullet-range below" style="width: ${belowWidth}%;">
              ${belowWidth > 15 ? 'Below' : ''}
            </div>
            <div class="bullet-range good" style="width: ${goodWidth}%;">
              ${goodWidth > 15 ? 'Good' : ''}
            </div>
            <div class="bullet-range excellent" style="width: ${excellentWidth}%;">
              ${excellentWidth > 15 ? 'Excellent' : ''}
            </div>
          </div>
          <div class="bullet-measure" style="width: ${actualWidth}%; left: 0;"></div>
          <div class="bullet-marker" style="left: ${targetPosition}%;"></div>
        `;
      }

      // Render values
      if (hydrationValues) {
        hydrationValues.innerHTML = `
          <div class="hydration-value-item">
            <div class="hydration-value-label">Actual Intake</div>
            <div class="hydration-value-number">${actualIntake}<span class="hydration-value-unit"> ml</span></div>
            <div class="hydration-value-label" style="color: ${statusColor}; margin-top: 5px;">${status}</div>
          </div>
          <div class="hydration-value-item">
            <div class="hydration-value-label">WHO Recommended</div>
            <div class="hydration-value-number">${recommendedIntake}<span class="hydration-value-unit"> ml</span></div>
            <div class="hydration-value-label" style="margin-top: 5px;">Based on age & weight</div>
          </div>
          <div class="hydration-value-item">
            <div class="hydration-value-label">Achievement</div>
            <div class="hydration-value-number">${percentage.toFixed(0)}<span class="hydration-value-unit">%</span></div>
            <div class="hydration-value-label" style="margin-top: 5px;">of recommended</div>
          </div>
        `;
      }

      // Show hydration card
      if (hydrationCard) hydrationCard.style.display = 'block';

      // Store consultations data globally for overview chart
      window.hydrationConsultationsData = consultations;
      window.hydrationChildData = childData;
    }

    // Switch between Current and Overview views - Make it globally accessible
    window.switchHydrationView = function(view) {
      const currentView = document.getElementById('hydrationCurrentView');
      const overviewView = document.getElementById('hydrationOverviewView');
      const buttons = document.querySelectorAll('#hydrationCard .hydration-toggle-btn');

      if (view === 'current') {
        currentView.classList.add('active');
        overviewView.classList.remove('active');
        buttons[0].classList.add('active');
        buttons[1].classList.remove('active');
      } else {
        currentView.classList.remove('active');
        overviewView.classList.add('active');
        buttons[0].classList.remove('active');
        buttons[1].classList.add('active');

        // Draw overview chart when switching to overview view
        drawHydrationOverviewChart();
      }
    }

    // Draw hydration overview line chart
    function drawHydrationOverviewChart() {
      if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        return;
      }

      const consultations = window.hydrationConsultationsData || [];
      const childData = window.hydrationChildData || {};

      if (!consultations || consultations.length === 0) return;

      // Filter consultations with water intake data
      const hydrationData = consultations
        .map((consult, index) => {
          if (!consult.waterIntake || consult.waterIntake <= 0) return null;

          const dobDate = parseDate(childData.dob || childData.dateOfBirth);
          const consultDate = parseDate(consult.date);
          const ageMonths = calculateAgeInMonths(dobDate, consultDate);
          const weight = consult.weight || 20;
          const recommendedIntake = calculateWHOWaterRequirement(ageMonths, weight);

          return {
            visitNumber: index + 1,
            date: consultDate,
            actualIntake: consult.waterIntake,
            recommendedIntake: recommendedIntake,
            lowerBound: recommendedIntake * 0.85,
            upperBound: recommendedIntake * 1.15
          };
        })
        .filter(d => d !== null);

      if (hydrationData.length === 0) {
        document.getElementById('hydrationOverviewChart').parentElement.innerHTML =
          '<p style="text-align: center; color: #7f8c8d; padding: 40px;">No hydration data available across consultations.</p>';
        return;
      }

      const labels = hydrationData.map(d => {
        const date = d.date;
        return `Visit ${d.visitNumber}\n${date.toLocaleDateString()}`;
      });

      const ctx = document.getElementById('hydrationOverviewChart');

      // Destroy existing chart if it exists
      if (window.hydrationOverviewChartInstance) {
        window.hydrationOverviewChartInstance.destroy();
      }

      window.hydrationOverviewChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            // Healthy range area (green shaded)
            {
              label: 'Healthy Range (85-115%)',
              data: hydrationData.map(d => d.upperBound),
              backgroundColor: 'rgba(39, 174, 96, 0.2)',
              borderColor: 'rgba(39, 174, 96, 0.4)',
              borderWidth: 1,
              borderDash: [5, 5],
              fill: '+1',
              pointRadius: 0,
              datalabels: { display: false }
            },
            {
              label: 'Lower Bound',
              data: hydrationData.map(d => d.lowerBound),
              backgroundColor: 'transparent',
              borderColor: 'rgba(39, 174, 96, 0.4)',
              borderWidth: 1,
              borderDash: [5, 5],
              fill: false,
              pointRadius: 0,
              datalabels: { display: false }
            },
            // WHO Recommended line
            {
              label: 'WHO Recommended',
              data: hydrationData.map(d => d.recommendedIntake),
              borderColor: '#e74c3c',
              backgroundColor: '#e74c3c',
              borderWidth: 3,
              pointRadius: 6,
              pointHoverRadius: 8,
              pointStyle: 'circle',
              tension: 0.3,
              datalabels: {
                display: true,
                align: 'top',
                offset: 8,
                color: '#e74c3c',
                font: { weight: 'bold', size: 10 },
                formatter: (value) => `${Math.round(value)} ml`
              }
            },
            // Actual Intake line
            {
              label: "Child's Actual Intake",
              data: hydrationData.map(d => d.actualIntake),
              borderColor: '#3498db',
              backgroundColor: '#3498db',
              borderWidth: 3,
              pointRadius: 8,
              pointHoverRadius: 12,
              pointStyle: 'circle',
              pointBorderWidth: 2,
              pointBorderColor: 'white',
              tension: 0.3,
              datalabels: {
                display: true,
                align: 'bottom',
                offset: 8,
                color: '#3498db',
                font: { weight: 'bold', size: 11 },
                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                borderRadius: 4,
                padding: 4,
                formatter: (value) => `${Math.round(value)} ml`
              }
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            datalabels: { display: false },
            legend: {
              display: true,
              position: 'top',
              labels: {
                filter: (item) => {
                  return item.text !== 'Lower Bound';
                }
              }
            },
            title: {
              display: true,
              text: 'Hydration Tracking Across All Consultations',
              font: { size: 16, weight: 'bold' },
              color: '#2c3e50'
            },
            tooltip: {
              callbacks: {
                label: (context) => {
                  if (context.dataset.label === 'Lower Bound' || context.dataset.label === 'Healthy Range (85-115%)') {
                    return null;
                  }
                  return `${context.dataset.label}: ${Math.round(context.parsed.y)} ml`;
                }
              }
            }
          },
          scales: {
            x: {
              title: { display: true, text: 'Consultation Visits' }
            },
            y: {
              beginAtZero: false,
              title: { display: true, text: 'Water Intake (ml)' },
              ticks: {
                callback: (value) => value + ' ml'
              },
              suggestedMin: Math.floor(Math.min(...hydrationData.map(d => Math.min(d.lowerBound, d.actualIntake))) - 100),
              suggestedMax: Math.ceil(Math.max(...hydrationData.map(d => Math.max(d.upperBound, d.actualIntake))) + 100)
            }
          }
        }
      });
    }

    // Calculate AASM recommended sleep duration based on age
    function calculateAASMSleepRequirement(ageMonths) {
      if (ageMonths < 12) {
        return { min: 12, max: 16, ideal: 14 }; // 4-12 months
      } else if (ageMonths < 36) {
        return { min: 11, max: 14, ideal: 12.5 }; // 1-2 years
      } else if (ageMonths < 72) {
        return { min: 10, max: 13, ideal: 11.5 }; // 3-5 years
      } else if (ageMonths < 156) {
        return { min: 9, max: 12, ideal: 10.5 }; // 6-12 years
      } else {
        return { min: 8, max: 10, ideal: 9 }; // 13-18 years
      }
    }

    // Display sleep chart (called from displayStats)
    function displaySleepChart(consultations, childData) {
      const sleepCard = document.getElementById('sleepCard');
      if (!consultations || consultations.length === 0) return;

      const latestConsult = consultations[consultations.length - 1];

      // Only show if sleep data is available
      if (!latestConsult.sleepDuration || latestConsult.sleepDuration <= 0) {
        if (sleepCard) sleepCard.style.display = 'none';
        return;
      }

      const actualSleep = latestConsult.sleepDuration;
      const dobDate = parseDate(childData.dob || childData.dateOfBirth);
      const consultDate = parseDate(latestConsult.date);
      const ageMonths = calculateAgeInMonths(dobDate, consultDate);
      const recommended = calculateAASMSleepRequirement(ageMonths);

      const percentage = (actualSleep / recommended.ideal) * 100;

      // Determine status
      let status = '', statusColor = '';
      if (actualSleep < recommended.min) {
        status = 'Insufficient Sleep';
        statusColor = '#e74c3c';
      } else if (actualSleep < recommended.min + (recommended.max - recommended.min) * 0.3) {
        status = 'Below Ideal';
        statusColor = '#f39c12';
      } else if (actualSleep <= recommended.max) {
        status = 'Optimal Sleep';
        statusColor = '#27ae60';
      } else {
        status = 'Excessive Sleep';
        statusColor = '#3498db';
      }

      // Render bullet chart
      const maxScale = recommended.max * 1.3;
      const insufficientWidth = (recommended.min * 0.8 / maxScale) * 100;
      const belowWidth = ((recommended.min - recommended.min * 0.8) / maxScale) * 100;
      const optimalWidth = ((recommended.max - recommended.min) / maxScale) * 100;
      const excessiveWidth = 100 - (insufficientWidth + belowWidth + optimalWidth);

      const actualWidth = (actualSleep / maxScale) * 100;
      const targetPosition = (recommended.ideal / maxScale) * 100;

      const bulletChart = document.getElementById('sleepBulletChart');
      if (bulletChart) {
        bulletChart.innerHTML = `
          <div class="bullet-ranges">
            <div class="bullet-range poor" style="width: ${insufficientWidth}%;">
              ${insufficientWidth > 15 ? 'Insufficient' : ''}
            </div>
            <div class="bullet-range below" style="width: ${belowWidth}%;">
              ${belowWidth > 15 ? 'Below' : ''}
            </div>
            <div class="bullet-range good" style="width: ${optimalWidth}%;">
              ${optimalWidth > 15 ? 'Optimal' : ''}
            </div>
            <div class="bullet-range excellent" style="width: ${excessiveWidth}%;">
              ${excessiveWidth > 15 ? 'Excessive' : ''}
            </div>
          </div>
          <div class="bullet-measure" style="width: ${actualWidth}%; left: 0;"></div>
          <div class="bullet-marker" style="left: ${targetPosition}%;"></div>
        `;
      }

      // Render values
      const sleepValues = document.getElementById('sleepValues');
      if (sleepValues) {
        sleepValues.innerHTML = `
          <div class="hydration-value-item">
            <div class="hydration-value-label">Actual Sleep</div>
            <div class="hydration-value-number">${actualSleep.toFixed(1)}<span class="hydration-value-unit"> hrs</span></div>
            <div class="hydration-value-label" style="color: ${statusColor}; margin-top: 5px;">${status}</div>
          </div>
          <div class="hydration-value-item">
            <div class="hydration-value-label">AASM Recommended</div>
            <div class="hydration-value-number">${recommended.min}-${recommended.max}<span class="hydration-value-unit"> hrs</span></div>
            <div class="hydration-value-label" style="margin-top: 5px;">Ideal: ${recommended.ideal} hrs</div>
          </div>
          <div class="hydration-value-item">
            <div class="hydration-value-label">Sleep Quality</div>
            <div class="hydration-value-number" style="font-size: 18px;">${latestConsult.sleepQuality || 'N/A'}</div>
            <div class="hydration-value-label" style="margin-top: 5px;">Bedtime: ${latestConsult.bedtime || 'N/A'}</div>
          </div>
        `;
      }

      if (sleepCard) sleepCard.style.display = 'block';
      window.sleepConsultationsData = consultations;
      window.sleepChildData = childData;
    }

    // Switch sleep view
    window.switchSleepView = function(view) {
      const currentView = document.getElementById('sleepCurrentView');
      const overviewView = document.getElementById('sleepOverviewView');
      const buttons = document.querySelectorAll('#sleepCard .hydration-toggle-btn');

      if (view === 'current') {
        currentView.classList.add('active');
        overviewView.classList.remove('active');
        buttons[0].classList.add('active');
        buttons[1].classList.remove('active');
      } else {
        currentView.classList.remove('active');
        overviewView.classList.add('active');
        buttons[0].classList.remove('active');
        buttons[1].classList.add('active');
        drawSleepOverviewChart();
      }
    }

    // Draw sleep overview chart
    function drawSleepOverviewChart() {
      if (typeof Chart === 'undefined') return;

      const consultations = window.sleepConsultationsData || [];
      const childData = window.sleepChildData || {};
      if (!consultations || consultations.length === 0) return;

      const sleepData = consultations
        .map((consult, index) => {
          if (!consult.sleepDuration || consult.sleepDuration <= 0) return null;

          const dobDate = parseDate(childData.dob || childData.dateOfBirth);
          const consultDate = parseDate(consult.date);
          const ageMonths = calculateAgeInMonths(dobDate, consultDate);
          const recommended = calculateAASMSleepRequirement(ageMonths);

          return {
            visitNumber: index + 1,
            date: consultDate,
            actualSleep: consult.sleepDuration,
            minSleep: recommended.min,
            maxSleep: recommended.max,
            idealSleep: recommended.ideal
          };
        })
        .filter(d => d !== null);

      if (sleepData.length === 0) {
        document.getElementById('sleepOverviewChart').parentElement.innerHTML =
          '<p style="text-align: center; color: #7f8c8d; padding: 40px;">No sleep data available across consultations.</p>';
        return;
      }

      const labels = sleepData.map(d => `Visit ${d.visitNumber}\n${d.date.toLocaleDateString()}`);
      const ctx = document.getElementById('sleepOverviewChart');

      if (window.sleepOverviewChartInstance) {
        window.sleepOverviewChartInstance.destroy();
      }

      window.sleepOverviewChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'AASM Max Recommended',
              data: sleepData.map(d => d.maxSleep),
              backgroundColor: 'rgba(39, 174, 96, 0.2)',
              borderColor: 'rgba(39, 174, 96, 0.5)',
              borderWidth: 1,
              borderDash: [5, 5],
              fill: '+1',
              pointRadius: 0,
              datalabels: { display: false }
            },
            {
              label: 'AASM Min Recommended',
              data: sleepData.map(d => d.minSleep),
              backgroundColor: 'transparent',
              borderColor: 'rgba(39, 174, 96, 0.5)',
              borderWidth: 1,
              borderDash: [5, 5],
              fill: false,
              pointRadius: 0,
              datalabels: { display: false }
            },
            {
              label: "Child's Actual Sleep",
              data: sleepData.map(d => d.actualSleep),
              borderColor: '#3498db',
              backgroundColor: '#3498db',
              borderWidth: 3,
              pointRadius: 8,
              pointHoverRadius: 12,
              pointStyle: 'circle',
              pointBorderWidth: 2,
              pointBorderColor: 'white',
              tension: 0.3,
              datalabels: {
                display: true,
                align: 'top',
                offset: 8,
                color: '#3498db',
                font: { weight: 'bold', size: 11 },
                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                borderRadius: 4,
                padding: 4,
                formatter: (value) => `${value.toFixed(1)} hrs`
              }
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            datalabels: { display: false },
            legend: {
              display: true,
              position: 'top',
              labels: {
                filter: (item) => item.text !== 'AASM Min Recommended'
              }
            },
            title: {
              display: true,
              text: 'Sleep Duration Tracking Across All Consultations',
              font: { size: 16, weight: 'bold' },
              color: '#2c3e50'
            }
          },
          scales: {
            x: { title: { display: true, text: 'Consultation Visits' } },
            y: {
              beginAtZero: false,
              title: { display: true, text: 'Sleep Duration (hours)' },
              ticks: { callback: (value) => value + ' hrs' },
              suggestedMin: Math.floor(Math.min(...sleepData.map(d => Math.min(d.minSleep, d.actualSleep))) - 2),
              suggestedMax: Math.ceil(Math.max(...sleepData.map(d => Math.max(d.maxSleep, d.actualSleep))) + 2)
            }
          }
        }
      });
    }

    // Switch BMI view - globally accessible
    window.switchBMIView = function(view) {
      const currentView = document.getElementById('bmiCurrentView');
      const overviewView = document.getElementById('bmiOverviewView');
      const buttons = document.querySelectorAll('#bmiCard .hydration-toggle-btn');

      if (view === 'current') {
        currentView.classList.add('active');
        overviewView.classList.remove('active');
        buttons[0].classList.add('active');
        buttons[1].classList.remove('active');
      } else {
        currentView.classList.remove('active');
        overviewView.classList.add('active');
        buttons[0].classList.remove('active');
        buttons[1].classList.add('active');
        drawBMIOverviewChart();
      }
    }

    // Draw BMI overview chart
    function drawBMIOverviewChart() {
      if (typeof Chart === 'undefined') return;

      const consultations = window.bmiConsultationsData || [];
      const childData = window.bmiChildData || {};
      if (!consultations || consultations.length === 0) return;

      const bmiData = consultations
        .map((consult, index) => {
          if (!consult.weight || !consult.height || consult.weight <= 0 || consult.height <= 0) return null;

          const bmi = consult.weight / ((consult.height / 100) ** 2);
          const dobDate = parseDate(childData.dob || childData.dateOfBirth);
          const consultDate = parseDate(consult.date);
          const ageMonths = calculateAgeInMonths(dobDate, consultDate);
          const bmiPercentile = calculateBMIPercentile(ageMonths, bmi, childData.gender);

          return {
            visitNumber: index + 1,
            date: consultDate,
            bmi: bmi,
            percentile: bmiPercentile
          };
        })
        .filter(d => d !== null);

      if (bmiData.length === 0) {
        document.getElementById('bmiOverviewChart').parentElement.innerHTML =
          '<p style="text-align: center; color: #7f8c8d; padding: 40px;">No BMI data available across consultations.</p>';
        return;
      }

      const labels = bmiData.map(d => `Visit ${d.visitNumber}\n${d.date.toLocaleDateString()}`);
      const ctx = document.getElementById('bmiOverviewChart');

      if (window.bmiOverviewChartInstance) {
        window.bmiOverviewChartInstance.destroy();
      }

      window.bmiOverviewChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: "Child's BMI",
              data: bmiData.map(d => d.bmi),
              borderColor: '#3498db',
              backgroundColor: '#3498db',
              borderWidth: 3,
              pointRadius: 8,
              pointHoverRadius: 12,
              pointStyle: 'circle',
              pointBorderWidth: 2,
              pointBorderColor: 'white',
              tension: 0.3,
              datalabels: {
                display: true,
                align: 'top',
                offset: 8,
                color: '#3498db',
                font: { weight: 'bold', size: 11 },
                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                borderRadius: 4,
                padding: 4,
                formatter: (value) => value.toFixed(1)
              }
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            datalabels: { display: false },
            legend: {
              display: true,
              position: 'top'
            },
            title: {
              display: true,
              text: 'BMI Tracking Across All Consultations',
              font: { size: 16, weight: 'bold' },
              color: '#2c3e50'
            },
            annotation: {
              annotations: {
                severelyUnderweight: {
                  type: 'box',
                  yMin: 0,
                  yMax: 13.5,
                  backgroundColor: 'rgba(231, 76, 60, 0.1)',
                  borderColor: 'rgba(231, 76, 60, 0.3)',
                  borderWidth: 1,
                  label: {
                    display: true,
                    content: 'Severely Underweight',
                    position: 'start'
                  }
                },
                underweight: {
                  type: 'box',
                  yMin: 13.5,
                  yMax: 15,
                  backgroundColor: 'rgba(241, 196, 15, 0.1)',
                  borderColor: 'rgba(241, 196, 15, 0.3)',
                  borderWidth: 1,
                  label: {
                    display: true,
                    content: 'Underweight',
                    position: 'start'
                  }
                },
                healthy: {
                  type: 'box',
                  yMin: 15,
                  yMax: 22,
                  backgroundColor: 'rgba(76, 175, 80, 0.15)',
                  borderColor: 'rgba(76, 175, 80, 0.3)',
                  borderWidth: 1,
                  label: {
                    display: true,
                    content: 'Healthy Weight',
                    position: 'center'
                  }
                },
                overweight: {
                  type: 'box',
                  yMin: 22,
                  yMax: 25,
                  backgroundColor: 'rgba(247, 168, 61, 0.1)',
                  borderColor: 'rgba(247, 168, 61, 0.3)',
                  borderWidth: 1,
                  label: {
                    display: true,
                    content: 'Overweight',
                    position: 'start'
                  }
                },
                obese: {
                  type: 'box',
                  yMin: 25,
                  yMax: 35,
                  backgroundColor: 'rgba(52, 152, 219, 0.1)',
                  borderColor: 'rgba(52, 152, 219, 0.3)',
                  borderWidth: 1,
                  label: {
                    display: true,
                    content: 'Obese',
                    position: 'start'
                  }
                }
              }
            }
          },
          scales: {
            x: { title: { display: true, text: 'Consultation Visits' } },
            y: {
              beginAtZero: false,
              title: { display: true, text: 'BMI (kg/mÂ²)' },
              suggestedMin: Math.max(10, Math.floor(Math.min(...bmiData.map(d => d.bmi)) - 2)),
              suggestedMax: Math.min(35, Math.ceil(Math.max(...bmiData.map(d => d.bmi)) + 2))
            }
          }
        }
      });
    }

    // Calculate BMI percentile using WHO BMI-for-age standards (simplified)
    function calculateBMIPercentile(ageMonths, bmi, gender) {
      // This is a simplified calculation. In production, you'd use full WHO BMI-for-age LMS tables
      // For demonstration, using approximate values based on WHO growth charts

      // Rough approximation of BMI percentile thresholds by age and gender
      // These values are simplified; full implementation would use LMS method

      const age = Math.min(Math.max(ageMonths, 24), 228); // 2-19 years

      // Approximate WHO BMI-for-age percentile values (boys and girls average)
      // These are rough estimates for key percentiles
      const p3 = 13.5 + (age - 24) * 0.01;
      const p15 = 14.5 + (age - 24) * 0.015;
      const p50 = 16.0 + (age - 24) * 0.02;
      const p85 = 17.5 + (age - 24) * 0.025;
      const p97 = 19.0 + (age - 24) * 0.03;

      // Calculate approximate percentile
      if (bmi < p3) {
        return (bmi / p3) * 3;
      } else if (bmi < p15) {
        return 3 + ((bmi - p3) / (p15 - p3)) * 12;
      } else if (bmi < p50) {
        return 15 + ((bmi - p15) / (p50 - p15)) * 35;
      } else if (bmi < p85) {
        return 50 + ((bmi - p50) / (p85 - p50)) * 35;
      } else if (bmi < p97) {
        return 85 + ((bmi - p85) / (p97 - p85)) * 12;
      } else {
        return Math.min(99.5, 97 + ((bmi - p97) / p97) * 10);
      }
    }

    function drawGrowthPercentileChart(consultations, childData) {
      if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        document.getElementById('growthChart').parentElement.innerHTML += '<p style="color: #e74c3c; text-align: center;">Error: Chart library not loaded</p>';
        return;
      }

      // Get latest consultation data
      const latestConsult = consultations[consultations.length - 1];
      if (!latestConsult) return;

      const dobDate = parseDate(childData.dob || childData.dateOfBirth);
      const consultDate = parseDate(latestConsult.date);
      const ageMonths = calculateAgeInMonths(dobDate, consultDate);

      // Calculate percentiles for latest measurements
      const weightPercentile = calculateWeightPercentile(ageMonths, latestConsult.weight, childData.gender);
      const heightPercentile = calculateHeightPercentile(ageMonths, latestConsult.height, childData.gender);
      const hcPercentile = calculateHeadCircumferencePercentile(ageMonths, latestConsult.headCircumference, childData.gender);

      // Format age for title
      const ageYears = Math.floor(ageMonths / 12);
      const ageRemainingMonths = ageMonths % 12;
      let ageText = '';
      if (ageYears > 0 && ageRemainingMonths > 0) {
        ageText = `${ageYears} Years, ${ageRemainingMonths} Months`;
      } else if (ageYears > 0) {
        ageText = `${ageYears} Year${ageYears > 1 ? 's' : ''}`;
      } else {
        ageText = `${ageRemainingMonths} Month${ageRemainingMonths > 1 ? 's' : ''}`;
      }

      const ctx = document.getElementById('growthChart').getContext('2d');

      // Destroy existing chart if any
      if (window.growthChartInstance) {
        window.growthChartInstance.destroy();
      }

      window.growthChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Weight', 'Height', 'Head Circumference'],
          datasets: [{
            label: 'Child Percentile',
            data: [weightPercentile, heightPercentile, hcPercentile],
            backgroundColor: ['#3498db', '#3498db', '#3498db'],
            borderColor: ['#2980b9', '#2980b9', '#2980b9'],
            borderWidth: 2,
            barThickness: 60
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            title: {
              display: true,
              text: `Child Growth Status at ${ageText} (WHO-based)`,
              font: { size: 18, weight: 'bold' },
              color: '#2c3e50',
              padding: { top: 10, bottom: 20 }
            },
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: (context) => `${context.parsed.y.toFixed(1)}th percentile`
              }
            },
            annotation: {
              annotations: {
                lowerHealthyLimit: {
                  type: 'line',
                  yMin: 15,
                  yMax: 15,
                  borderColor: '#e74c3c',
                  borderWidth: 2,
                  borderDash: [8, 4],
                  label: {
                    display: true,
                    content: 'Lower Healthy Limit (15th)',
                    position: 'end',
                    backgroundColor: 'rgba(231, 76, 60, 0.8)',
                    color: 'white',
                    font: { size: 11, weight: 'bold' }
                  }
                },
                upperHealthyLimit: {
                  type: 'line',
                  yMin: 85,
                  yMax: 85,
                  borderColor: '#e74c3c',
                  borderWidth: 2,
                  borderDash: [8, 4],
                  label: {
                    display: true,
                    content: 'Upper Healthy Limit (85th)',
                    position: 'end',
                    backgroundColor: 'rgba(231, 76, 60, 0.8)',
                    color: 'white',
                    font: { size: 11, weight: 'bold' }
                  }
                },
                healthyRangeBox: {
                  type: 'box',
                  yMin: 15,
                  yMax: 85,
                  backgroundColor: 'rgba(46, 204, 113, 0.1)',
                  borderWidth: 0
                }
              }
            },
            datalabels: {
              display: true,
              anchor: 'end',
              align: 'top',
              offset: 4,
              font: { size: 14, weight: 'bold' },
              color: '#2c3e50',
              formatter: (value) => value ? `${value.toFixed(0)}th` : ''
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: 'Percentile',
                font: { size: 14, weight: 'bold' }
              },
              ticks: {
                callback: (value) => value + 'th'
              }
            },
            x: {
              title: {
                display: false
              },
              ticks: {
                font: { size: 12, weight: 'bold' }
              }
            }
          }
        }
      });

      // OLD CODE BELOW - COMMENTED OUT
      /*
      const dataPoints = consultations.map(consult => {
        const dobDate = parseDate(childData.dob || childData.dateOfBirth);
        const consultDate = parseDate(consult.date);
        const ageMonths = calculateAgeInMonths(dobDate, consultDate);
        return {
          x: ageMonths,
          weightP: calculateWeightPercentile(ageMonths, consult.weight, childData.gender),
          heightP: calculateHeightPercentile(ageMonths, consult.height, childData.gender),
          hcP: calculateHeadCircumferencePercentile(ageMonths, consult.headCircumference, childData.gender)
        };
      }).filter(dp => dp.x !== null);

      const datasets = [];

      // Add WHO reference lines for key percentiles
      const percentileLevels = [3, 15, 50, 85, 97];
      percentileLevels.forEach(p => {
        datasets.push({
          label: `WHO ${p}th Percentile`,
          data: [
            { x: 0, y: p },
            { x: 120, y: p }
          ],
          borderColor: p === 50 ? 'rgba(75, 192, 192, 0.7)' : 'rgba(189, 195, 199, 0.5)',
          backgroundColor: 'transparent',
          borderWidth: p === 50 ? 2.5 : 1,
          borderDash: p === 50 ? [] : [8, 4],
          fill: false,
          pointRadius: 0,
          tension: 0,
          datalabels: { display: false }
        });
      });

      // Weight percentile
      if (dataPoints.some(dp => dp.weightP !== null)) {
        datasets.push({
          label: 'Weight Percentile',
          data: dataPoints.map(dp => ({ x: dp.x, y: dp.weightP })).filter(d => d.y !== null),
          borderColor: 'rgba(231, 76, 60, 1)',
          backgroundColor: 'rgba(231, 76, 60, 1)',
          borderWidth: 3,
          tension: 0.3,
          fill: false,
          pointRadius: 10,
          pointHoverRadius: 14,
          pointStyle: 'circle',
          pointBorderWidth: 3,
          pointBorderColor: 'rgba(255, 255, 255, 1)',
          datalabels: {
            display: true,
            align: 'top',
            offset: 10,
            color: '#c0392b',
            font: { weight: 'bold', size: 12 },
            backgroundColor: 'rgba(255, 255, 255, 0.9)',
            borderRadius: 4,
            padding: 4,
            formatter: (value) => `${value.y.toFixed(0)}th`
          }
        });
      }

      // Height percentile
      if (dataPoints.some(dp => dp.heightP !== null)) {
        datasets.push({
          label: 'Height Percentile',
          data: dataPoints.map(dp => ({ x: dp.x, y: dp.heightP })).filter(d => d.y !== null),
          borderColor: 'rgba(52, 152, 219, 1)',
          backgroundColor: 'rgba(52, 152, 219, 1)',
          borderWidth: 3,
          tension: 0.3,
          fill: false,
          pointRadius: 10,
          pointHoverRadius: 14,
          pointStyle: 'circle',
          pointBorderWidth: 3,
          pointBorderColor: 'rgba(255, 255, 255, 1)',
          datalabels: {
            display: true,
            align: 'bottom',
            offset: 10,
            color: '#2980b9',
            font: { weight: 'bold', size: 12 },
            backgroundColor: 'rgba(255, 255, 255, 0.9)',
            borderRadius: 4,
            padding: 4,
            formatter: (value) => `${value.y.toFixed(0)}th`
          }
        });
      }

      // Head circumference percentile
      if (dataPoints.some(dp => dp.hcP !== null)) {
        datasets.push({
          label: 'Head Circumference Percentile',
          data: dataPoints.map(dp => ({ x: dp.x, y: dp.hcP })).filter(d => d.y !== null),
          borderColor: 'rgba(22, 160, 133, 1)',
          backgroundColor: 'rgba(22, 160, 133, 1)',
          borderWidth: 3,
          tension: 0.3,
          fill: false,
          pointRadius: 10,
          pointHoverRadius: 14,
          pointStyle: 'circle',
          pointBorderWidth: 3,
          pointBorderColor: 'rgba(255, 255, 255, 1)',
          datalabels: {
            display: true,
            align: 'left',
            offset: 10,
            color: '#16a085',
            font: { weight: 'bold', size: 12 },
            backgroundColor: 'rgba(255, 255, 255, 0.9)',
            borderRadius: 4,
            padding: 4,
            formatter: (value) => `${value.y.toFixed(0)}th`
          }
        });
      }

      const ctx = document.getElementById('growthChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: { datasets: datasets },
        options: {
          responsive: true,
          plugins: {
            datalabels: { display: false },
            tooltip: {
              callbacks: {
                title: (items) => `Age: ${items[0].parsed.x.toFixed(1)} months`,
                label: (context) => {
                  if (context.dataset.label.includes('WHO')) {
                    return `${context.dataset.label}`;
                  }
                  return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}th percentile`;
                }
              }
            },
            legend: {
              display: true,
              position: 'top',
              labels: {
                filter: (item) => {
                  // Show 50th percentile reference and child's measurements
                  return item.text.includes('WHO 50th') || !item.text.includes('WHO');
                }
              }
            },
            title: {
              display: true,
              text: 'Child Growth Percentiles vs WHO Standards',
              font: { size: 16, weight: 'bold' },
              color: '#2c3e50'
            }
          },
          scales: {
            x: {
              type: 'linear',
              title: { display: true, text: 'Age (months)' },
              ticks: { stepSize: 6 }
            },
            y: {
              min: 0,
              max: 100,
              title: { display: true, text: 'Percentile' },
              ticks: {
                stepSize: 10,
                callback: (value) => value + 'th'
              }
            }
          }
        }
      });
      */
    }

    function drawMeasurementsChart(consultations) {
      if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        document.getElementById('measurementsChart').parentElement.innerHTML += '<p style="color: #e74c3c; text-align: center;">Error: Chart library not loaded</p>';
        return;
      }

      const labels = consultations.map((c, i) => `Visit ${i + 1}`);

      const datasets = [];

      // Weight
      const weights = consultations.map(c => c.weight).filter(w => w !== null && w !== undefined);
      if (weights.length > 0) {
        datasets.push({
          label: 'Weight (kg)',
          data: consultations.map(c => c.weight),
          borderColor: 'rgba(255, 99, 132, 1)',
          backgroundColor: 'rgba(255, 99, 132, 0.2)',
          yAxisID: 'y1'
        });
      }

      // Height
      const heights = consultations.map(c => c.height).filter(h => h !== null && h !== undefined);
      if (heights.length > 0) {
        datasets.push({
          label: 'Height (cm)',
          data: consultations.map(c => c.height),
          borderColor: 'rgba(54, 162, 235, 1)',
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          yAxisID: 'y2'
        });
      }

      // Head Circumference
      const hcs = consultations.map(c => c.headCircumference).filter(hc => hc !== null && hc !== undefined);
      if (hcs.length > 0) {
        datasets.push({
          label: 'Head Circumference (cm)',
          data: consultations.map(c => c.headCircumference),
          borderColor: 'rgba(75, 192, 192, 1)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          yAxisID: 'y2'
        });
      }

      const ctx = document.getElementById('measurementsChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true, position: 'top' }
          },
          scales: {
            y1: {
              type: 'linear',
              display: true,
              position: 'left',
              title: { display: true, text: 'Weight (kg)' }
            },
            y2: {
              type: 'linear',
              display: true,
              position: 'right',
              title: { display: true, text: 'Height / HC (cm)' },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });
    }

    // Check authentication and load dashboard
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        alert('Please sign in to view the dashboard');
        window.location.href = '../login.html';
        return;
      }

      loadChildDashboard();
    });
  </script>
</body>
</html>
