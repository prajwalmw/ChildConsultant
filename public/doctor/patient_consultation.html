<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Doctor Portal | Consultation Form</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">

    <!-- Child-Friendly UI/UX Enhancements -->
    <link rel="stylesheet" href="../css/child-friendly.css">
    <link rel="stylesheet" type="text/css" href="../css/animsition.min.css">
    <link href="../css/font-awesome.min.css" rel="stylesheet">

    <style>
        .animsition-box {
            padding-top: 100px;
            min-height: 100vh;
        }
        .portal-container {
            padding: 40px 0;
        }
        .section-separator {
            border-top: 2px solid #ccc;
            margin-top: 30px;
            padding-top: 20px;
            margin-bottom: 20px;
        }
        .form-control[rows="5"] {
            min-height: 120px;
        }
        .form-title {
            color: #00c3c9;
            margin-bottom: 20px;
        }
        .patient-info {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .patient-info strong {
            color: #f7a83d;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>

<body class="animsition">

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCyLCI_GOl9SWDLo2zhjMthLQFZ5sA3ddM",
            authDomain: "child-consultant.firebaseapp.com",
            projectId: "child-consultant",
            storageBucket: "child-consultant.appspot.com",
            messagingSenderId: "985386588549",
            appId: "1:985386588549:web:311ecd89cc7f6aa141ccec"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentPatientId = null;
        let currentParentId = null; 
        let currentDoctorId = null;
        let currentPatientName = 'Unknown'; 
        let currentParentName = 'Loading...';

        // Function to get query parameters from URL
        function getQueryVariable(variable) {
            const query = window.location.search.substring(1);
            const vars = query.split("&");
            for (let i = 0; i < vars.length; i++) {
                const pair = vars[i].split("=");
                if (pair[0] == variable) {
                    return pair[1];
                }
            }
            return (false);
        }
        
        // Helper function to sanitize name for use in a document ID
        function slugifyName(text) {
            return text.toLowerCase()
                .trim()
                .replace(/[^a-z0-9\s-]/g, '') // Remove non-alphanumeric (except spaces/hyphens)
                .replace(/\s+/g, '-')       // Replace spaces with hyphens
                .replace(/-+/g, '-');      // Collapse multiple hyphens
        }
        
        // FIX: Create the unique, traceable Parent document key
        function createParentKey(parentName, parentId) {
            const nameSlug = slugifyName(parentName || 'unknown-parent');
            // Format: ParentNameSlug_ParentID (e.g., akshyata-tamse_asdf12345)
            return `${nameSlug}_${parentId}`;
        }


        // --- Role-Based Access and Initialization ---
        let currentDoctorName = null;
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = '../login.html';
                return;
            }
            currentDoctorId = user.uid;

            db.collection('users').doc(user.uid).get()
                .then(doc => {
                    const userData = doc.data();
                    const role = userData?.role;
                    currentDoctorName = userData?.name || userData?.displayName || user.displayName || 'Unknown Doctor';

                    if (role !== 'admin' && role !== 'doctor') {
                        alert('Access Denied. Doctors and Admins only.');
                        window.location.href = '../index.html';
                    } else {
                        initializeForm();
                        setupCancelButton();
                    }
                })
                .catch(error => {
                    console.error("Error fetching role:", error);
                    window.location.href = '../index.html';
                });
        });

        async function fetchParentName() {
            const displayElement = document.getElementById('parent-name-display');
            displayElement.textContent = `Loading...`; 

            if (!currentParentId) {
                displayElement.textContent = 'Parent ID Missing';
                return;
            }

            try {
                const doc = await db.collection('users').doc(currentParentId).get();
                if (doc.exists) {
                    const parent = doc.data();
                    currentParentName = parent.name || parent.displayName || `ID: ${currentParentId}`;
                    displayElement.textContent = currentParentName; 
                } else {
                    currentParentName = `Parent Not Found (ID: ${currentParentId})`;
                    displayElement.textContent = currentParentName;
                }
            } catch (error) {
                console.error("Error fetching parent name:", error);
                currentParentName = `Error Loading Parent (ID: ${currentParentId})`;
                displayElement.textContent = currentParentName;
            }
        }


        async function initializeForm() {
            currentPatientId = getQueryVariable('patientId');
            currentParentId = getQueryVariable('parentId'); 
            const patientAge = decodeURIComponent(getQueryVariable('patientAge') || 'N/A'); // <<-- MODIFIED: Fetch and decode age

            if (!currentPatientId || !currentParentId) {
                alert('Error: Patient ID or Parent ID not provided. Redirecting to Parent List.');
                window.location.href = 'doctor_portal.html';
                return;
            }

            const backLink = document.getElementById('cancel-back-link');
            if(backLink) {
                backLink.href = 'doctor_portal.html';
            }
            
            await fetchParentName(); 
            const parentKey = createParentKey(currentParentName, currentParentId);


            // FIX: Fetch Patient Details from the nested location
            db.collection('patients').doc(parentKey).collection('children').doc(currentPatientId).get()
                .then(doc => {
                    if (!doc.exists) {
                        alert('Error: Patient not found under the specified parent.');
                        window.location.href = 'doctor_portal.html';
                        return;
                    }
                    const patient = doc.data();

                    currentPatientName = patient.name || 'Unknown Patient';

                    document.getElementById('patient-name-display').textContent = currentPatientName;
                    document.getElementById('patient-id-display').textContent = currentPatientId;
                    document.getElementById('patient-age-display').textContent = patientAge; // <<-- MODIFIED: Display age

                    document.getElementById('date-of-visit').value = getTodayDate();

                    // Populate motor skills assessment based on child's age
                    populateMotorSkillsAssessment(patient.dob || patient.dateOfBirth, patient.gender);

                    // Populate cognitive assessment based on child's age
                    populateCognitiveAssessment(patient.dob || patient.dateOfBirth);

                    // Populate social skills assessment based on child's age
                    populateSocialSkillsAssessment(patient.dob || patient.dateOfBirth);

                    document.getElementById('consultation-form').addEventListener('submit', handleFormSubmission);
                })
                .catch(error => {
                    console.error("Error fetching patient details:", error);
                    alert('Could not load patient details.');
                    window.location.href = 'doctor_portal.html';
                });
        }
        
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Calculate age in months from DOB
        function calculateAgeInMonths(dobString) {
            if (!dobString) return null;

            let dob;
            if (dobString.seconds) {
                // Firestore Timestamp
                dob = new Date(dobString.seconds * 1000);
            } else if (typeof dobString === 'string') {
                dob = new Date(dobString);
            } else {
                dob = dobString;
            }

            const today = new Date();
            const months = (today.getFullYear() - dob.getFullYear()) * 12 + (today.getMonth() - dob.getMonth());
            return months;
        }

        // Motor Skills Questions by Age Group (WHO, CDC, MABC-2 Standards)
        const motorSkillsQuestions = {
            '2-3': {
                ageLabel: '2-3 Years',
                grossMotor: [
                    { id: 'walking', label: 'Independent Walking', description: 'Walks steadily without support' },
                    { id: 'running', label: 'Running', description: 'Runs without falling frequently' },
                    { id: 'kickingBall', label: 'Kicking Ball', description: 'Can kick a ball forward' },
                    { id: 'climbingStairs', label: 'Climbing Stairs', description: 'Climbs stairs with/without support' }
                ],
                fineMotor: [
                    { id: 'stackingBlocks', label: 'Stacking Blocks', description: 'Stacks 6+ blocks' },
                    { id: 'scribbling', label: 'Scribbling/Drawing', description: 'Scribbles with crayons' },
                    { id: 'usingUtensils', label: 'Using Spoon/Fork', description: 'Uses utensils to self-feed' }
                ],
                balance: [
                    { id: 'throwingBall', label: 'Throwing Overhand', description: 'Throws a ball overhand' },
                    { id: 'balance', label: 'Balance', description: 'Stands on one foot briefly' }
                ],
                strength: [
                    { id: 'stamina', label: 'Physical Stamina', description: 'Energy during play activities' }
                ]
            },
            '4-5': {
                ageLabel: '4-5 Years',
                grossMotor: [
                    { id: 'hopping', label: 'Hopping on One Foot', description: 'Hops on one foot 3+ times' },
                    { id: 'pedalingTricycle', label: 'Pedaling Tricycle', description: 'Pedals tricycle or bike with training wheels' },
                    { id: 'catchingBall', label: 'Catching Ball', description: 'Catches large ball with both hands' },
                    { id: 'climbing', label: 'Climbing', description: 'Climbs playground equipment confidently' }
                ],
                fineMotor: [
                    { id: 'drawingShapes', label: 'Drawing Shapes', description: 'Copies circles, squares, basic shapes' },
                    { id: 'cuttingScissors', label: 'Cutting with Scissors', description: 'Cuts paper along a line' },
                    { id: 'buttoningZipping', label: 'Buttoning/Zipping', description: 'Buttons buttons or zips zippers' }
                ],
                balance: [
                    { id: 'balancingOneFoot', label: 'Balancing', description: 'Balances on one foot for 5+ seconds' }
                ],
                strength: [
                    { id: 'stamina', label: 'Physical Stamina', description: 'Energy during physical activities' }
                ]
            },
            '6-8': {
                ageLabel: '6-8 Years',
                grossMotor: [
                    { id: 'skipping', label: 'Skipping', description: 'Skips smoothly and rhythmically' },
                    { id: 'jumpingRope', label: 'Jumping Rope', description: 'Jumps rope 5+ consecutive times' },
                    { id: 'ridingBicycle', label: 'Riding Bicycle', description: 'Rides bicycle without training wheels' },
                    { id: 'sportsSkills', label: 'Sports Skills', description: 'Coordination in sports (throwing, catching, kicking)' }
                ],
                fineMotor: [
                    { id: 'handwriting', label: 'Handwriting', description: 'Legible and neat handwriting' },
                    { id: 'tyingShoelaces', label: 'Tying Shoelaces', description: 'Ties shoelaces independently' },
                    { id: 'usingTools', label: 'Using Tools', description: 'Uses scissors, rulers, drawing tools precisely' }
                ],
                balance: [
                    { id: 'balanceBeam', label: 'Balance Beam', description: 'Walks on balance beam or narrow line' }
                ],
                strength: [
                    { id: 'endurance', label: 'Endurance', description: 'Stamina during sustained activity' }
                ]
            },
            '9-13': {
                ageLabel: '9-13 Years',
                grossMotor: [
                    { id: 'complexSports', label: 'Complex Sports Skills', description: 'Proficiency in organized sports' },
                    { id: 'reactionTime', label: 'Reaction Time', description: 'Quick reflexes and reactions' }
                ],
                fineMotor: [
                    { id: 'fineMotorPrecision', label: 'Fine Motor Precision', description: 'Precision in typing, playing instruments' }
                ],
                balance: [
                    { id: 'advancedCoordination', label: 'Advanced Coordination', description: 'Complex movement coordination' }
                ],
                strength: [
                    { id: 'endurance', label: 'Endurance', description: 'Stamina during sustained physical activity' },
                    { id: 'muscleTone', label: 'Muscle Tone', description: 'Overall muscle strength and tone' }
                ]
            }
        };

        function getAgeGroup(ageInMonths) {
            if (ageInMonths >= 24 && ageInMonths < 48) return '2-3';
            if (ageInMonths >= 48 && ageInMonths < 72) return '4-5';
            if (ageInMonths >= 72 && ageInMonths < 108) return '6-8';
            if (ageInMonths >= 108 && ageInMonths <= 156) return '9-13';
            return '4-5'; // Default to preschool if outside range
        }

        function populateMotorSkillsAssessment(dob, gender) {
            const ageInMonths = calculateAgeInMonths(dob);
            if (!ageInMonths) {
                document.getElementById('motorSkillsContainer').innerHTML =
                    '<div style="background: #fff3cd; padding: 20px; border-radius: 10px; color: #856404;"><i class="fa fa-exclamation-triangle"></i> Unable to determine child\'s age. Please ensure DOB is recorded.</div>';
                return;
            }

            const ageGroup = getAgeGroup(ageInMonths);
            const questions = motorSkillsQuestions[ageGroup];

            let html = `
                <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <strong style="color: #2e7d32;"><i class="fa fa-info-circle"></i> Age Group:</strong> ${questions.ageLabel} (${ageInMonths} months old)
                    <br>
                    <small style="color: #555;">Questions are customized based on child's developmental stage</small>
                </div>
            `;

            // Gross Motor Skills
            html += `
                <h4 style="color: #00c3c9; margin-top: 20px; margin-bottom: 15px;">
                    <i class="fa fa-child"></i> Gross Motor Skills
                </h4>
                <div class="row">
            `;
            questions.grossMotor.forEach(skill => {
                html += `
                    <div class="col-md-6 form-group">
                        <label for="motor-${skill.id}">${skill.label}</label>
                        <input type="range" class="form-control-range" id="motor-${skill.id}" name="motor-${skill.id}" min="0" max="10" value="0" oninput="document.getElementById('motor-${skill.id}-value').textContent = this.value == 0 ? '-' : this.value">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                            <small class="form-text text-muted">${skill.description}</small>
                            <span id="motor-${skill.id}-value" style="font-weight: bold; color: #00c3c9; font-size: 18px;">-</span>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;

            // Fine Motor Skills
            html += `
                <h4 style="color: #2c3e50; margin-top: 20px; margin-bottom: 15px; font-weight: 700;">
                    <i class="fa fa-hand-paper-o"></i> Fine Motor Skills
                </h4>
                <div class="row">
            `;
            questions.fineMotor.forEach(skill => {
                html += `
                    <div class="col-md-6 form-group">
                        <label for="motor-${skill.id}">${skill.label}</label>
                        <input type="range" class="form-control-range" id="motor-${skill.id}" name="motor-${skill.id}" min="0" max="10" value="0" oninput="document.getElementById('motor-${skill.id}-value').textContent = this.value == 0 ? '-' : this.value">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                            <small class="form-text text-muted">${skill.description}</small>
                            <span id="motor-${skill.id}-value" style="font-weight: bold; color: #9b59b6; font-size: 18px;">-</span>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;

            // Balance & Coordination
            html += `
                <h4 style="color: #e67e22; margin-top: 20px; margin-bottom: 15px;">
                    <i class="fa fa-balance-scale"></i> Balance & Coordination
                </h4>
                <div class="row">
            `;
            questions.balance.forEach(skill => {
                html += `
                    <div class="col-md-6 form-group">
                        <label for="motor-${skill.id}">${skill.label}</label>
                        <input type="range" class="form-control-range" id="motor-${skill.id}" name="motor-${skill.id}" min="0" max="10" value="0" oninput="document.getElementById('motor-${skill.id}-value').textContent = this.value == 0 ? '-' : this.value">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                            <small class="form-text text-muted">${skill.description}</small>
                            <span id="motor-${skill.id}-value" style="font-weight: bold; color: #e67e22; font-size: 18px;">-</span>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;

            // Strength & Endurance
            html += `
                <h4 style="color: #e74c3c; margin-top: 20px; margin-bottom: 15px;">
                    <i class="fa fa-heartbeat"></i> Strength & Endurance
                </h4>
                <div class="row">
            `;
            questions.strength.forEach(skill => {
                html += `
                    <div class="col-md-6 form-group">
                        <label for="motor-${skill.id}">${skill.label}</label>
                        <input type="range" class="form-control-range" id="motor-${skill.id}" name="motor-${skill.id}" min="0" max="10" value="0" oninput="document.getElementById('motor-${skill.id}-value').textContent = this.value == 0 ? '-' : this.value">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                            <small class="form-text text-muted">${skill.description}</small>
                            <span id="motor-${skill.id}-value" style="font-weight: bold; color: #e74c3c; font-size: 18px;">-</span>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;

            document.getElementById('motorSkillsContainer').innerHTML = html;
        }

        // Collect motor skills data from form
        function collectMotorSkillsData(form) {
            const motorSkillsInputs = form.querySelectorAll('input[name^="motor-"]');
            if (motorSkillsInputs.length === 0) {
                return null; // No motor skills data
            }

            const grossMotor = {};
            const fineMotor = {};
            const balance = {};
            const strength = {};

            motorSkillsInputs.forEach(input => {
                const skillId = input.name.replace('motor-', '');
                const value = parseInt(input.value);

                // Only include values > 0 (skip "not assessed" items)
                if (value === 0) return;

                // Categorize based on skill ID
                if (['walking', 'running', 'kickingBall', 'climbingStairs', 'hopping', 'pedalingTricycle',
                     'catchingBall', 'climbing', 'skipping', 'jumpingRope', 'ridingBicycle', 'sportsSkills',
                     'complexSports', 'reactionTime'].includes(skillId)) {
                    grossMotor[skillId] = value;
                } else if (['stackingBlocks', 'scribbling', 'usingUtensils', 'drawingShapes', 'cuttingScissors',
                           'buttoningZipping', 'handwriting', 'tyingShoelaces', 'usingTools', 'fineMotorPrecision'].includes(skillId)) {
                    fineMotor[skillId] = value;
                } else if (['throwingBall', 'balance', 'balancingOneFoot', 'balanceBeam', 'advancedCoordination'].includes(skillId)) {
                    balance[skillId] = value;
                } else if (['stamina', 'endurance', 'muscleTone'].includes(skillId)) {
                    strength[skillId] = value;
                }
            });

            // Calculate averages (only for assessed items with value > 0)
            const calcAverage = (obj) => {
                const values = Object.values(obj).filter(v => v > 0);
                return values.length > 0 ? (values.reduce((a, b) => a + b, 0) / values.length).toFixed(2) : 0;
            };

            const grossMotorAvg = parseFloat(calcAverage(grossMotor));
            const fineMotorAvg = parseFloat(calcAverage(fineMotor));
            const balanceAvg = parseFloat(calcAverage(balance));
            const strengthAvg = parseFloat(calcAverage(strength));

            // Calculate overall score only from assessed categories
            const assessedScores = [grossMotorAvg, fineMotorAvg, balanceAvg, strengthAvg].filter(score => score > 0);
            const overallScore = assessedScores.length > 0
                ? parseFloat((assessedScores.reduce((a, b) => a + b, 0) / assessedScores.length).toFixed(2))
                : 0;

            // Determine category and alert level
            let category, alertLevel;
            if (overallScore === 0) {
                category = 'Not Assessed';
                alertLevel = 'info';
            } else if (overallScore >= 9.0) {
                category = 'Excellent';
                alertLevel = 'excellent';
            } else if (overallScore >= 7.5) {
                category = 'Good';
                alertLevel = 'normal';
            } else if (overallScore >= 6.0) {
                category = 'Average';
                alertLevel = 'monitor';
            } else if (overallScore >= 4.0) {
                category = 'Below Average';
                alertLevel = 'warning';
            } else {
                category = 'Concern';
                alertLevel = 'critical';
            }

            return {
                grossMotor,
                fineMotor,
                balance,
                strength,
                grossMotorAvg,
                fineMotorAvg,
                balanceAvg,
                strengthAvg,
                overallScore,
                category,
                alertLevel,
                clinicalNotes: form['motor-skills-notes'].value || '',
                assessmentDate: new Date()
            };
        }


        // ==================== COGNITIVE DEVELOPMENT INDEX (CDI) ====================
        // Based on Bayley-4, WPPSI-IV, WISC-V, DAS-II, CDC/AAP, UNICEF ECDI2030 Standards
        // Age Groups: 2-3, 4-5, 6-8, 9-13 years
        // Domains: Attention & Focus, Memory, Problem-Solving, Language & Communication, Learning Readiness

        const cognitiveQuestions = {
            '2-3': {
                ageLabel: '2-3 Years',
                attention: [
                    { id: 'attention_engage', label: 'Sustained Engagement', description: 'Can the child sit and engage with a single activity for 5-7 minutes?', scale: '0-10 (0=Never, 10=Always)' },
                    { id: 'attention_instructions', label: 'Following Instructions', description: 'Can the child follow simple 1-2 step instructions?', scale: '0-10 (0=No comprehension, 10=Always follows)' }
                ],
                memory: [
                    { id: 'memory_objects', label: 'Object Recognition', description: 'Can remember and point to familiar objects when asked?', scale: '0-10 (0=No recall, 10=Perfect recall)' },
                    { id: 'memory_people', label: 'Familiar People', description: 'Recognizes and names familiar people (parents, siblings)?', scale: '0-10 (0=No recognition, 10=Always recognizes)' }
                ],
                problemSolving: [
                    { id: 'problem_shapes', label: 'Shape Sorting', description: 'Can sort basic shapes (circle, square, triangle)?', scale: '0-10 (0=Cannot do, 10=Sorts independently)' },
                    { id: 'problem_cause', label: 'Cause & Effect', description: 'Understands simple cause and effect (pushing button makes sound)?', scale: '0-10 (0=No understanding, 10=Full understanding)' }
                ],
                language: [
                    { id: 'language_vocabulary', label: 'Vocabulary', description: 'Uses 50+ words, combines 2-3 words into phrases?', scale: '0-10 (0=<10 words, 10=>100 words)' },
                    { id: 'language_questions', label: 'Asking Questions', description: 'Asks simple "what" or "where" questions?', scale: '0-10 (0=Never, 10=Frequently)' }
                ],
                learning: [
                    { id: 'learning_imitation', label: 'Imitation', description: 'Imitates actions and behaviors of adults/peers?', scale: '0-10 (0=No imitation, 10=Imitates complex actions)' },
                    { id: 'learning_curiosity', label: 'Curiosity', description: 'Shows curiosity, explores new objects/environments?', scale: '0-10 (0=No interest, 10=Highly curious)' }
                ]
            },
            '4-5': {
                ageLabel: '4-5 Years',
                attention: [
                    { id: 'attention_activity', label: 'Activity Completion', description: 'Can complete age-appropriate activities (10-15 min) without distraction?', scale: '0-10 (0=Cannot focus, 10=Focused throughout)' },
                    { id: 'attention_multistep', label: 'Multi-Step Instructions', description: 'Can follow 3-4 step instructions in sequence?', scale: '0-10 (0=Cannot follow, 10=Follows perfectly)' }
                ],
                memory: [
                    { id: 'memory_sequences', label: 'Sequence Recall', description: 'Can recall simple sequences (days of week, counting to 10)?', scale: '0-10 (0=No recall, 10=Perfect recall)' },
                    { id: 'memory_stories', label: 'Story Recall', description: 'Can retell simple stories or events from earlier in the day?', scale: '0-10 (0=Cannot recall, 10=Detailed recall)' }
                ],
                problemSolving: [
                    { id: 'problem_puzzles', label: 'Puzzle Solving', description: 'Can complete 12-20 piece puzzles independently?', scale: '0-10 (0=Cannot do, 10=Solves quickly)' },
                    { id: 'problem_strategies', label: 'Problem Strategies', description: 'Uses strategies to solve problems (trial & error, planning)?', scale: '0-10 (0=No strategies, 10=Uses multiple strategies)' }
                ],
                language: [
                    { id: 'language_sentences', label: 'Sentence Structure', description: 'Speaks in complete sentences (5-6 words), uses past tense?', scale: '0-10 (0=Simple words only, 10=Complex sentences)' },
                    { id: 'language_conversation', label: 'Conversation Skills', description: 'Can engage in back-and-forth conversation?', scale: '0-10 (0=No conversation, 10=Rich conversation)' }
                ],
                learning: [
                    { id: 'learning_alphabet', label: 'Pre-Literacy', description: 'Recognizes some letters/numbers, understands print has meaning?', scale: '0-10 (0=No recognition, 10=Knows alphabet/numbers)' },
                    { id: 'learning_engagement', label: 'Learning Engagement', description: 'Shows interest in learning activities, asks "why" questions?', scale: '0-10 (0=No interest, 10=Eager learner)' }
                ]
            },
            '6-8': {
                ageLabel: '6-8 Years',
                attention: [
                    { id: 'attention_classroom', label: 'Classroom Focus', description: 'Can maintain attention during classroom lessons (20-30 min)?', scale: '0-10 (0=Cannot focus, 10=Fully attentive)' },
                    { id: 'attention_distractions', label: 'Ignoring Distractions', description: 'Can ignore distractions and stay on task?', scale: '0-10 (0=Easily distracted, 10=Rarely distracted)' }
                ],
                memory: [
                    { id: 'memory_academic', label: 'Academic Information', description: 'Can recall academic information (spelling words, math facts)?', scale: '0-10 (0=Poor recall, 10=Excellent recall)' },
                    { id: 'memory_instructions', label: 'Multi-Part Instructions', description: 'Remembers and follows 5+ step instructions without reminders?', scale: '0-10 (0=Cannot remember, 10=Remembers all)' }
                ],
                problemSolving: [
                    { id: 'problem_math', label: 'Math Problem-Solving', description: 'Can solve age-appropriate math word problems?', scale: '0-10 (0=Cannot solve, 10=Solves independently)' },
                    { id: 'problem_logic', label: 'Logical Thinking', description: 'Uses logical reasoning to solve problems or make decisions?', scale: '0-10 (0=No logic, 10=Strong logic)' }
                ],
                language: [
                    { id: 'language_reading', label: 'Reading Comprehension', description: 'Reading level and comprehension appropriate for grade?', scale: '0-10 (0=Below grade level, 10=Above grade level)' },
                    { id: 'language_expression', label: 'Written Expression', description: 'Can write complete sentences/short paragraphs with ideas?', scale: '0-10 (0=Cannot write, 10=Writes fluently)' }
                ],
                learning: [
                    { id: 'learning_independence', label: 'Independent Learning', description: 'Can work independently on homework/tasks?', scale: '0-10 (0=Needs constant help, 10=Fully independent)' },
                    { id: 'learning_strategies', label: 'Learning Strategies', description: 'Uses strategies like note-taking, organizing materials?', scale: '0-10 (0=No strategies, 10=Uses multiple strategies)' }
                ]
            },
            '9-13': {
                ageLabel: '9-13 Years',
                attention: [
                    { id: 'attention_sustained', label: 'Sustained Attention', description: 'Can maintain focus during extended tasks (45+ min)?', scale: '0-10 (0=Cannot sustain, 10=Sustained focus)' },
                    { id: 'attention_planning', label: 'Planning & Organization', description: 'Plans and organizes schoolwork, manages time effectively?', scale: '0-10 (0=Disorganized, 10=Highly organized)' }
                ],
                memory: [
                    { id: 'memory_complex', label: 'Complex Information', description: 'Retains complex academic information across subjects?', scale: '0-10 (0=Poor retention, 10=Excellent retention)' },
                    { id: 'memory_longterm', label: 'Long-Term Memory', description: 'Recalls information from weeks/months ago for tests?', scale: '0-10 (0=Cannot recall, 10=Strong long-term memory)' }
                ],
                problemSolving: [
                    { id: 'problem_abstract', label: 'Abstract Thinking', description: 'Can think abstractly, understand metaphors and analogies?', scale: '0-10 (0=Concrete only, 10=Strong abstract thinking)' },
                    { id: 'problem_critical', label: 'Critical Thinking', description: 'Analyzes information critically, considers multiple perspectives?', scale: '0-10 (0=No critical thinking, 10=Advanced critical thinking)' }
                ],
                language: [
                    { id: 'language_advanced', label: 'Advanced Language', description: 'Uses advanced vocabulary, complex sentence structures?', scale: '0-10 (0=Basic language, 10=Advanced language)' },
                    { id: 'language_writing', label: 'Writing Skills', description: 'Writes organized essays/reports with clear arguments?', scale: '0-10 (0=Cannot write essays, 10=Excellent writing)' }
                ],
                learning: [
                    { id: 'learning_selfregulation', label: 'Self-Regulation', description: 'Self-regulates learning, sets goals, monitors progress?', scale: '0-10 (0=No self-regulation, 10=Strong self-regulation)' },
                    { id: 'learning_metacognition', label: 'Metacognition', description: 'Thinks about own thinking, adapts learning strategies?', scale: '0-10 (0=No awareness, 10=Strong metacognition)' }
                ]
            }
        };

        // ==================== SOCIAL INTERACTION SKILLS QUESTIONS ====================
        // Based on SSIS (Social Skills Improvement System) and ASQ:SE-2 Standards
        // Age Groups: 2-3, 4-5, 6-8, 9-13 years
        // Domains: Communication, Cooperation, Empathy, Self-Control, Engagement, Assertion, Responsibility

        const socialSkillsQuestions = {
            '2-3': {
                ageLabel: '2-3 Years (Based on ASQ:SE-2)',
                communication: [
                    { id: 'comm_express', label: 'Expression of Needs', description: 'Can the child express basic needs using words or gestures?', scale: '0-10 (0=Cannot express, 10=Clearly expresses)' },
                    { id: 'comm_respond', label: 'Response to Others', description: 'Does the child respond when called by name or spoken to?', scale: '0-10 (0=No response, 10=Always responds)' }
                ],
                interaction: [
                    { id: 'interact_peers', label: 'Peer Interaction', description: 'Shows interest in other children, attempts to play near them?', scale: '0-10 (0=No interest, 10=Actively seeks peers)' },
                    { id: 'interact_adults', label: 'Adult Interaction', description: 'Seeks comfort or help from familiar adults when needed?', scale: '0-10 (0=Avoids adults, 10=Appropriately seeks help)' }
                ],
                selfRegulation: [
                    { id: 'reg_emotions', label: 'Emotional Regulation', description: 'Can calm down with help after being upset?', scale: '0-10 (0=Cannot calm, 10=Calms easily)' },
                    { id: 'reg_transitions', label: 'Handling Transitions', description: 'Manages transitions between activities with support?', scale: '0-10 (0=Severe distress, 10=Smooth transitions)' }
                ],
                cooperation: [
                    { id: 'coop_sharing', label: 'Sharing Awareness', description: 'Beginning to understand sharing, even if reluctant?', scale: '0-10 (0=Refuses to share, 10=Willingly shares)' }
                ]
            },
            '4-5': {
                ageLabel: '4-5 Years (Based on SSIS Preschool)',
                communication: [
                    { id: 'comm_sentences', label: 'Verbal Communication', description: 'Uses complete sentences to communicate with peers and adults?', scale: '0-10 (0=Rarely/unclear, 10=Clear sentences)' },
                    { id: 'comm_listening', label: 'Listening Skills', description: 'Listens when others speak and shows understanding?', scale: '0-10 (0=Does not listen, 10=Active listener)' },
                    { id: 'comm_appropriate', label: 'Appropriate Language', description: 'Uses polite words (please, thank you, excuse me)?', scale: '0-10 (0=Never uses, 10=Consistently uses)' }
                ],
                cooperation: [
                    { id: 'coop_rules', label: 'Following Rules', description: 'Follows classroom/home rules and routines?', scale: '0-10 (0=Refuses rules, 10=Consistently follows)' },
                    { id: 'coop_turnTaking', label: 'Turn-Taking', description: 'Takes turns during games and activities?', scale: '0-10 (0=Cannot take turns, 10=Patiently waits turn)' },
                    { id: 'coop_sharing', label: 'Sharing', description: 'Shares toys and materials with other children?', scale: '0-10 (0=Refuses to share, 10=Willingly shares)' }
                ],
                empathy: [
                    { id: 'emp_feelings', label: 'Recognizing Feelings', description: 'Recognizes when others are happy, sad, or upset?', scale: '0-10 (0=No recognition, 10=Identifies emotions)' },
                    { id: 'emp_comfort', label: 'Showing Concern', description: 'Tries to comfort others who are upset or hurt?', scale: '0-10 (0=Ignores others, 10=Shows concern)' }
                ],
                selfControl: [
                    { id: 'control_impulse', label: 'Impulse Control', description: 'Thinks before acting, controls impulses?', scale: '0-10 (0=Very impulsive, 10=Good control)' },
                    { id: 'control_frustration', label: 'Frustration Tolerance', description: 'Handles frustration without tantrums or aggression?', scale: '0-10 (0=Frequent meltdowns, 10=Manages well)' }
                ],
                engagement: [
                    { id: 'engage_group', label: 'Group Participation', description: 'Participates in group activities and games?', scale: '0-10 (0=Refuses participation, 10=Actively participates)' }
                ]
            },
            '6-8': {
                ageLabel: '6-8 Years (Based on SSIS Elementary)',
                communication: [
                    { id: 'comm_conversation', label: 'Conversation Skills', description: 'Starts and maintains conversations with peers?', scale: '0-10 (0=Cannot converse, 10=Good conversations)' },
                    { id: 'comm_express', label: 'Expressing Feelings', description: 'Expresses feelings appropriately using words?', scale: '0-10 (0=Cannot express, 10=Articulates clearly)' },
                    { id: 'comm_disagreement', label: 'Handling Disagreements', description: 'Disagrees with others without fighting or yelling?', scale: '0-10 (0=Aggressive disagreement, 10=Respectful disagreement)' }
                ],
                cooperation: [
                    { id: 'coop_teamwork', label: 'Teamwork', description: 'Works well with others on group projects?', scale: '0-10 (0=Cannot work in group, 10=Excellent teamwork)' },
                    { id: 'coop_helping', label: 'Helping Others', description: 'Offers help to classmates who need it?', scale: '0-10 (0=Never helps, 10=Frequently helps)' },
                    { id: 'coop_completes', label: 'Completing Tasks', description: 'Completes assigned tasks and responsibilities?', scale: '0-10 (0=Rarely completes, 10=Always completes)' }
                ],
                assertion: [
                    { id: 'assert_opinions', label: 'Expressing Opinions', description: 'States opinions and stands up for own views appropriately?', scale: '0-10 (0=Cannot assert, 10=Appropriately assertive)' },
                    { id: 'assert_situations', label: 'Handling Situations', description: 'Says "no" to inappropriate requests from peers?', scale: '0-10 (0=Easily pressured, 10=Stands firm)' }
                ],
                responsibility: [
                    { id: 'resp_materials', label: 'Caring for Materials', description: 'Takes care of personal belongings and school materials?', scale: '0-10 (0=Very careless, 10=Very responsible)' },
                    { id: 'resp_mistakes', label: 'Accepting Responsibility', description: 'Accepts responsibility for own actions and mistakes?', scale: '0-10 (0=Blames others, 10=Accepts responsibility)' }
                ],
                empathy: [
                    { id: 'emp_perspective', label: 'Perspective-Taking', description: 'Understands others\' feelings and perspectives?', scale: '0-10 (0=No understanding, 10=Good understanding)' },
                    { id: 'emp_comfort', label: 'Comforting Others', description: 'Comforts or supports friends when they are upset?', scale: '0-10 (0=Ignores others, 10=Supportive friend)' }
                ],
                selfControl: [
                    { id: 'control_temper', label: 'Temper Control', description: 'Controls temper when angry or frustrated?', scale: '0-10 (0=Frequent outbursts, 10=Good control)' },
                    { id: 'control_waiting', label: 'Patience', description: 'Waits patiently for turn or attention?', scale: '0-10 (0=Very impatient, 10=Very patient)' }
                ],
                engagement: [
                    { id: 'engage_activities', label: 'Social Engagement', description: 'Joins in social activities and play with peers?', scale: '0-10 (0=Socially isolated, 10=Well integrated)' }
                ]
            },
            '9-13': {
                ageLabel: '9-13 Years (Based on SSIS Secondary)',
                communication: [
                    { id: 'comm_conversation', label: 'Advanced Communication', description: 'Communicates ideas and opinions clearly in discussions?', scale: '0-10 (0=Poor communication, 10=Excellent communication)' },
                    { id: 'comm_listening', label: 'Active Listening', description: 'Listens attentively and responds thoughtfully to others?', scale: '0-10 (0=Poor listener, 10=Excellent listener)' },
                    { id: 'comm_conflict', label: 'Conflict Resolution', description: 'Uses words to resolve conflicts and disagreements?', scale: '0-10 (0=Aggressive/avoidant, 10=Resolves effectively)' }
                ],
                cooperation: [
                    { id: 'coop_collaborative', label: 'Collaboration', description: 'Collaborates effectively on group assignments and projects?', scale: '0-10 (0=Cannot collaborate, 10=Excellent collaborator)' },
                    { id: 'coop_leadership', label: 'Shared Leadership', description: 'Shares leadership roles and responsibilities in groups?', scale: '0-10 (0=Dominates/withdraws, 10=Balances roles)' },
                    { id: 'coop_compromise', label: 'Compromise', description: 'Willing to compromise to reach group decisions?', scale: '0-10 (0=Inflexible, 10=Flexible/compromises)' }
                ],
                assertion: [
                    { id: 'assert_boundaries', label: 'Setting Boundaries', description: 'Sets appropriate personal boundaries with peers?', scale: '0-10 (0=Poor boundaries, 10=Healthy boundaries)' },
                    { id: 'assert_pressure', label: 'Peer Pressure Resistance', description: 'Resists negative peer pressure and influences?', scale: '0-10 (0=Easily influenced, 10=Strong resistance)' },
                    { id: 'assert_speaking', label: 'Speaking Up', description: 'Speaks up when treated unfairly or inappropriately?', scale: '0-10 (0=Never speaks up, 10=Appropriately assertive)' }
                ],
                responsibility: [
                    { id: 'resp_commitments', label: 'Meeting Commitments', description: 'Follows through on commitments and obligations?', scale: '0-10 (0=Unreliable, 10=Very reliable)' },
                    { id: 'resp_accountability', label: 'Accountability', description: 'Takes accountability for choices and consequences?', scale: '0-10 (0=Blames others, 10=Fully accountable)' }
                ],
                empathy: [
                    { id: 'emp_diverse', label: 'Respecting Differences', description: 'Respects and values diverse perspectives and backgrounds?', scale: '0-10 (0=Intolerant, 10=Very respectful)' },
                    { id: 'emp_supportive', label: 'Being Supportive', description: 'Provides emotional support to friends in difficult times?', scale: '0-10 (0=Not supportive, 10=Very supportive)' },
                    { id: 'emp_bullying', label: 'Standing Against Bullying', description: 'Stands up against bullying or exclusion of others?', scale: '0-10 (0=Passive/participates, 10=Actively opposes)' }
                ],
                selfControl: [
                    { id: 'control_emotions', label: 'Emotional Regulation', description: 'Manages emotions appropriately in various situations?', scale: '0-10 (0=Poor regulation, 10=Excellent regulation)' },
                    { id: 'control_stress', label: 'Stress Management', description: 'Handles stress and pressure in healthy ways?', scale: '0-10 (0=Poor coping, 10=Healthy coping)' }
                ],
                engagement: [
                    { id: 'engage_friendships', label: 'Maintaining Friendships', description: 'Develops and maintains meaningful friendships?', scale: '0-10 (0=No friendships, 10=Strong friendships)' },
                    { id: 'engage_community', label: 'Community Involvement', description: 'Participates in school/community social activities?', scale: '0-10 (0=Socially withdrawn, 10=Actively involved)' }
                ]
            }
        };

        function populateCognitiveAssessment(dob) {
            const ageInMonths = calculateAgeInMonths(dob);
            if (!ageInMonths) {
                document.getElementById('cognitiveContainer').innerHTML =
                    '<div style="background: #fff3cd; padding: 20px; border-radius: 10px; color: #856404;"><i class="fa fa-exclamation-triangle"></i> Unable to determine child\'s age. Please ensure DOB is recorded.</div>';
                return;
            }

            const ageGroup = getAgeGroup(ageInMonths);
            const questions = cognitiveQuestions[ageGroup];

            let html = `
                <div style="background: #f3e5f5; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <strong style="color: #7b1fa2;"><i class="fa fa-info-circle"></i> Age Group:</strong> ${questions.ageLabel} (${ageInMonths} months old)
                    <br>
                    <small style="color: #555;">Questions based on Bayley-4, WPPSI-IV, WISC-V, DAS-II, CDC/AAP, UNICEF ECDI2030 standards</small>
                </div>
            `;

            // Attention & Focus
            html += `
                <h4 style="color: #2c3e50; margin-top: 20px; margin-bottom: 15px; font-weight: 700;">
                    <i class="fa fa-eye" style="color: #667eea; margin-right: 8px;"></i> Attention & Focus
                </h4>
                <div class="row">
            `;
            questions.attention.forEach(skill => {
                html += `
                    <div class="col-md-6 form-group">
                        <label for="cdi-${skill.id}" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span style="font-weight: 600; color: #2c3e50; font-size: 13px;">${skill.label}</span>
                            <span id="cdi-${skill.id}-value" style="background: linear-gradient(135deg, #a8b3ff 0%, #d4bbff 100%); color: #2c3e50; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; box-shadow: 0 2px 4px rgba(168, 179, 255, 0.4);">5.0</span>
                        </label>
                        <small style="display: block; color: #666; margin-bottom: 8px; font-size: 11px;">${skill.description}</small>
                        <input type="range" class="form-control-range" id="cdi-${skill.id}" name="cdi-${skill.id}" min="0" max="10" step="0.5" value="5"
                            oninput="document.getElementById('cdi-${skill.id}-value').textContent = this.value"
                            style="width: 100%; height: 6px; border-radius: 5px; background: linear-gradient(to right, #e74c3c 0%, #f39c12 25%, #f1c40f 50%, #3498db 75%, #27ae60 100%); outline: none; -webkit-appearance: none;">
                    </div>
                `;
            });
            html += `</div>`;

            // Memory
            html += `
                <h4 style="color: #2c3e50; margin-top: 20px; margin-bottom: 15px; font-weight: 700;">
                    <i class="fa fa-brain" style="color: #667eea; margin-right: 8px;"></i> Memory
                </h4>
                <div class="row">
            `;
            questions.memory.forEach(skill => {
                html += `
                    <div class="col-md-6 form-group">
                        <label for="cdi-${skill.id}" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span style="font-weight: 600; color: #2c3e50; font-size: 13px;">${skill.label}</span>
                            <span id="cdi-${skill.id}-value" style="background: linear-gradient(135deg, #a8b3ff 0%, #d4bbff 100%); color: #2c3e50; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; box-shadow: 0 2px 4px rgba(168, 179, 255, 0.4);">5.0</span>
                        </label>
                        <small style="display: block; color: #666; margin-bottom: 8px; font-size: 11px;">${skill.description}</small>
                        <input type="range" class="form-control-range" id="cdi-${skill.id}" name="cdi-${skill.id}" min="0" max="10" step="0.5" value="5"
                            oninput="document.getElementById('cdi-${skill.id}-value').textContent = this.value"
                            style="width: 100%; height: 6px; border-radius: 5px; background: linear-gradient(to right, #e74c3c 0%, #f39c12 25%, #f1c40f 50%, #3498db 75%, #27ae60 100%); outline: none; -webkit-appearance: none;">
                    </div>
                `;
            });
            html += `</div>`;

            // Problem-Solving
            html += `
                <h4 style="color: #2c3e50; margin-top: 20px; margin-bottom: 15px; font-weight: 700;">
                    <i class="fa fa-puzzle-piece" style="color: #667eea; margin-right: 8px;"></i> Problem-Solving
                </h4>
                <div class="row">
            `;
            questions.problemSolving.forEach(skill => {
                html += `
                    <div class="col-md-6 form-group">
                        <label for="cdi-${skill.id}" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span style="font-weight: 600; color: #2c3e50; font-size: 13px;">${skill.label}</span>
                            <span id="cdi-${skill.id}-value" style="background: linear-gradient(135deg, #a8b3ff 0%, #d4bbff 100%); color: #2c3e50; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; box-shadow: 0 2px 4px rgba(168, 179, 255, 0.4);">5.0</span>
                        </label>
                        <small style="display: block; color: #666; margin-bottom: 8px; font-size: 11px;">${skill.description}</small>
                        <input type="range" class="form-control-range" id="cdi-${skill.id}" name="cdi-${skill.id}" min="0" max="10" step="0.5" value="5"
                            oninput="document.getElementById('cdi-${skill.id}-value').textContent = this.value"
                            style="width: 100%; height: 6px; border-radius: 5px; background: linear-gradient(to right, #e74c3c 0%, #f39c12 25%, #f1c40f 50%, #3498db 75%, #27ae60 100%); outline: none; -webkit-appearance: none;">
                    </div>
                `;
            });
            html += `</div>`;

            // Language & Communication
            html += `
                <h4 style="color: #2c3e50; margin-top: 20px; margin-bottom: 15px; font-weight: 700;">
                    <i class="fa fa-comments" style="color: #667eea; margin-right: 8px;"></i> Language & Communication
                </h4>
                <div class="row">
            `;
            questions.language.forEach(skill => {
                html += `
                    <div class="col-md-6 form-group">
                        <label for="cdi-${skill.id}" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span style="font-weight: 600; color: #2c3e50; font-size: 13px;">${skill.label}</span>
                            <span id="cdi-${skill.id}-value" style="background: linear-gradient(135deg, #a8b3ff 0%, #d4bbff 100%); color: #2c3e50; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; box-shadow: 0 2px 4px rgba(168, 179, 255, 0.4);">5.0</span>
                        </label>
                        <small style="display: block; color: #666; margin-bottom: 8px; font-size: 11px;">${skill.description}</small>
                        <input type="range" class="form-control-range" id="cdi-${skill.id}" name="cdi-${skill.id}" min="0" max="10" step="0.5" value="5"
                            oninput="document.getElementById('cdi-${skill.id}-value').textContent = this.value"
                            style="width: 100%; height: 6px; border-radius: 5px; background: linear-gradient(to right, #e74c3c 0%, #f39c12 25%, #f1c40f 50%, #3498db 75%, #27ae60 100%); outline: none; -webkit-appearance: none;">
                    </div>
                `;
            });
            html += `</div>`;

            // Learning Readiness
            html += `
                <h4 style="color: #2c3e50; margin-top: 20px; margin-bottom: 15px; font-weight: 700;">
                    <i class="fa fa-graduation-cap" style="color: #667eea; margin-right: 8px;"></i> Learning Readiness
                </h4>
                <div class="row">
            `;
            questions.learning.forEach(skill => {
                html += `
                    <div class="col-md-6 form-group">
                        <label for="cdi-${skill.id}" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span style="font-weight: 600; color: #2c3e50; font-size: 13px;">${skill.label}</span>
                            <span id="cdi-${skill.id}-value" style="background: linear-gradient(135deg, #a8b3ff 0%, #d4bbff 100%); color: #2c3e50; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; box-shadow: 0 2px 4px rgba(168, 179, 255, 0.4);">5.0</span>
                        </label>
                        <small style="display: block; color: #666; margin-bottom: 8px; font-size: 11px;">${skill.description}</small>
                        <input type="range" class="form-control-range" id="cdi-${skill.id}" name="cdi-${skill.id}" min="0" max="10" step="0.5" value="5"
                            oninput="document.getElementById('cdi-${skill.id}-value').textContent = this.value"
                            style="width: 100%; height: 6px; border-radius: 5px; background: linear-gradient(to right, #e74c3c 0%, #f39c12 25%, #f1c40f 50%, #3498db 75%, #27ae60 100%); outline: none; -webkit-appearance: none;">
                    </div>
                `;
            });
            html += `</div>`;

            document.getElementById('cognitiveContainer').innerHTML = html;
        }

        function populateSocialSkillsAssessment(dob) {
            const ageInMonths = calculateAgeInMonths(dob);
            if (!ageInMonths) {
                document.getElementById('socialContainer').innerHTML =
                    '<div style="background: #d1ecf1; padding: 20px; border-radius: 10px; color: #0c5460;"><i class="fa fa-exclamation-triangle"></i> Unable to determine child\'s age. Please ensure DOB is recorded.</div>';
                return;
            }

            const ageGroup = getAgeGroup(ageInMonths);
            const questions = socialSkillsQuestions[ageGroup];

            let html = `
                <div style="background: #d1ecf1; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <strong style="color: #0c5460;"><i class="fa fa-info-circle"></i> Age Group:</strong> ${questions.ageLabel} (${ageInMonths} months old)
                    <br>
                    <small style="color: #555;">Questions based on SSIS (Social Skills Improvement System) and ASQ:SE-2 standards</small>
                </div>
            `;

            // Communication
            if (questions.communication) {
                html += `
                    <h4 style="color: #2c3e50; margin-top: 20px; margin-bottom: 15px; font-weight: 700;">
                        <i class="fa fa-comments" style="color: #3498db; margin-right: 8px;"></i> Communication
                    </h4>
                    <div class="row">
                `;
                questions.communication.forEach(skill => {
                    html += `
                        <div class="col-md-6 form-group">
                            <label for="sisa-${skill.id}" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span style="font-weight: 600; color: #2c3e50; font-size: 13px;">${skill.label}</span>
                                <span id="sisa-${skill.id}-value" style="background: linear-gradient(135deg, #a8d5ff 0%, #c4e0ff 100%); color: #2c3e50; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; box-shadow: 0 2px 4px rgba(52, 152, 219, 0.4);">5.0</span>
                            </label>
                            <small style="display: block; color: #666; margin-bottom: 8px; font-size: 11px;">${skill.description}</small>
                            <input type="range" class="form-control-range" id="sisa-${skill.id}" name="sisa-${skill.id}" min="0" max="10" step="0.5" value="5"
                                oninput="document.getElementById('sisa-${skill.id}-value').textContent = this.value"
                                style="width: 100%; height: 6px; border-radius: 5px; background: linear-gradient(to right, #e74c3c 0%, #f39c12 25%, #f1c40f 50%, #3498db 75%, #27ae60 100%); outline: none; -webkit-appearance: none;">
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Cooperation
            if (questions.cooperation) {
                html += `
                    <h4 style="color: #2c3e50; margin-top: 20px; margin-bottom: 15px; font-weight: 700;">
                        <i class="fa fa-handshake" style="color: #3498db; margin-right: 8px;"></i> Cooperation
                    </h4>
                    <div class="row">
                `;
                questions.cooperation.forEach(skill => {
                    html += `
                        <div class="col-md-6 form-group">
                            <label for="sisa-${skill.id}" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span style="font-weight: 600; color: #2c3e50; font-size: 13px;">${skill.label}</span>
                                <span id="sisa-${skill.id}-value" style="background: linear-gradient(135deg, #a8d5ff 0%, #c4e0ff 100%); color: #2c3e50; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; box-shadow: 0 2px 4px rgba(52, 152, 219, 0.4);">5.0</span>
                            </label>
                            <small style="display: block; color: #666; margin-bottom: 8px; font-size: 11px;">${skill.description}</small>
                            <input type="range" class="form-control-range" id="sisa-${skill.id}" name="sisa-${skill.id}" min="0" max="10" step="0.5" value="5"
                                oninput="document.getElementById('sisa-${skill.id}-value').textContent = this.value"
                                style="width: 100%; height: 6px; border-radius: 5px; background: linear-gradient(to right, #e74c3c 0%, #f39c12 25%, #f1c40f 50%, #3498db 75%, #27ae60 100%); outline: none; -webkit-appearance: none;">
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Empathy
            if (questions.empathy) {
                html += `
                    <h4 style="color: #2c3e50; margin-top: 20px; margin-bottom: 15px; font-weight: 700;">
                        <i class="fa fa-heart" style="color: #3498db; margin-right: 8px;"></i> Empathy
                    </h4>
                    <div class="row">
                `;
                questions.empathy.forEach(skill => {
                    html += `
                        <div class="col-md-6 form-group">
                            <label for="sisa-${skill.id}" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span style="font-weight: 600; color: #2c3e50; font-size: 13px;">${skill.label}</span>
                                <span id="sisa-${skill.id}-value" style="background: linear-gradient(135deg, #a8d5ff 0%, #c4e0ff 100%); color: #2c3e50; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; box-shadow: 0 2px 4px rgba(52, 152, 219, 0.4);">5.0</span>
                            </label>
                            <small style="display: block; color: #666; margin-bottom: 8px; font-size: 11px;">${skill.description}</small>
                            <input type="range" class="form-control-range" id="sisa-${skill.id}" name="sisa-${skill.id}" min="0" max="10" step="0.5" value="5"
                                oninput="document.getElementById('sisa-${skill.id}-value').textContent = this.value"
                                style="width: 100%; height: 6px; border-radius: 5px; background: linear-gradient(to right, #e74c3c 0%, #f39c12 25%, #f1c40f 50%, #3498db 75%, #27ae60 100%); outline: none; -webkit-appearance: none;">
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Self-Control
            if (questions.selfControl) {
                html += `
                    <h4 style="color: #2c3e50; margin-top: 20px; margin-bottom: 15px; font-weight: 700;">
                        <i class="fa fa-balance-scale" style="color: #3498db; margin-right: 8px;"></i> Self-Control
                    </h4>
                    <div class="row">
                `;
                questions.selfControl.forEach(skill => {
                    html += `
                        <div class="col-md-6 form-group">
                            <label for="sisa-${skill.id}" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span style="font-weight: 600; color: #2c3e50; font-size: 13px;">${skill.label}</span>
                                <span id="sisa-${skill.id}-value" style="background: linear-gradient(135deg, #a8d5ff 0%, #c4e0ff 100%); color: #2c3e50; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; box-shadow: 0 2px 4px rgba(52, 152, 219, 0.4);">5.0</span>
                            </label>
                            <small style="display: block; color: #666; margin-bottom: 8px; font-size: 11px;">${skill.description}</small>
                            <input type="range" class="form-control-range" id="sisa-${skill.id}" name="sisa-${skill.id}" min="0" max="10" step="0.5" value="5"
                                oninput="document.getElementById('sisa-${skill.id}-value').textContent = this.value"
                                style="width: 100%; height: 6px; border-radius: 5px; background: linear-gradient(to right, #e74c3c 0%, #f39c12 25%, #f1c40f 50%, #3498db 75%, #27ae60 100%); outline: none; -webkit-appearance: none;">
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Engagement
            if (questions.engagement) {
                html += `
                    <h4 style="color: #2c3e50; margin-top: 20px; margin-bottom: 15px; font-weight: 700;">
                        <i class="fa fa-user-friends" style="color: #3498db; margin-right: 8px;"></i> Social Engagement
                    </h4>
                    <div class="row">
                `;
                questions.engagement.forEach(skill => {
                    html += `
                        <div class="col-md-6 form-group">
                            <label for="sisa-${skill.id}" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span style="font-weight: 600; color: #2c3e50; font-size: 13px;">${skill.label}</span>
                                <span id="sisa-${skill.id}-value" style="background: linear-gradient(135deg, #a8d5ff 0%, #c4e0ff 100%); color: #2c3e50; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; box-shadow: 0 2px 4px rgba(52, 152, 219, 0.4);">5.0</span>
                            </label>
                            <small style="display: block; color: #666; margin-bottom: 8px; font-size: 11px;">${skill.description}</small>
                            <input type="range" class="form-control-range" id="sisa-${skill.id}" name="sisa-${skill.id}" min="0" max="10" step="0.5" value="5"
                                oninput="document.getElementById('sisa-${skill.id}-value').textContent = this.value"
                                style="width: 100%; height: 6px; border-radius: 5px; background: linear-gradient(to right, #e74c3c 0%, #f39c12 25%, #f1c40f 50%, #3498db 75%, #27ae60 100%); outline: none; -webkit-appearance: none;">
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Interaction (for younger children)
            if (questions.interaction) {
                html += `
                    <h4 style="color: #2c3e50; margin-top: 20px; margin-bottom: 15px; font-weight: 700;">
                        <i class="fa fa-users" style="color: #3498db; margin-right: 8px;"></i> Social Interaction
                    </h4>
                    <div class="row">
                `;
                questions.interaction.forEach(skill => {
                    html += `
                        <div class="col-md-6 form-group">
                            <label for="sisa-${skill.id}" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span style="font-weight: 600; color: #2c3e50; font-size: 13px;">${skill.label}</span>
                                <span id="sisa-${skill.id}-value" style="background: linear-gradient(135deg, #a8d5ff 0%, #c4e0ff 100%); color: #2c3e50; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; box-shadow: 0 2px 4px rgba(52, 152, 219, 0.4);">5.0</span>
                            </label>
                            <small style="display: block; color: #666; margin-bottom: 8px; font-size: 11px;">${skill.description}</small>
                            <input type="range" class="form-control-range" id="sisa-${skill.id}" name="sisa-${skill.id}" min="0" max="10" step="0.5" value="5"
                                oninput="document.getElementById('sisa-${skill.id}-value').textContent = this.value"
                                style="width: 100%; height: 6px; border-radius: 5px; background: linear-gradient(to right, #e74c3c 0%, #f39c12 25%, #f1c40f 50%, #3498db 75%, #27ae60 100%); outline: none; -webkit-appearance: none;">
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Self-Regulation (for younger children)
            if (questions.selfRegulation) {
                html += `
                    <h4 style="color: #2c3e50; margin-top: 20px; margin-bottom: 15px; font-weight: 700;">
                        <i class="fa fa-brain" style="color: #3498db; margin-right: 8px;"></i> Self-Regulation
                    </h4>
                    <div class="row">
                `;
                questions.selfRegulation.forEach(skill => {
                    html += `
                        <div class="col-md-6 form-group">
                            <label for="sisa-${skill.id}" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span style="font-weight: 600; color: #2c3e50; font-size: 13px;">${skill.label}</span>
                                <span id="sisa-${skill.id}-value" style="background: linear-gradient(135deg, #a8d5ff 0%, #c4e0ff 100%); color: #2c3e50; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; box-shadow: 0 2px 4px rgba(52, 152, 219, 0.4);">5.0</span>
                            </label>
                            <small style="display: block; color: #666; margin-bottom: 8px; font-size: 11px;">${skill.description}</small>
                            <input type="range" class="form-control-range" id="sisa-${skill.id}" name="sisa-${skill.id}" min="0" max="10" step="0.5" value="5"
                                oninput="document.getElementById('sisa-${skill.id}-value').textContent = this.value"
                                style="width: 100%; height: 6px; border-radius: 5px; background: linear-gradient(to right, #e74c3c 0%, #f39c12 25%, #f1c40f 50%, #3498db 75%, #27ae60 100%); outline: none; -webkit-appearance: none;">
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Assertion (for older children)
            if (questions.assertion) {
                html += `
                    <h4 style="color: #2c3e50; margin-top: 20px; margin-bottom: 15px; font-weight: 700;">
                        <i class="fa fa-bullhorn" style="color: #3498db; margin-right: 8px;"></i> Assertion
                    </h4>
                    <div class="row">
                `;
                questions.assertion.forEach(skill => {
                    html += `
                        <div class="col-md-6 form-group">
                            <label for="sisa-${skill.id}" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span style="font-weight: 600; color: #2c3e50; font-size: 13px;">${skill.label}</span>
                                <span id="sisa-${skill.id}-value" style="background: linear-gradient(135deg, #a8d5ff 0%, #c4e0ff 100%); color: #2c3e50; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; box-shadow: 0 2px 4px rgba(52, 152, 219, 0.4);">5.0</span>
                            </label>
                            <small style="display: block; color: #666; margin-bottom: 8px; font-size: 11px;">${skill.description}</small>
                            <input type="range" class="form-control-range" id="sisa-${skill.id}" name="sisa-${skill.id}" min="0" max="10" step="0.5" value="5"
                                oninput="document.getElementById('sisa-${skill.id}-value').textContent = this.value"
                                style="width: 100%; height: 6px; border-radius: 5px; background: linear-gradient(to right, #e74c3c 0%, #f39c12 25%, #f1c40f 50%, #3498db 75%, #27ae60 100%); outline: none; -webkit-appearance: none;">
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Responsibility (for older children)
            if (questions.responsibility) {
                html += `
                    <h4 style="color: #2c3e50; margin-top: 20px; margin-bottom: 15px; font-weight: 700;">
                        <i class="fa fa-certificate" style="color: #3498db; margin-right: 8px;"></i> Responsibility
                    </h4>
                    <div class="row">
                `;
                questions.responsibility.forEach(skill => {
                    html += `
                        <div class="col-md-6 form-group">
                            <label for="sisa-${skill.id}" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span style="font-weight: 600; color: #2c3e50; font-size: 13px;">${skill.label}</span>
                                <span id="sisa-${skill.id}-value" style="background: linear-gradient(135deg, #a8d5ff 0%, #c4e0ff 100%); color: #2c3e50; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; box-shadow: 0 2px 4px rgba(52, 152, 219, 0.4);">5.0</span>
                            </label>
                            <small style="display: block; color: #666; margin-bottom: 8px; font-size: 11px;">${skill.description}</small>
                            <input type="range" class="form-control-range" id="sisa-${skill.id}" name="sisa-${skill.id}" min="0" max="10" step="0.5" value="5"
                                oninput="document.getElementById('sisa-${skill.id}-value').textContent = this.value"
                                style="width: 100%; height: 6px; border-radius: 5px; background: linear-gradient(to right, #e74c3c 0%, #f39c12 25%, #f1c40f 50%, #3498db 75%, #27ae60 100%); outline: none; -webkit-appearance: none;">
                        </div>
                    `;
                });
                html += `</div>`;
            }

            document.getElementById('socialContainer').innerHTML = html;
        }

        function collectCognitiveData(form) {
            const attention = {};
            const memory = {};
            const problemSolving = {};
            const language = {};
            const learning = {};

            // Get all CDI inputs
            const cdiInputs = form.querySelectorAll('[name^="cdi-"]');
            cdiInputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                const skillId = input.name.replace('cdi-', '');

                // Categorize by domain based on skill ID prefix
                if (skillId.startsWith('attention_')) {
                    attention[skillId] = value;
                } else if (skillId.startsWith('memory_')) {
                    memory[skillId] = value;
                } else if (skillId.startsWith('problem_')) {
                    problemSolving[skillId] = value;
                } else if (skillId.startsWith('language_')) {
                    language[skillId] = value;
                } else if (skillId.startsWith('learning_')) {
                    learning[skillId] = value;
                }
            });

            // Calculate averages (only for assessed items with value > 0)
            const calcAverage = (obj) => {
                const values = Object.values(obj).filter(v => v > 0);
                return values.length > 0 ? (values.reduce((a, b) => a + b, 0) / values.length).toFixed(2) : 0;
            };

            const attentionAvg = parseFloat(calcAverage(attention));
            const memoryAvg = parseFloat(calcAverage(memory));
            const problemSolvingAvg = parseFloat(calcAverage(problemSolving));
            const languageAvg = parseFloat(calcAverage(language));
            const learningAvg = parseFloat(calcAverage(learning));

            // Calculate overall score (convert 0-10 scale to 0-130 Bayley-4 scale)
            const assessedScores = [attentionAvg, memoryAvg, problemSolvingAvg, languageAvg, learningAvg].filter(score => score > 0);
            const rawScore = assessedScores.length > 0
                ? parseFloat((assessedScores.reduce((a, b) => a + b, 0) / assessedScores.length).toFixed(2))
                : 0;

            // Convert to Bayley-4 scale: 0-10  0-130 (mean 100, SD 15)
            const overallScore = rawScore > 0 ? Math.round((rawScore * 13) + 0) : 0;

            // Determine category and alert level based on Bayley-4, WPPSI-IV, WISC-V standards
            let category, alertLevel;
            if (overallScore === 0) {
                category = 'Not Assessed';
                alertLevel = 'info';
            } else if (overallScore >= 116) {
                // >115: Accelerated (>1 SD above mean)
                category = 'Excellent';
                alertLevel = 'excellent';
            } else if (overallScore >= 100) {
                // 100-115: Above Average to High Average
                category = 'Good';
                alertLevel = 'normal';
            } else if (overallScore >= 85) {
                // 85-99: Average to Low Average
                category = 'Average';
                alertLevel = 'monitor';
            } else if (overallScore >= 70) {
                // 70-84: Mildly Delayed (1-2 SD below mean)
                category = 'Below Average';
                alertLevel = 'warning';
            } else {
                // <70: Significantly Delayed (>2 SD below mean)
                category = 'Concern';
                alertLevel = 'critical';
            }

            return {
                attention,
                memory,
                problemSolving,
                language,
                learning,
                attentionAvg,
                memoryAvg,
                problemSolvingAvg,
                languageAvg,
                learningAvg,
                overallScore,
                category,
                alertLevel,
                clinicalNotes: form['cognitive-notes']?.value || '',
                assessmentDate: new Date()
            };
        }

        // Collect Social Interaction Skills Assessment data from form
        function collectSocialSkillsData(form) {
            const communication = {};
            const cooperation = {};
            const empathy = {};
            const selfControl = {};
            const engagement = {};
            const interaction = {};
            const selfRegulation = {};
            const assertion = {};
            const responsibility = {};

            // Get all SISA inputs
            const sisaInputs = form.querySelectorAll('[name^="sisa-"]');
            sisaInputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                const skillId = input.name.replace('sisa-', '');

                // Categorize by domain based on skill ID prefix
                if (skillId.startsWith('comm_')) {
                    communication[skillId] = value;
                } else if (skillId.startsWith('coop_')) {
                    cooperation[skillId] = value;
                } else if (skillId.startsWith('emp_')) {
                    empathy[skillId] = value;
                } else if (skillId.startsWith('self_')) {
                    selfControl[skillId] = value;
                } else if (skillId.startsWith('engage_')) {
                    engagement[skillId] = value;
                } else if (skillId.startsWith('interact_')) {
                    interaction[skillId] = value;
                } else if (skillId.startsWith('reg_')) {
                    selfRegulation[skillId] = value;
                } else if (skillId.startsWith('assert_')) {
                    assertion[skillId] = value;
                } else if (skillId.startsWith('resp_')) {
                    responsibility[skillId] = value;
                }
            });

            // Calculate averages (only for assessed items with value > 0)
            const calcAverage = (obj) => {
                const values = Object.values(obj).filter(v => v > 0);
                return values.length > 0 ? (values.reduce((a, b) => a + b, 0) / values.length).toFixed(2) : 0;
            };

            const communicationAvg = parseFloat(calcAverage(communication));
            const cooperationAvg = parseFloat(calcAverage(cooperation));
            const empathyAvg = parseFloat(calcAverage(empathy));
            const selfControlAvg = parseFloat(calcAverage(selfControl));
            const engagementAvg = parseFloat(calcAverage(engagement));
            const interactionAvg = parseFloat(calcAverage(interaction));
            const selfRegulationAvg = parseFloat(calcAverage(selfRegulation));
            const assertionAvg = parseFloat(calcAverage(assertion));
            const responsibilityAvg = parseFloat(calcAverage(responsibility));

            // Calculate overall score (0-10 scale converted to 0-100 percentile)
            const assessedScores = [
                communicationAvg, cooperationAvg, empathyAvg, selfControlAvg,
                engagementAvg, interactionAvg, selfRegulationAvg, assertionAvg, responsibilityAvg
            ].filter(score => score > 0);

            const overallScore = assessedScores.length > 0
                ? parseFloat(((assessedScores.reduce((a, b) => a + b, 0) / assessedScores.length) * 10).toFixed(2))
                : 0;

            // Determine category and alert level based on SSIS standards (0-100 percentile)
            let category, alertLevel;
            if (overallScore === 0) {
                category = 'Not Assessed';
                alertLevel = 'info';
            } else if (overallScore >= 85) {
                // 85th percentile+: Well Developed
                category = 'Excellent';
                alertLevel = 'excellent';
            } else if (overallScore >= 70) {
                // 70-84th percentile: Above Average
                category = 'Good';
                alertLevel = 'normal';
            } else if (overallScore >= 40) {
                // 40-69th percentile: Average Range
                category = 'Average';
                alertLevel = 'monitor';
            } else if (overallScore >= 16) {
                // 16-39th percentile: Below Average, Monitor
                category = 'Below Average';
                alertLevel = 'warning';
            } else {
                // <16th percentile: Concern, Intervention Needed
                category = 'Concern';
                alertLevel = 'critical';
            }

            return {
                communication,
                cooperation,
                empathy,
                selfControl,
                engagement,
                interaction,
                selfRegulation,
                assertion,
                responsibility,
                communicationAvg,
                cooperationAvg,
                empathyAvg,
                selfControlAvg,
                engagementAvg,
                interactionAvg,
                selfRegulationAvg,
                assertionAvg,
                responsibilityAvg,
                overallScore,
                category,
                alertLevel,
                clinicalNotes: form['social-notes']?.value || '',
                assessmentDate: new Date()
            };
        }


        // Generates Readable, UNIQUE ID using Name and Timestamp
        function generateConsultationId(patientName) {
            const nameSlug = slugifyName(patientName || 'patient');
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const milliseconds = String(now.getMilliseconds()).padStart(3, '0');

            // Format: PatientNameSlug-YYYYMMDD-HHMMSS-MMM (Easily readable and unique)
            return `${nameSlug}-${year}${month}${day}-${hours}${minutes}${seconds}-${milliseconds}`;
        }

        async function handleFormSubmission(e) {
            e.preventDefault();

            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            const consultationId = generateConsultationId(currentPatientName);
            const parentKey = createParentKey(currentParentName, currentParentId);

            // Collect form values
            const weight = parseFloat(form['weight'].value) || null;
            const height = parseFloat(form['height'].value) || null;
            const headCircumference = parseFloat(form['head-circumference'].value) || null;
            const waterIntake = parseFloat(form['water-intake'].value) || null;
            const sleepDuration = parseFloat(form['sleep-duration'].value) || null;
            const bedtime = form['bedtime'].value || null;
            const wakeTime = form['wake-time'].value || null;
            const sleepQuality = form['sleep-quality'].value || null;
            const subjective = form['subjective'].value || '';
            const objective = form['objective'].value || '';
            const assessment = form['assessment'].value || '';
            const plan = form['plan'].value || '';

            const consultationData = {
                // Consultation Metadata
                doctorId: currentDoctorId,
                doctorName: currentDoctorName,
                consultationDate: new Date(form['date-of-visit'].value),
                date: new Date(form['date-of-visit'].value),
                type: form['consultation-type'].value,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),

                // Physical Health (Grouped)
                physicalHealth: {
                    weight: weight,
                    height: height,
                    headCircumference: headCircumference,
                    temperature: form['temperature'].value || null,
                    symptomDuration: form['symptom-duration'].value || null,
                    clinicalNotes: form['vitals-notes'].value || ''
                },

                // Hydration (Grouped)
                hydration: {
                    waterIntake: waterIntake
                },

                // Sleep Health (Grouped)
                sleepHealth: {
                    sleepDuration: sleepDuration,
                    bedtime: bedtime,
                    wakeTime: wakeTime,
                    sleepQuality: sleepQuality
                },

                // Nutritional Health (Grouped)
                nutritionalHealth: {
                    // Physical Indicators
                    energyLevel: form['energy-level']?.value || null,
                    appetite: form['appetite']?.value || null,
                    skinHealth: form['skin-health']?.value || null,
                    hairQuality: form['hair-quality']?.value || null,
                    nailHealth: form['nail-health']?.value || null,

                    // Dietary Intake
                    mealsPerDay: parseFloat(form['meals-per-day']?.value) || null,
                    dietaryPattern: form['dietary-pattern']?.value || null,
                    breakfastRegularity: form['breakfast-regularity']?.value || null,
                    junkFoodFrequency: form['junk-food-frequency']?.value || null,

                    // Food Groups
                    fruitServings: parseFloat(form['fruit-servings']?.value) || null,
                    vegetableServings: parseFloat(form['vegetable-servings']?.value) || null,
                    dairyIntake: parseFloat(form['dairy-intake']?.value) || null,

                    // Supplements
                    supplements: Array.from(form.querySelectorAll('input[name="supplement"]:checked')).map(cb => cb.value),

                    // Clinical Notes
                    clinicalNotes: form['nutritional-notes']?.value || ''
                },

                // Motor Skills Coordination (Grouped)
                motorSkills: collectMotorSkillsData(form),

                // Cognitive Development Index (Grouped)
                cognitiveHealth: collectCognitiveData(form),

                // Social Interaction Skills Assessment (Grouped)
                socialSkills: collectSocialSkillsData(form),

                // S.O.A.P. Notes (Grouped)
                soapNotes: {
                    subjective: subjective,
                    objective: objective,
                    assessment: assessment,
                    plan: plan
                },

                // Action/Follow-up (Grouped)
                followUp: {
                    prescriptionGiven: form['prescription-given'].checked,
                    followUpRequired: form['follow-up-required'].checked,
                    nextFollowUpDate: form['follow-up-required'].checked && form['next-follow-up-date'].value ? new Date(form['next-follow-up-date'].value) : null
                },

                // ===== BACKWARD COMPATIBILITY - Root level fields =====
                // These maintain compatibility with existing dashboard code
                weight: weight,
                height: height,
                headCircumference: headCircumference,
                waterIntake: waterIntake,
                temperature: form['temperature'].value || null,
                symptomDuration: form['symptom-duration'].value || null,
                vitalsNotes: form['vitals-notes'].value || '',
                sleepDuration: sleepDuration,
                bedtime: bedtime,
                wakeTime: wakeTime,
                sleepQuality: sleepQuality,
                subjective: subjective,
                objective: objective,
                assessment: assessment,
                plan: plan,
                prescriptionGiven: form['prescription-given'].checked,
                followUpRequired: form['follow-up-required'].checked,
                nextFollowUpDate: form['follow-up-required'].checked && form['next-follow-up-date'].value ? new Date(form['next-follow-up-date'].value) : null
            };

            try {
                // FIX: Save consultation notes to the deepest sub-collection
                await db.collection('patients').doc(parentKey)
                        .collection('children').doc(currentPatientId)
                        .collection('consultations').doc(consultationId)
                        .set(consultationData);

                alert(`Consultation notes saved successfully for ${currentPatientName}!`);
                window.location.href = 'doctor_portal.html';
            } catch (error) {
                console.error("Error saving consultation notes:", error);
                alert(`Error saving consultation notes: ${error.message}. Please try again.`);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Consultation Notes';
            }
        }

        function setupCancelButton() {
            const backLink = document.getElementById('cancel-back-link');
            if (backLink) {
                backLink.addEventListener('click', function(e) {
                    // Prevent default action initially
                    e.preventDefault(); 

                    window.location.href = backLink.href;
                });
            }
        }
    </script>

    <div id="animsition-box" class="animsition-box">
        <div class="header">
            <div class="container">
                <div class="row">
                    <div class="col-md-12">
                         <div class="logo"> <a href="../index.html"><img src="../images/logo.png" alt="Logo"></a> </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container portal-container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="section-title">
                        <h1 class="form-title">New Consultation Notes</h1>
                        <div class="patient-info">
                            <strong>Patient Name:</strong> <span id="patient-name-display">Loading...</span> 
                            | <strong>ID:</strong> <span id="patient-id-display">Loading...</span>
                            | <strong>Age:</strong> <span id="patient-age-display">Loading...</span>
                        </div>
                        <div class="patient-info">
                            <strong>Parent:</strong> <span id="parent-name-display">Loading...</span>
                        </div>
                    </div>

                    <form id="consultation-form">
                        <div class="row">
                            <div class="col-md-4 form-group">
                                <label for="date-of-visit">Date of Visit</label>
                                <input type="date" class="form-control" id="date-of-visit" required>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="consultation-type">Consultation Type</label>
                                <select class="form-control" id="consultation-type" required>
                                    <option value="">Select consultation type...</option>
                                    <option value="Initial">Initial Visit</option>
                                    <option value="Follow-up">Follow-up</option>
                                    <option value="Emergency">Emergency</option>
                                    <option value="Routine Checkup">Routine Checkup</option>
                                </select>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="symptom-duration">Symptom Duration</label>
                                <input type="text" class="form-control" id="symptom-duration" placeholder="e.g., 3 days, 1 week">
                            </div>
                        </div>
                        
                        <!-- ==================== PHYSICAL DEVELOPMENT SECTION ==================== -->
                        <div class="section-separator">
                            <h3 style="color: #00c3c9;">
                                <i class="fa fa-child"></i> Physical Development
                            </h3>
                            <p style="color: #7f8c8d; font-size: 13px; margin-top: 10px;">
                                Growth measurements, vital signs, and physical examination findings
                                <br>
                                <strong>Standards:</strong> WHO Child Growth Standards, CDC Growth Charts
                            </p>
                        </div>

                        <!-- Growth Measurements -->
                        <div style="background: #e0f7fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #00c3c9;">
                            <h4 style="margin-top: 0; color: #00c3c9; font-size: 16px; font-weight: bold;">
                                <i class="fa fa-line-chart"></i> Growth Measurements
                            </h4>
                            <p style="color: #7f8c8d; font-size: 12px; margin-bottom: 15px;">
                                Primary anthropometric measurements for growth tracking
                            </p>

                            <div class="row">
                                <div class="col-md-3 form-group">
                                    <label for="weight">Weight (kg)</label>
                                    <input type="number" step="0.1" class="form-control" id="weight">
                                </div>
                                <div class="col-md-3 form-group">
                                    <label for="height">Height (cm)</label>
                                    <input type="number" step="0.1" class="form-control" id="height">
                                </div>
                                <div class="col-md-3 form-group">
                                    <label for="head-circumference">Head Circumference (cm)</label>
                                    <input type="number" step="0.1" class="form-control" id="head-circumference">
                                </div>
                                <div class="col-md-3 form-group">
                                    <label for="temperature">Temperature (C)</label>
                                    <input type="text" class="form-control" id="temperature" placeholder="e.g., 37.5, Normal">
                                </div>
                            </div>
                        </div>

                        <!-- Physical Examination Notes -->
                        <div class="form-group">
                            <label for="vitals-notes">Physical Examination Notes</label>
                            <textarea class="form-control" id="vitals-notes" rows="3" placeholder="Physical findings, reflexes, posture, coordination observations..."></textarea>
                        </div>

                        <!-- ==================== MOTOR SKILLS (Under Physical Development) ==================== -->
                        <div style="background: #fff3e0; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #FF9800; margin-top: 20px;">
                            <h4 style="margin-top: 0; color: #FF9800; font-size: 16px; font-weight: bold;">
                                <i class="fa fa-bolt"></i> Motor Skills Coordination
                            </h4>
                            <p style="color: #7f8c8d; font-size: 12px; margin-bottom: 15px;">
                                Rate each motor skill on a scale of 0-10 (0 = Not Assessed, 1-10 = Performance Level)
                                <br>
                                Age-appropriate questions will auto-populate based on child's age
                                <br>
                                <strong>Standards:</strong> WHO Motor Development Milestones, CDC Developmental Milestones, MABC-2
                            </p>

                            <!-- Motor Skills will be dynamically populated based on age -->
                            <div id="motorSkillsContainer">
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; color: #95a5a6;">
                                    <i class="fa fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                    <p style="margin: 0;">Loading age-appropriate motor skills assessment...</p>
                                </div>
                            </div>

                            <div style="margin-top: 20px;">
                                <label for="motor-skills-notes">Clinical Notes (Motor Skills)</label>
                                <textarea class="form-control" id="motor-skills-notes" rows="3" placeholder="Additional observations about motor development, concerns, or recommendations..."></textarea>
                            </div>
                        </div>

                        <!-- ==================== NUTRITIONAL HEALTH SECTION ==================== -->
                        <div class="section-separator">
                            <h3 style="color: #27ae60;">
                                <i class="fa fa-heart"></i> Nutritional Health
                            </h3>
                            <p style="color: #7f8c8d; font-size: 13px; margin-top: 10px;">
                                Dietary habits, hydration status, and nutritional clinical indicators
                                <br>
                                <strong>Standards:</strong> WHO Nutrient Intake Guidelines, ICMR RDA, Dietary Reference Intakes
                            </p>
                        </div>

                        <!-- Hydration Status -->
                        <div style="background: #e0f7fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #00ACC1;">
                            <h4 style="margin-top: 0; color: #00ACC1; font-size: 16px; font-weight: bold;">
                                <i class="fa fa-tint"></i> Hydration Status
                            </h4>
                            <p style="color: #7f8c8d; font-size: 12px; margin-bottom: 15px;">
                                Daily water and fluid intake assessment
                            </p>

                            <div class="row">
                                <div class="col-md-6 form-group">
                                    <label for="water-intake">Daily Water Intake (ml)</label>
                                    <input type="number" step="50" class="form-control" id="water-intake" placeholder="e.g., 1200">
                                    <small class="form-text text-muted">Reference: 1 small glass = 200ml, 1 regular glass = 250ml, 1 large glass = 300ml</small>
                                </div>
                            </div>
                        </div>

                        <!-- Sleep & Rest -->
                        <div style="background: #e8eaf6; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #5C6BC0;">
                            <h4 style="margin-top: 0; color: #5C6BC0; font-size: 16px; font-weight: bold;">
                                <i class="fa fa-moon-o"></i> Sleep & Rest
                            </h4>
                            <p style="color: #7f8c8d; font-size: 12px; margin-bottom: 15px;">
                                Based on American Academy of Sleep Medicine (AASM) guidelines
                            </p>

                        <div class="row">
                            <div class="col-md-4 form-group">
                                <label for="sleep-duration">Total Sleep Duration (hours per day)</label>
                                <input type="number" step="0.5" class="form-control" id="sleep-duration" placeholder="e.g., 10.5">
                                <small class="form-text text-muted">Include nighttime sleep + daytime naps</small>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="bedtime">Typical Bedtime</label>
                                <input type="time" class="form-control" id="bedtime">
                                <small class="form-text text-muted">Usual time child goes to bed</small>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="wake-time">Typical Wake Time</label>
                                <input type="time" class="form-control" id="wake-time">
                                <small class="form-text text-muted">Usual time child wakes up</small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label for="sleep-quality">Sleep Quality</label>
                                <select class="form-control" id="sleep-quality">
                                    <option value="">Select sleep quality...</option>
                                    <option value="Excellent">Excellent - Sleeps through night, no disturbances</option>
                                    <option value="Good">Good - Occasional wake-ups (1-2 times)</option>
                                    <option value="Fair">Fair - Frequent wake-ups (3-5 times)</option>
                                    <option value="Poor">Poor - Very restless, wakes up many times</option>
                                </select>
                            </div>
                        </div>
                        </div>

                        <!-- Nutritional Clinical Observations -->
                        <div style="background: #f0f8ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
                            <h4 style="margin-top: 0; color: #2196F3; font-size: 16px; font-weight: bold;">
                                <i class="fa fa-stethoscope"></i> Nutritional Clinical Observations
                            </h4>
                            <p style="color: #7f8c8d; font-size: 12px; margin-bottom: 15px;">
                                Physical signs related to nutritional health during examination
                            </p>

                            <div class="row">
                                <div class="col-md-4 form-group">
                                    <label for="energy-level">Energy Level</label>
                                    <select class="form-control" id="energy-level">
                                        <option value="">Select energy level...</option>
                                        <option value="low">Low - Lethargic, tired</option>
                                        <option value="normal">Normal - Age-appropriate</option>
                                        <option value="high">High - Very active, energetic</option>
                                    </select>
                                </div>
                                <div class="col-md-4 form-group">
                                    <label for="appetite">Appetite</label>
                                    <select class="form-control" id="appetite">
                                        <option value="">Select appetite level...</option>
                                        <option value="poor">Poor - Eats very little</option>
                                        <option value="normal">Normal - Adequate intake</option>
                                        <option value="good">Good - Healthy appetite</option>
                                    </select>
                                </div>
                                <div class="col-md-4 form-group">
                                    <label for="skin-health">Skin Health</label>
                                    <select class="form-control" id="skin-health">
                                        <option value="">Select skin health...</option>
                                        <option value="dry">Dry/Rough skin</option>
                                        <option value="normal">Normal skin</option>
                                        <option value="healthy">Healthy glow</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 form-group">
                                    <label for="hair-quality">Hair Quality</label>
                                    <select class="form-control" id="hair-quality">
                                        <option value="">Select hair quality...</option>
                                        <option value="brittle">Brittle/Dry hair</option>
                                        <option value="normal">Normal hair</option>
                                        <option value="healthy">Healthy/Lustrous hair</option>
                                    </select>
                                </div>
                                <div class="col-md-4 form-group">
                                    <label for="nail-health">Nail Health</label>
                                    <select class="form-control" id="nail-health">
                                        <option value="">Select nail health...</option>
                                        <option value="brittle">Brittle/Weak nails</option>
                                        <option value="normal">Normal nails</option>
                                        <option value="strong">Strong/Healthy nails</option>
                                    </select>
                                </div>
                                <div class="col-md-4 form-group">
                                    <label for="pallor">Pallor (Anemia Signs)</label>
                                    <div style="margin-top: 8px;">
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" id="pallor"> Pallor detected (pale conjunctiva/palms)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Dietary Information Subsection -->
                        <div style="background: #fff8e1; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #FFC107;">
                            <h4 style="margin-top: 0; color: #F57C00; font-size: 16px; font-weight: bold;">
                                <i class="fa fa-cutlery"></i> Dietary Information (Ask Parent/Guardian)
                            </h4>
                            <p style="color: #7f8c8d; font-size: 12px; margin-bottom: 15px;">
                                Quick verbal questions about child's typical eating patterns
                            </p>

                            <div class="row">
                                <div class="col-md-3 form-group">
                                    <label for="meals-per-day">Meals Per Day</label>
                                    <input type="number" class="form-control" id="meals-per-day" min="1" max="8" placeholder="e.g., 3">
                                    <small class="form-text text-muted">Main meals + snacks</small>
                                </div>
                                <div class="col-md-3 form-group">
                                    <label for="dietary-pattern">Dietary Pattern</label>
                                    <select class="form-control" id="dietary-pattern">
                                        <option value="">Select dietary pattern...</option>
                                        <option value="vegetarian">Vegetarian (with dairy/eggs)</option>
                                        <option value="non-vegetarian">Non-Vegetarian/Mixed</option>
                                        <option value="vegan">Vegan (plant-based only)</option>
                                        <option value="eggetarian">Eggetarian (eggs + veg)</option>
                                    </select>
                                </div>
                                <div class="col-md-3 form-group">
                                    <label for="breakfast-regularity">Breakfast Regularity</label>
                                    <select class="form-control" id="breakfast-regularity">
                                        <option value="">Select frequency...</option>
                                        <option value="daily">Daily</option>
                                        <option value="sometimes">Sometimes (3-4x/week)</option>
                                        <option value="rarely">Rarely (0-2x/week)</option>
                                    </select>
                                </div>
                                <div class="col-md-3 form-group">
                                    <label for="junk-food-frequency">Junk Food (per week)</label>
                                    <select class="form-control" id="junk-food-frequency">
                                        <option value="">Select frequency...</option>
                                        <option value="never">Never/Very Rare</option>
                                        <option value="1-2">1-2 times</option>
                                        <option value="3-4">3-4 times</option>
                                        <option value="5+">5+ times</option>
                                    </select>
                                    <small class="form-text text-muted">Chips, sodas, fast food</small>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 form-group">
                                    <label for="fruit-servings">Fruit Servings (per day)</label>
                                    <input type="number" class="form-control" id="fruit-servings" min="0" max="6" step="0.5" placeholder="e.g., 1">
                                    <small class="form-text text-muted">Fresh fruits</small>
                                </div>
                                <div class="col-md-4 form-group">
                                    <label for="vegetable-servings">Vegetable Servings (per day)</label>
                                    <input type="number" class="form-control" id="vegetable-servings" min="0" max="6" step="0.5" placeholder="e.g., 2">
                                    <small class="form-text text-muted">All vegetables</small>
                                </div>
                                <div class="col-md-4 form-group">
                                    <label for="dairy-intake">Milk/Dairy Intake (ml/day)</label>
                                    <input type="number" class="form-control" id="dairy-intake" min="0" max="1000" step="50" placeholder="e.g., 250">
                                    <small class="form-text text-muted">Milk, curd, paneer</small>
                                </div>
                            </div>
                        </div>

                        <!-- Supplements Subsection -->
                        <div style="background: #f3e5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #9C27B0;">
                            <h4 style="margin-top: 0; color: #9C27B0; font-size: 16px; font-weight: bold;">
                                <i class="fa fa-medkit"></i> Nutritional Supplements
                            </h4>
                            <p style="color: #7f8c8d; font-size: 12px; margin-bottom: 15px;">
                                Check all supplements currently being taken by the child
                            </p>

                            <div class="row">
                                <div class="col-md-12">
                                    <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" name="supplement" value="none" id="supplement-none"> None
                                            </label>
                                        </div>
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" name="supplement" value="multivitamin"> Multivitamin
                                            </label>
                                        </div>
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" name="supplement" value="iron"> Iron
                                            </label>
                                        </div>
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" name="supplement" value="calcium"> Calcium
                                            </label>
                                        </div>
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" name="supplement" value="vitaminD"> Vitamin D
                                            </label>
                                        </div>
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" name="supplement" value="omega3"> Omega-3
                                            </label>
                                        </div>
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" name="supplement" value="zinc"> Zinc
                                            </label>
                                        </div>
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" name="supplement" value="other"> Other
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Nutritional Assessment Notes -->
                        <div class="form-group">
                            <label for="nutritional-notes">Clinical Notes (Nutritional Health)</label>
                            <textarea class="form-control" id="nutritional-notes" rows="3" placeholder="Any dietary concerns, food allergies, feeding difficulties, specific nutritional recommendations, or follow-up actions..."></textarea>
                        </div>

                        <!-- ==================== COGNITIVE DEVELOPMENT INDEX (CDI) ==================== -->
                        <div class="section-separator">
                            <h3 style="color: #9b59b6;">
                                <i class="fa fa-graduation-cap"></i> Cognitive Development Index (CDI)
                            </h3>
                            <p style="color: #7f8c8d; font-size: 13px; margin-top: 10px;">
                                <i class="fa fa-info-circle"></i> Age-appropriate assessment based on Bayley-4, WPPSI-IV, WISC-V, DAS-II, CDC/AAP, UNICEF ECDI2030 standards
                            </p>
                        </div>

                        <!-- CDI Assessment Container (Auto-populated based on child's age) -->
                        <div id="cognitiveContainer" style="margin-top: 20px;">
                            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; color: #856404;">
                                <i class="fa fa-exclamation-triangle"></i> Cognitive assessment questions will appear once child's date of birth is loaded.
                            </div>
                        </div>

                        <!-- Cognitive Assessment Notes -->
                        <div class="form-group">
                            <label for="cognitive-notes">Clinical Notes (Cognitive Development)</label>
                            <textarea class="form-control" id="cognitive-notes" rows="3" placeholder="Any observations about attention, memory, problem-solving, language development, learning challenges, or recommendations..."></textarea>
                        </div>

                        <!-- ==================== SOCIAL INTERACTION SKILLS SECTION ==================== -->
                        <div class="section-separator">
                            <h3 style="color: #3498db;">
                                <i class="fa fa-users"></i> Social Interaction Skills Assessment (SISA)
                            </h3>
                            <p style="color: #7f8c8d; font-size: 13px; margin-top: 10px;">
                                <i class="fa fa-info-circle"></i> Age-appropriate assessment based on SSIS (Social Skills Improvement System) and ASQ:SE-2 standards
                            </p>
                        </div>

                        <!-- SISA Assessment Container (Auto-populated based on child's age) -->
                        <div id="socialContainer" style="margin-top: 20px;">
                            <div style="background: #d1ecf1; padding: 20px; border-radius: 10px; color: #0c5460;">
                                <i class="fa fa-exclamation-triangle"></i> Social interaction assessment questions will appear once child's date of birth is loaded.
                            </div>
                        </div>

                        <!-- Social Skills Assessment Notes -->
                        <div class="form-group">
                            <label for="social-notes">Clinical Notes (Social Interaction Skills)</label>
                            <textarea class="form-control" id="social-notes" rows="3" placeholder="Any observations about communication, cooperation, empathy, self-control, social engagement, or recommendations..."></textarea>
                        </div>

                        <div class="section-separator">
                            <h3>S.O.A.P. Notes</h3>
                        </div>
                        
                        <div class="form-group">
                            <label for="subjective">S. Subjective (Chief Complaint & History)</label>
                            <textarea class="form-control" id="subjective" rows="5" required placeholder="Patient's reported symptoms, onset, duration, and relevant history."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="objective">O. Objective (Physical Exam / Vitals Findings)</label>
                            <textarea class="form-control" id="objective" rows="5" placeholder="Doctor's findings from examination."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="assessment">A. Assessment / Diagnosis</label>
                            <textarea class="form-control" id="assessment" rows="5" required placeholder="Final diagnosis or differential diagnosis."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="plan">P. Plan / Treatment</label>
                            <textarea class="form-control" id="plan" rows="5" required placeholder="Treatment plan, medication, advice, and discharge instructions."></textarea>
                        </div>

                        <div class="section-separator">
                            <h3>Action & Follow-up</h3>
                        </div>

                        <div class="row">
                            <div class="col-md-4 form-group">
                                <div class="checkbox">
                                    <label>
                                        <input type="checkbox" id="prescription-given"> Prescription Given
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4 form-group">
                                <div class="checkbox">
                                    <label>
                                        <input type="checkbox" id="follow-up-required"> Follow-up Required
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="next-follow-up-date">Next Follow-up Date</label>
                                <input type="date" class="form-control" id="next-follow-up-date">
                            </div>
                        </div>

                        <div class="form-group text-center">
                            <button type="submit" class="btn btn-primary btn-lg">Save Consultation Notes</button>
                            <a id="cancel-back-link" href="#" class="btn btn-default btn-lg animsition-link">Cancel / Back to Child List</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="tiny-footer">
            <div class="container">
                <p>Doctor Portal Access</p>
            </div>
        </div>

    </div>

    <script src="../js/jquery.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../js/animsition.js"></script>
    <script type="text/javascript" src="../js/animsition-script.js"></script>
</body>
</html>