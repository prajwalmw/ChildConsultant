<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Doctor Portal | Consultation Form</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">

    <!-- Child-Friendly UI/UX Enhancements -->
    <link rel="stylesheet" href="../css/child-friendly.css">
    <link rel="stylesheet" type="text/css" href="../css/animsition.min.css">
    <link href="../css/font-awesome.min.css" rel="stylesheet">

    <style>
        .animsition-box {
            padding-top: 100px;
            min-height: 100vh;
        }
        .portal-container {
            padding: 40px 0;
        }
        .section-separator {
            border-top: 2px solid #ccc;
            margin-top: 30px;
            padding-top: 20px;
            margin-bottom: 20px;
        }
        .form-control[rows="5"] {
            min-height: 120px;
        }
        .form-title {
            color: #00c3c9;
            margin-bottom: 20px;
        }
        .patient-info {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .patient-info strong {
            color: #f7a83d;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>

<body class="animsition">

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCyLCI_GOl9SWDLo2zhjMthLQFZ5sA3ddM",
            authDomain: "child-consultant.firebaseapp.com",
            projectId: "child-consultant",
            storageBucket: "child-consultant.appspot.com",
            messagingSenderId: "985386588549",
            appId: "1:985386588549:web:311ecd89cc7f6aa141ccec"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentPatientId = null;
        let currentParentId = null; 
        let currentDoctorId = null;
        let currentPatientName = 'Unknown'; 
        let currentParentName = 'Loading...';

        // Function to get query parameters from URL
        function getQueryVariable(variable) {
            const query = window.location.search.substring(1);
            const vars = query.split("&");
            for (let i = 0; i < vars.length; i++) {
                const pair = vars[i].split("=");
                if (pair[0] == variable) {
                    return pair[1];
                }
            }
            return (false);
        }
        
        // Helper function to sanitize name for use in a document ID
        function slugifyName(text) {
            return text.toLowerCase()
                .trim()
                .replace(/[^a-z0-9\s-]/g, '') // Remove non-alphanumeric (except spaces/hyphens)
                .replace(/\s+/g, '-')       // Replace spaces with hyphens
                .replace(/-+/g, '-');      // Collapse multiple hyphens
        }
        
        // FIX: Create the unique, traceable Parent document key
        function createParentKey(parentName, parentId) {
            const nameSlug = slugifyName(parentName || 'unknown-parent');
            // Format: ParentNameSlug_ParentID (e.g., akshyata-tamse_asdf12345)
            return `${nameSlug}_${parentId}`;
        }


        // --- Role-Based Access and Initialization ---
        let currentDoctorName = null;
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = '../login.html';
                return;
            }
            currentDoctorId = user.uid;

            db.collection('users').doc(user.uid).get()
                .then(doc => {
                    const userData = doc.data();
                    const role = userData?.role;
                    currentDoctorName = userData?.name || userData?.displayName || user.displayName || 'Unknown Doctor';

                    if (role !== 'admin' && role !== 'doctor') {
                        alert('Access Denied. Doctors and Admins only.');
                        window.location.href = '../index.html';
                    } else {
                        initializeForm();
                        setupCancelButton();
                    }
                })
                .catch(error => {
                    console.error("Error fetching role:", error);
                    window.location.href = '../index.html';
                });
        });

        async function fetchParentName() {
            const displayElement = document.getElementById('parent-name-display');
            displayElement.textContent = `Loading...`; 

            if (!currentParentId) {
                displayElement.textContent = 'Parent ID Missing';
                return;
            }

            try {
                const doc = await db.collection('users').doc(currentParentId).get();
                if (doc.exists) {
                    const parent = doc.data();
                    currentParentName = parent.name || parent.displayName || `ID: ${currentParentId}`;
                    displayElement.textContent = currentParentName; 
                } else {
                    currentParentName = `Parent Not Found (ID: ${currentParentId})`;
                    displayElement.textContent = currentParentName;
                }
            } catch (error) {
                console.error("Error fetching parent name:", error);
                currentParentName = `Error Loading Parent (ID: ${currentParentId})`;
                displayElement.textContent = currentParentName;
            }
        }


        async function initializeForm() {
            currentPatientId = getQueryVariable('patientId');
            currentParentId = getQueryVariable('parentId'); 
            const patientAge = decodeURIComponent(getQueryVariable('patientAge') || 'N/A'); // <<-- MODIFIED: Fetch and decode age

            if (!currentPatientId || !currentParentId) {
                alert('Error: Patient ID or Parent ID not provided. Redirecting to Parent List.');
                window.location.href = 'doctor_portal.html';
                return;
            }

            const backLink = document.getElementById('cancel-back-link');
            if(backLink) {
                backLink.href = `child_selection.html?parentId=${currentParentId}`;
            }
            
            await fetchParentName(); 
            const parentKey = createParentKey(currentParentName, currentParentId);


            // FIX: Fetch Patient Details from the nested location
            db.collection('patients').doc(parentKey).collection('children').doc(currentPatientId).get()
                .then(doc => {
                    if (!doc.exists) {
                        alert('Error: Patient not found under the specified parent.');
                        window.location.href = `child_selection.html?parentId=${currentParentId}`;
                        return;
                    }
                    const patient = doc.data();

                    currentPatientName = patient.name || 'Unknown Patient';

                    document.getElementById('patient-name-display').textContent = currentPatientName;
                    document.getElementById('patient-id-display').textContent = currentPatientId;
                    document.getElementById('patient-age-display').textContent = patientAge; // <<-- MODIFIED: Display age

                    document.getElementById('date-of-visit').value = getTodayDate();

                    // Populate motor skills assessment based on child's age
                    populateMotorSkillsAssessment(patient.dob || patient.dateOfBirth, patient.gender);

                    document.getElementById('consultation-form').addEventListener('submit', handleFormSubmission);
                })
                .catch(error => {
                    console.error("Error fetching patient details:", error);
                    alert('Could not load patient details.');
                    window.location.href = `child_selection.html?parentId=${currentParentId}`;
                });
        }
        
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Calculate age in months from DOB
        function calculateAgeInMonths(dobString) {
            if (!dobString) return null;

            let dob;
            if (dobString.seconds) {
                // Firestore Timestamp
                dob = new Date(dobString.seconds * 1000);
            } else if (typeof dobString === 'string') {
                dob = new Date(dobString);
            } else {
                dob = dobString;
            }

            const today = new Date();
            const months = (today.getFullYear() - dob.getFullYear()) * 12 + (today.getMonth() - dob.getMonth());
            return months;
        }

        // Motor Skills Questions by Age Group (WHO, CDC, MABC-2 Standards)
        const motorSkillsQuestions = {
            '2-3': {
                ageLabel: '2-3 Years',
                grossMotor: [
                    { id: 'walking', label: 'Independent Walking', description: 'Walks steadily without support' },
                    { id: 'running', label: 'Running', description: 'Runs without falling frequently' },
                    { id: 'kickingBall', label: 'Kicking Ball', description: 'Can kick a ball forward' },
                    { id: 'climbingStairs', label: 'Climbing Stairs', description: 'Climbs stairs with/without support' }
                ],
                fineMotor: [
                    { id: 'stackingBlocks', label: 'Stacking Blocks', description: 'Stacks 6+ blocks' },
                    { id: 'scribbling', label: 'Scribbling/Drawing', description: 'Scribbles with crayons' },
                    { id: 'usingUtensils', label: 'Using Spoon/Fork', description: 'Uses utensils to self-feed' }
                ],
                balance: [
                    { id: 'throwingBall', label: 'Throwing Overhand', description: 'Throws a ball overhand' },
                    { id: 'balance', label: 'Balance', description: 'Stands on one foot briefly' }
                ],
                strength: [
                    { id: 'stamina', label: 'Physical Stamina', description: 'Energy during play activities' }
                ]
            },
            '4-5': {
                ageLabel: '4-5 Years',
                grossMotor: [
                    { id: 'hopping', label: 'Hopping on One Foot', description: 'Hops on one foot 3+ times' },
                    { id: 'pedalingTricycle', label: 'Pedaling Tricycle', description: 'Pedals tricycle or bike with training wheels' },
                    { id: 'catchingBall', label: 'Catching Ball', description: 'Catches large ball with both hands' },
                    { id: 'climbing', label: 'Climbing', description: 'Climbs playground equipment confidently' }
                ],
                fineMotor: [
                    { id: 'drawingShapes', label: 'Drawing Shapes', description: 'Copies circles, squares, basic shapes' },
                    { id: 'cuttingScissors', label: 'Cutting with Scissors', description: 'Cuts paper along a line' },
                    { id: 'buttoningZipping', label: 'Buttoning/Zipping', description: 'Buttons buttons or zips zippers' }
                ],
                balance: [
                    { id: 'balancingOneFoot', label: 'Balancing', description: 'Balances on one foot for 5+ seconds' }
                ],
                strength: [
                    { id: 'stamina', label: 'Physical Stamina', description: 'Energy during physical activities' }
                ]
            },
            '6-8': {
                ageLabel: '6-8 Years',
                grossMotor: [
                    { id: 'skipping', label: 'Skipping', description: 'Skips smoothly and rhythmically' },
                    { id: 'jumpingRope', label: 'Jumping Rope', description: 'Jumps rope 5+ consecutive times' },
                    { id: 'ridingBicycle', label: 'Riding Bicycle', description: 'Rides bicycle without training wheels' },
                    { id: 'sportsSkills', label: 'Sports Skills', description: 'Coordination in sports (throwing, catching, kicking)' }
                ],
                fineMotor: [
                    { id: 'handwriting', label: 'Handwriting', description: 'Legible and neat handwriting' },
                    { id: 'tyingShoelaces', label: 'Tying Shoelaces', description: 'Ties shoelaces independently' },
                    { id: 'usingTools', label: 'Using Tools', description: 'Uses scissors, rulers, drawing tools precisely' }
                ],
                balance: [
                    { id: 'balanceBeam', label: 'Balance Beam', description: 'Walks on balance beam or narrow line' }
                ],
                strength: [
                    { id: 'endurance', label: 'Endurance', description: 'Stamina during sustained activity' }
                ]
            },
            '9-13': {
                ageLabel: '9-13 Years',
                grossMotor: [
                    { id: 'complexSports', label: 'Complex Sports Skills', description: 'Proficiency in organized sports' },
                    { id: 'reactionTime', label: 'Reaction Time', description: 'Quick reflexes and reactions' }
                ],
                fineMotor: [
                    { id: 'fineMotorPrecision', label: 'Fine Motor Precision', description: 'Precision in typing, playing instruments' }
                ],
                balance: [
                    { id: 'advancedCoordination', label: 'Advanced Coordination', description: 'Complex movement coordination' }
                ],
                strength: [
                    { id: 'endurance', label: 'Endurance', description: 'Stamina during sustained physical activity' },
                    { id: 'muscleTone', label: 'Muscle Tone', description: 'Overall muscle strength and tone' }
                ]
            }
        };

        function getAgeGroup(ageInMonths) {
            if (ageInMonths >= 24 && ageInMonths < 48) return '2-3';
            if (ageInMonths >= 48 && ageInMonths < 72) return '4-5';
            if (ageInMonths >= 72 && ageInMonths < 108) return '6-8';
            if (ageInMonths >= 108 && ageInMonths <= 156) return '9-13';
            return '4-5'; // Default to preschool if outside range
        }

        function populateMotorSkillsAssessment(dob, gender) {
            const ageInMonths = calculateAgeInMonths(dob);
            if (!ageInMonths) {
                document.getElementById('motorSkillsContainer').innerHTML =
                    '<div style="background: #fff3cd; padding: 20px; border-radius: 10px; color: #856404;"><i class="fa fa-exclamation-triangle"></i> Unable to determine child\'s age. Please ensure DOB is recorded.</div>';
                return;
            }

            const ageGroup = getAgeGroup(ageInMonths);
            const questions = motorSkillsQuestions[ageGroup];

            let html = `
                <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <strong style="color: #2e7d32;"><i class="fa fa-info-circle"></i> Age Group:</strong> ${questions.ageLabel} (${ageInMonths} months old)
                    <br>
                    <small style="color: #555;">Questions are customized based on child's developmental stage</small>
                </div>
            `;

            // Gross Motor Skills
            html += `
                <h4 style="color: #00c3c9; margin-top: 20px; margin-bottom: 15px;">
                    <i class="fa fa-child"></i> Gross Motor Skills
                </h4>
                <div class="row">
            `;
            questions.grossMotor.forEach(skill => {
                html += `
                    <div class="col-md-6 form-group">
                        <label for="motor-${skill.id}">${skill.label}</label>
                        <input type="range" class="form-control-range" id="motor-${skill.id}" name="motor-${skill.id}" min="0" max="10" value="0" oninput="document.getElementById('motor-${skill.id}-value').textContent = this.value == 0 ? '-' : this.value">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                            <small class="form-text text-muted">${skill.description}</small>
                            <span id="motor-${skill.id}-value" style="font-weight: bold; color: #00c3c9; font-size: 18px;">-</span>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;

            // Fine Motor Skills
            html += `
                <h4 style="color: #9b59b6; margin-top: 20px; margin-bottom: 15px;">
                    <i class="fa fa-hand-paper-o"></i> Fine Motor Skills
                </h4>
                <div class="row">
            `;
            questions.fineMotor.forEach(skill => {
                html += `
                    <div class="col-md-6 form-group">
                        <label for="motor-${skill.id}">${skill.label}</label>
                        <input type="range" class="form-control-range" id="motor-${skill.id}" name="motor-${skill.id}" min="0" max="10" value="0" oninput="document.getElementById('motor-${skill.id}-value').textContent = this.value == 0 ? '-' : this.value">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                            <small class="form-text text-muted">${skill.description}</small>
                            <span id="motor-${skill.id}-value" style="font-weight: bold; color: #9b59b6; font-size: 18px;">-</span>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;

            // Balance & Coordination
            html += `
                <h4 style="color: #e67e22; margin-top: 20px; margin-bottom: 15px;">
                    <i class="fa fa-balance-scale"></i> Balance & Coordination
                </h4>
                <div class="row">
            `;
            questions.balance.forEach(skill => {
                html += `
                    <div class="col-md-6 form-group">
                        <label for="motor-${skill.id}">${skill.label}</label>
                        <input type="range" class="form-control-range" id="motor-${skill.id}" name="motor-${skill.id}" min="0" max="10" value="0" oninput="document.getElementById('motor-${skill.id}-value').textContent = this.value == 0 ? '-' : this.value">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                            <small class="form-text text-muted">${skill.description}</small>
                            <span id="motor-${skill.id}-value" style="font-weight: bold; color: #e67e22; font-size: 18px;">-</span>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;

            // Strength & Endurance
            html += `
                <h4 style="color: #e74c3c; margin-top: 20px; margin-bottom: 15px;">
                    <i class="fa fa-heartbeat"></i> Strength & Endurance
                </h4>
                <div class="row">
            `;
            questions.strength.forEach(skill => {
                html += `
                    <div class="col-md-6 form-group">
                        <label for="motor-${skill.id}">${skill.label}</label>
                        <input type="range" class="form-control-range" id="motor-${skill.id}" name="motor-${skill.id}" min="0" max="10" value="0" oninput="document.getElementById('motor-${skill.id}-value').textContent = this.value == 0 ? '-' : this.value">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                            <small class="form-text text-muted">${skill.description}</small>
                            <span id="motor-${skill.id}-value" style="font-weight: bold; color: #e74c3c; font-size: 18px;">-</span>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;

            document.getElementById('motorSkillsContainer').innerHTML = html;
        }

        // Collect motor skills data from form
        function collectMotorSkillsData(form) {
            const motorSkillsInputs = form.querySelectorAll('input[name^="motor-"]');
            if (motorSkillsInputs.length === 0) {
                return null; // No motor skills data
            }

            const grossMotor = {};
            const fineMotor = {};
            const balance = {};
            const strength = {};

            motorSkillsInputs.forEach(input => {
                const skillId = input.name.replace('motor-', '');
                const value = parseInt(input.value);

                // Only include values > 0 (skip "not assessed" items)
                if (value === 0) return;

                // Categorize based on skill ID
                if (['walking', 'running', 'kickingBall', 'climbingStairs', 'hopping', 'pedalingTricycle',
                     'catchingBall', 'climbing', 'skipping', 'jumpingRope', 'ridingBicycle', 'sportsSkills',
                     'complexSports', 'reactionTime'].includes(skillId)) {
                    grossMotor[skillId] = value;
                } else if (['stackingBlocks', 'scribbling', 'usingUtensils', 'drawingShapes', 'cuttingScissors',
                           'buttoningZipping', 'handwriting', 'tyingShoelaces', 'usingTools', 'fineMotorPrecision'].includes(skillId)) {
                    fineMotor[skillId] = value;
                } else if (['throwingBall', 'balance', 'balancingOneFoot', 'balanceBeam', 'advancedCoordination'].includes(skillId)) {
                    balance[skillId] = value;
                } else if (['stamina', 'endurance', 'muscleTone'].includes(skillId)) {
                    strength[skillId] = value;
                }
            });

            // Calculate averages (only for assessed items with value > 0)
            const calcAverage = (obj) => {
                const values = Object.values(obj).filter(v => v > 0);
                return values.length > 0 ? (values.reduce((a, b) => a + b, 0) / values.length).toFixed(2) : 0;
            };

            const grossMotorAvg = parseFloat(calcAverage(grossMotor));
            const fineMotorAvg = parseFloat(calcAverage(fineMotor));
            const balanceAvg = parseFloat(calcAverage(balance));
            const strengthAvg = parseFloat(calcAverage(strength));

            // Calculate overall score only from assessed categories
            const assessedScores = [grossMotorAvg, fineMotorAvg, balanceAvg, strengthAvg].filter(score => score > 0);
            const overallScore = assessedScores.length > 0
                ? parseFloat((assessedScores.reduce((a, b) => a + b, 0) / assessedScores.length).toFixed(2))
                : 0;

            // Determine category and alert level
            let category, alertLevel;
            if (overallScore === 0) {
                category = 'Not Assessed';
                alertLevel = 'info';
            } else if (overallScore >= 9.0) {
                category = 'Excellent';
                alertLevel = 'excellent';
            } else if (overallScore >= 7.5) {
                category = 'Good';
                alertLevel = 'normal';
            } else if (overallScore >= 6.0) {
                category = 'Average';
                alertLevel = 'monitor';
            } else if (overallScore >= 4.0) {
                category = 'Below Average';
                alertLevel = 'warning';
            } else {
                category = 'Concern';
                alertLevel = 'critical';
            }

            return {
                grossMotor,
                fineMotor,
                balance,
                strength,
                grossMotorAvg,
                fineMotorAvg,
                balanceAvg,
                strengthAvg,
                overallScore,
                category,
                alertLevel,
                clinicalNotes: form['motor-skills-notes'].value || '',
                assessmentDate: new Date()
            };
        }


        // Generates Readable, UNIQUE ID using Name and Timestamp
        function generateConsultationId(patientName) {
            const nameSlug = slugifyName(patientName || 'patient');
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const milliseconds = String(now.getMilliseconds()).padStart(3, '0');

            // Format: PatientNameSlug-YYYYMMDD-HHMMSS-MMM (Easily readable and unique)
            return `${nameSlug}-${year}${month}${day}-${hours}${minutes}${seconds}-${milliseconds}`;
        }

        async function handleFormSubmission(e) {
            e.preventDefault();

            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            const consultationId = generateConsultationId(currentPatientName);
            const parentKey = createParentKey(currentParentName, currentParentId);

            // Collect form values
            const weight = parseFloat(form['weight'].value) || null;
            const height = parseFloat(form['height'].value) || null;
            const headCircumference = parseFloat(form['head-circumference'].value) || null;
            const waterIntake = parseFloat(form['water-intake'].value) || null;
            const sleepDuration = parseFloat(form['sleep-duration'].value) || null;
            const bedtime = form['bedtime'].value || null;
            const wakeTime = form['wake-time'].value || null;
            const sleepQuality = form['sleep-quality'].value || null;
            const subjective = form['subjective'].value || '';
            const objective = form['objective'].value || '';
            const assessment = form['assessment'].value || '';
            const plan = form['plan'].value || '';

            const consultationData = {
                // Consultation Metadata
                doctorId: currentDoctorId,
                doctorName: currentDoctorName,
                consultationDate: new Date(form['date-of-visit'].value),
                date: new Date(form['date-of-visit'].value),
                type: form['consultation-type'].value,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),

                // Physical Health (Grouped)
                physicalHealth: {
                    weight: weight,
                    height: height,
                    headCircumference: headCircumference,
                    temperature: form['temperature'].value || null,
                    symptomDuration: form['symptom-duration'].value || null,
                    clinicalNotes: form['vitals-notes'].value || ''
                },

                // Hydration (Grouped)
                hydration: {
                    waterIntake: waterIntake
                },

                // Sleep Health (Grouped)
                sleepHealth: {
                    sleepDuration: sleepDuration,
                    bedtime: bedtime,
                    wakeTime: wakeTime,
                    sleepQuality: sleepQuality
                },

                // Nutritional Health (Grouped)
                nutritionalHealth: {
                    // Physical Indicators
                    energyLevel: form['energy-level']?.value || null,
                    appetite: form['appetite']?.value || null,
                    skinHealth: form['skin-health']?.value || null,
                    hairQuality: form['hair-quality']?.value || null,
                    nailHealth: form['nail-health']?.value || null,

                    // Dietary Intake
                    mealsPerDay: parseFloat(form['meals-per-day']?.value) || null,
                    dietaryPattern: form['dietary-pattern']?.value || null,
                    breakfastRegularity: form['breakfast-regularity']?.value || null,
                    junkFoodFrequency: form['junk-food-frequency']?.value || null,

                    // Food Groups
                    fruitServings: parseFloat(form['fruit-servings']?.value) || null,
                    vegetableServings: parseFloat(form['vegetable-servings']?.value) || null,
                    dairyIntake: parseFloat(form['dairy-intake']?.value) || null,

                    // Supplements
                    supplements: Array.from(form.querySelectorAll('input[name="supplement"]:checked')).map(cb => cb.value),

                    // Clinical Notes
                    clinicalNotes: form['nutritional-notes']?.value || ''
                },

                // Motor Skills Coordination (Grouped)
                motorSkills: collectMotorSkillsData(form),

                // S.O.A.P. Notes (Grouped)
                soapNotes: {
                    subjective: subjective,
                    objective: objective,
                    assessment: assessment,
                    plan: plan
                },

                // Action/Follow-up (Grouped)
                followUp: {
                    prescriptionGiven: form['prescription-given'].checked,
                    followUpRequired: form['follow-up-required'].checked,
                    nextFollowUpDate: form['follow-up-required'].checked && form['next-follow-up-date'].value ? new Date(form['next-follow-up-date'].value) : null
                },

                // ===== BACKWARD COMPATIBILITY - Root level fields =====
                // These maintain compatibility with existing dashboard code
                weight: weight,
                height: height,
                headCircumference: headCircumference,
                waterIntake: waterIntake,
                temperature: form['temperature'].value || null,
                symptomDuration: form['symptom-duration'].value || null,
                vitalsNotes: form['vitals-notes'].value || '',
                sleepDuration: sleepDuration,
                bedtime: bedtime,
                wakeTime: wakeTime,
                sleepQuality: sleepQuality,
                subjective: subjective,
                objective: objective,
                assessment: assessment,
                plan: plan,
                prescriptionGiven: form['prescription-given'].checked,
                followUpRequired: form['follow-up-required'].checked,
                nextFollowUpDate: form['follow-up-required'].checked && form['next-follow-up-date'].value ? new Date(form['next-follow-up-date'].value) : null
            };

            try {
                // FIX: Save consultation notes to the deepest sub-collection
                await db.collection('patients').doc(parentKey)
                        .collection('children').doc(currentPatientId)
                        .collection('consultations').doc(consultationId)
                        .set(consultationData);

                alert(`Consultation notes saved successfully for ${currentPatientName}!`);
                window.location.href = `child_selection.html?parentId=${currentParentId}`;
            } catch (error) {
                console.error("Error saving consultation notes:", error);
                alert(`Error saving consultation notes: ${error.message}. Please try again.`);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Consultation Notes';
            }
        }

        function setupCancelButton() {
            const backLink = document.getElementById('cancel-back-link');
            if (backLink) {
                backLink.addEventListener('click', function(e) {
                    // Prevent default action initially
                    e.preventDefault(); 

                    window.location.href = backLink.href;
                });
            }
        }
    </script>

    <div id="animsition-box" class="animsition-box">
        <div class="header">
            <div class="container">
                <div class="row">
                    <div class="col-md-12">
                         <div class="logo"> <a href="../index.html"><img src="../images/logo.png" alt="Logo"></a> </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container portal-container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="section-title">
                        <h1 class="form-title">New Consultation Notes</h1>
                        <div class="patient-info">
                            <strong>Patient Name:</strong> <span id="patient-name-display">Loading...</span> 
                            | <strong>ID:</strong> <span id="patient-id-display">Loading...</span>
                            | <strong>Age:</strong> <span id="patient-age-display">Loading...</span>
                        </div>
                        <div class="patient-info">
                            <strong>Parent:</strong> <span id="parent-name-display">Loading...</span>
                        </div>
                    </div>

                    <form id="consultation-form">
                        <div class="row">
                            <div class="col-md-4 form-group">
                                <label for="date-of-visit">Date of Visit</label>
                                <input type="date" class="form-control" id="date-of-visit" required>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="consultation-type">Consultation Type</label>
                                <select class="form-control" id="consultation-type" required>
                                    <option value="">Select consultation type...</option>
                                    <option value="Initial">Initial Visit</option>
                                    <option value="Follow-up">Follow-up</option>
                                    <option value="Emergency">Emergency</option>
                                    <option value="Routine Checkup">Routine Checkup</option>
                                </select>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="symptom-duration">Symptom Duration</label>
                                <input type="text" class="form-control" id="symptom-duration" placeholder="e.g., 3 days, 1 week">
                            </div>
                        </div>
                        
                        <!-- ==================== PHYSICAL DEVELOPMENT SECTION ==================== -->
                        <div class="section-separator">
                            <h3 style="color: #00c3c9;">
                                <i class="fa fa-child"></i> Physical Development
                            </h3>
                            <p style="color: #7f8c8d; font-size: 13px; margin-top: 10px;">
                                Growth measurements, vital signs, and physical examination findings
                                <br>
                                <strong>Standards:</strong> WHO Child Growth Standards, CDC Growth Charts
                            </p>
                        </div>

                        <!-- Growth Measurements -->
                        <div style="background: #e0f7fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #00c3c9;">
                            <h4 style="margin-top: 0; color: #00c3c9; font-size: 16px; font-weight: bold;">
                                <i class="fa fa-line-chart"></i> Growth Measurements
                            </h4>
                            <p style="color: #7f8c8d; font-size: 12px; margin-bottom: 15px;">
                                Primary anthropometric measurements for growth tracking
                            </p>

                            <div class="row">
                                <div class="col-md-3 form-group">
                                    <label for="weight">Weight (kg)</label>
                                    <input type="number" step="0.1" class="form-control" id="weight">
                                </div>
                                <div class="col-md-3 form-group">
                                    <label for="height">Height (cm)</label>
                                    <input type="number" step="0.1" class="form-control" id="height">
                                </div>
                                <div class="col-md-3 form-group">
                                    <label for="head-circumference">Head Circumference (cm)</label>
                                    <input type="number" step="0.1" class="form-control" id="head-circumference">
                                </div>
                                <div class="col-md-3 form-group">
                                    <label for="temperature">Temperature (Â°C)</label>
                                    <input type="text" class="form-control" id="temperature" placeholder="e.g., 37.5, Normal">
                                </div>
                            </div>
                        </div>

                        <!-- Physical Examination Notes -->
                        <div class="form-group">
                            <label for="vitals-notes">Physical Examination Notes</label>
                            <textarea class="form-control" id="vitals-notes" rows="3" placeholder="Physical findings, reflexes, posture, coordination observations..."></textarea>
                        </div>

                        <!-- ==================== MOTOR SKILLS (Under Physical Development) ==================== -->
                        <div style="background: #fff3e0; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #FF9800; margin-top: 20px;">
                            <h4 style="margin-top: 0; color: #FF9800; font-size: 16px; font-weight: bold;">
                                <i class="fa fa-bolt"></i> Motor Skills Coordination
                            </h4>
                            <p style="color: #7f8c8d; font-size: 12px; margin-bottom: 15px;">
                                Rate each motor skill on a scale of 0-10 (0 = Not Assessed, 1-10 = Performance Level)
                                <br>
                                Age-appropriate questions will auto-populate based on child's age
                                <br>
                                <strong>Standards:</strong> WHO Motor Development Milestones, CDC Developmental Milestones, MABC-2
                            </p>

                            <!-- Motor Skills will be dynamically populated based on age -->
                            <div id="motorSkillsContainer">
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; color: #95a5a6;">
                                    <i class="fa fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                    <p style="margin: 0;">Loading age-appropriate motor skills assessment...</p>
                                </div>
                            </div>

                            <div style="margin-top: 20px;">
                                <label for="motor-skills-notes">Clinical Notes (Motor Skills)</label>
                                <textarea class="form-control" id="motor-skills-notes" rows="3" placeholder="Additional observations about motor development, concerns, or recommendations..."></textarea>
                            </div>
                        </div>

                        <!-- ==================== NUTRITIONAL HEALTH SECTION ==================== -->
                        <div class="section-separator">
                            <h3 style="color: #27ae60;">
                                <i class="fa fa-heart"></i> Nutritional Health
                            </h3>
                            <p style="color: #7f8c8d; font-size: 13px; margin-top: 10px;">
                                Dietary habits, hydration status, and nutritional clinical indicators
                                <br>
                                <strong>Standards:</strong> WHO Nutrient Intake Guidelines, ICMR RDA, Dietary Reference Intakes
                            </p>
                        </div>

                        <!-- Hydration Status -->
                        <div style="background: #e0f7fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #00ACC1;">
                            <h4 style="margin-top: 0; color: #00ACC1; font-size: 16px; font-weight: bold;">
                                <i class="fa fa-tint"></i> Hydration Status
                            </h4>
                            <p style="color: #7f8c8d; font-size: 12px; margin-bottom: 15px;">
                                Daily water and fluid intake assessment
                            </p>

                            <div class="row">
                                <div class="col-md-6 form-group">
                                    <label for="water-intake">Daily Water Intake (ml)</label>
                                    <input type="number" step="50" class="form-control" id="water-intake" placeholder="e.g., 1200">
                                    <small class="form-text text-muted">Reference: 1 small glass = 200ml, 1 regular glass = 250ml, 1 large glass = 300ml</small>
                                </div>
                            </div>
                        </div>

                        <!-- Sleep & Rest -->
                        <div style="background: #e8eaf6; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #5C6BC0;">
                            <h4 style="margin-top: 0; color: #5C6BC0; font-size: 16px; font-weight: bold;">
                                <i class="fa fa-moon-o"></i> Sleep & Rest
                            </h4>
                            <p style="color: #7f8c8d; font-size: 12px; margin-bottom: 15px;">
                                Based on American Academy of Sleep Medicine (AASM) guidelines
                            </p>

                        <div class="row">
                            <div class="col-md-4 form-group">
                                <label for="sleep-duration">Total Sleep Duration (hours per day)</label>
                                <input type="number" step="0.5" class="form-control" id="sleep-duration" placeholder="e.g., 10.5">
                                <small class="form-text text-muted">Include nighttime sleep + daytime naps</small>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="bedtime">Typical Bedtime</label>
                                <input type="time" class="form-control" id="bedtime">
                                <small class="form-text text-muted">Usual time child goes to bed</small>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="wake-time">Typical Wake Time</label>
                                <input type="time" class="form-control" id="wake-time">
                                <small class="form-text text-muted">Usual time child wakes up</small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 form-group">
                                <label for="sleep-quality">Sleep Quality</label>
                                <select class="form-control" id="sleep-quality">
                                    <option value="">Select sleep quality...</option>
                                    <option value="Excellent">Excellent - Sleeps through night, no disturbances</option>
                                    <option value="Good">Good - Occasional wake-ups (1-2 times)</option>
                                    <option value="Fair">Fair - Frequent wake-ups (3-5 times)</option>
                                    <option value="Poor">Poor - Very restless, wakes up many times</option>
                                </select>
                            </div>
                        </div>
                        </div>

                        <!-- Nutritional Clinical Observations -->
                        <div style="background: #f0f8ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
                            <h4 style="margin-top: 0; color: #2196F3; font-size: 16px; font-weight: bold;">
                                <i class="fa fa-stethoscope"></i> Nutritional Clinical Observations
                            </h4>
                            <p style="color: #7f8c8d; font-size: 12px; margin-bottom: 15px;">
                                Physical signs related to nutritional health during examination
                            </p>

                            <div class="row">
                                <div class="col-md-4 form-group">
                                    <label for="energy-level">Energy Level</label>
                                    <select class="form-control" id="energy-level">
                                        <option value="">Select energy level...</option>
                                        <option value="low">Low - Lethargic, tired</option>
                                        <option value="normal">Normal - Age-appropriate</option>
                                        <option value="high">High - Very active, energetic</option>
                                    </select>
                                </div>
                                <div class="col-md-4 form-group">
                                    <label for="appetite">Appetite</label>
                                    <select class="form-control" id="appetite">
                                        <option value="">Select appetite level...</option>
                                        <option value="poor">Poor - Eats very little</option>
                                        <option value="normal">Normal - Adequate intake</option>
                                        <option value="good">Good - Healthy appetite</option>
                                    </select>
                                </div>
                                <div class="col-md-4 form-group">
                                    <label for="skin-health">Skin Health</label>
                                    <select class="form-control" id="skin-health">
                                        <option value="">Select skin health...</option>
                                        <option value="dry">Dry/Rough skin</option>
                                        <option value="normal">Normal skin</option>
                                        <option value="healthy">Healthy glow</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 form-group">
                                    <label for="hair-quality">Hair Quality</label>
                                    <select class="form-control" id="hair-quality">
                                        <option value="">Select hair quality...</option>
                                        <option value="brittle">Brittle/Dry hair</option>
                                        <option value="normal">Normal hair</option>
                                        <option value="healthy">Healthy/Lustrous hair</option>
                                    </select>
                                </div>
                                <div class="col-md-4 form-group">
                                    <label for="nail-health">Nail Health</label>
                                    <select class="form-control" id="nail-health">
                                        <option value="">Select nail health...</option>
                                        <option value="brittle">Brittle/Weak nails</option>
                                        <option value="normal">Normal nails</option>
                                        <option value="strong">Strong/Healthy nails</option>
                                    </select>
                                </div>
                                <div class="col-md-4 form-group">
                                    <label for="pallor">Pallor (Anemia Signs)</label>
                                    <div style="margin-top: 8px;">
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" id="pallor"> Pallor detected (pale conjunctiva/palms)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Dietary Information Subsection -->
                        <div style="background: #fff8e1; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #FFC107;">
                            <h4 style="margin-top: 0; color: #F57C00; font-size: 16px; font-weight: bold;">
                                <i class="fa fa-cutlery"></i> Dietary Information (Ask Parent/Guardian)
                            </h4>
                            <p style="color: #7f8c8d; font-size: 12px; margin-bottom: 15px;">
                                Quick verbal questions about child's typical eating patterns
                            </p>

                            <div class="row">
                                <div class="col-md-3 form-group">
                                    <label for="meals-per-day">Meals Per Day</label>
                                    <input type="number" class="form-control" id="meals-per-day" min="1" max="8" placeholder="e.g., 3">
                                    <small class="form-text text-muted">Main meals + snacks</small>
                                </div>
                                <div class="col-md-3 form-group">
                                    <label for="dietary-pattern">Dietary Pattern</label>
                                    <select class="form-control" id="dietary-pattern">
                                        <option value="">Select dietary pattern...</option>
                                        <option value="vegetarian">Vegetarian (with dairy/eggs)</option>
                                        <option value="non-vegetarian">Non-Vegetarian/Mixed</option>
                                        <option value="vegan">Vegan (plant-based only)</option>
                                        <option value="eggetarian">Eggetarian (eggs + veg)</option>
                                    </select>
                                </div>
                                <div class="col-md-3 form-group">
                                    <label for="breakfast-regularity">Breakfast Regularity</label>
                                    <select class="form-control" id="breakfast-regularity">
                                        <option value="">Select frequency...</option>
                                        <option value="daily">Daily</option>
                                        <option value="sometimes">Sometimes (3-4x/week)</option>
                                        <option value="rarely">Rarely (0-2x/week)</option>
                                    </select>
                                </div>
                                <div class="col-md-3 form-group">
                                    <label for="junk-food-frequency">Junk Food (per week)</label>
                                    <select class="form-control" id="junk-food-frequency">
                                        <option value="">Select frequency...</option>
                                        <option value="never">Never/Very Rare</option>
                                        <option value="1-2">1-2 times</option>
                                        <option value="3-4">3-4 times</option>
                                        <option value="5+">5+ times</option>
                                    </select>
                                    <small class="form-text text-muted">Chips, sodas, fast food</small>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 form-group">
                                    <label for="fruit-servings">Fruit Servings (per day)</label>
                                    <input type="number" class="form-control" id="fruit-servings" min="0" max="6" step="0.5" placeholder="e.g., 1">
                                    <small class="form-text text-muted">Fresh fruits</small>
                                </div>
                                <div class="col-md-4 form-group">
                                    <label for="vegetable-servings">Vegetable Servings (per day)</label>
                                    <input type="number" class="form-control" id="vegetable-servings" min="0" max="6" step="0.5" placeholder="e.g., 2">
                                    <small class="form-text text-muted">All vegetables</small>
                                </div>
                                <div class="col-md-4 form-group">
                                    <label for="dairy-intake">Milk/Dairy Intake (ml/day)</label>
                                    <input type="number" class="form-control" id="dairy-intake" min="0" max="1000" step="50" placeholder="e.g., 250">
                                    <small class="form-text text-muted">Milk, curd, paneer</small>
                                </div>
                            </div>
                        </div>

                        <!-- Supplements Subsection -->
                        <div style="background: #f3e5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #9C27B0;">
                            <h4 style="margin-top: 0; color: #9C27B0; font-size: 16px; font-weight: bold;">
                                <i class="fa fa-medkit"></i> Nutritional Supplements
                            </h4>
                            <p style="color: #7f8c8d; font-size: 12px; margin-bottom: 15px;">
                                Check all supplements currently being taken by the child
                            </p>

                            <div class="row">
                                <div class="col-md-12">
                                    <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" name="supplement" value="none" id="supplement-none"> None
                                            </label>
                                        </div>
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" name="supplement" value="multivitamin"> Multivitamin
                                            </label>
                                        </div>
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" name="supplement" value="iron"> Iron
                                            </label>
                                        </div>
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" name="supplement" value="calcium"> Calcium
                                            </label>
                                        </div>
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" name="supplement" value="vitaminD"> Vitamin D
                                            </label>
                                        </div>
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" name="supplement" value="omega3"> Omega-3
                                            </label>
                                        </div>
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" name="supplement" value="zinc"> Zinc
                                            </label>
                                        </div>
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" name="supplement" value="other"> Other
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Nutritional Assessment Notes -->
                        <div class="form-group">
                            <label for="nutritional-notes">Clinical Notes (Nutritional Health)</label>
                            <textarea class="form-control" id="nutritional-notes" rows="3" placeholder="Any dietary concerns, food allergies, feeding difficulties, specific nutritional recommendations, or follow-up actions..."></textarea>
                        </div>

                        <!-- ==================== COGNITIVE DEVELOPMENT SECTION (Coming Soon) ==================== -->
                        <div class="section-separator">
                            <h3 style="color: #9b59b6;">
                                <i class="fa fa-graduation-cap"></i> Cognitive Development <span style="font-size: 14px; color: #95a5a6; font-weight: normal;">(Coming Soon)</span>
                            </h3>
                            <p style="color: #7f8c8d; font-size: 13px; margin-top: 10px;">
                                Future features will include assessment of learning abilities, memory, attention span, and problem-solving skills
                            </p>
                        </div>

                        <!-- ==================== CREATIVE DEVELOPMENT SECTION (Coming Soon) ==================== -->
                        <div class="section-separator">
                            <h3 style="color: #e67e22;">
                                <i class="fa fa-paint-brush"></i> Creative Development <span style="font-size: 14px; color: #95a5a6; font-weight: normal;">(Coming Soon)</span>
                            </h3>
                            <p style="color: #7f8c8d; font-size: 13px; margin-top: 10px;">
                                Future features will track artistic expression, imagination, and creative problem-solving abilities
                            </p>
                        </div>

                        <!-- ==================== PERSONALITY & CHARACTER SECTION (Coming Soon) ==================== -->
                        <div class="section-separator">
                            <h3 style="color: #e74c3c;">
                                <i class="fa fa-user"></i> Personality & Character <span style="font-size: 14px; color: #95a5a6; font-weight: normal;">(Coming Soon)</span>
                            </h3>
                            <p style="color: #7f8c8d; font-size: 13px; margin-top: 10px;">
                                Future features will assess social skills, emotional intelligence, behavioral patterns, and character development
                            </p>
                        </div>

                        <div class="section-separator">
                            <h3>S.O.A.P. Notes</h3>
                        </div>
                        
                        <div class="form-group">
                            <label for="subjective">S. Subjective (Chief Complaint & History)</label>
                            <textarea class="form-control" id="subjective" rows="5" required placeholder="Patient's reported symptoms, onset, duration, and relevant history."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="objective">O. Objective (Physical Exam / Vitals Findings)</label>
                            <textarea class="form-control" id="objective" rows="5" placeholder="Doctor's findings from examination."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="assessment">A. Assessment / Diagnosis</label>
                            <textarea class="form-control" id="assessment" rows="5" required placeholder="Final diagnosis or differential diagnosis."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="plan">P. Plan / Treatment</label>
                            <textarea class="form-control" id="plan" rows="5" required placeholder="Treatment plan, medication, advice, and discharge instructions."></textarea>
                        </div>

                        <div class="section-separator">
                            <h3>Action & Follow-up</h3>
                        </div>

                        <div class="row">
                            <div class="col-md-4 form-group">
                                <div class="checkbox">
                                    <label>
                                        <input type="checkbox" id="prescription-given"> Prescription Given
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4 form-group">
                                <div class="checkbox">
                                    <label>
                                        <input type="checkbox" id="follow-up-required"> Follow-up Required
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4 form-group">
                                <label for="next-follow-up-date">Next Follow-up Date</label>
                                <input type="date" class="form-control" id="next-follow-up-date">
                            </div>
                        </div>

                        <div class="form-group text-center">
                            <button type="submit" class="btn btn-primary btn-lg">Save Consultation Notes</button>
                            <a id="cancel-back-link" href="#" class="btn btn-default btn-lg animsition-link">Cancel / Back to Child List</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="tiny-footer">
            <div class="container">
                <p>Doctor Portal Access</p>
            </div>
        </div>

    </div>

    <script src="../js/jquery.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../js/animsition.js"></script>
    <script type="text/javascript" src="../js/animsition-script.js"></script>
</body>
</html>